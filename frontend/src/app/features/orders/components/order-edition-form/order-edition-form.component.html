<form
  [formGroup]="orderForm"
  (ngSubmit)="onSubmit()"
  class="order-creation-form"
>
  <mat-checkbox
    formControlName="isExpress"
    color="primary"
    class="standard-checkbox"
    (click)="getCheckboxValue()"
  >
    Express
  </mat-checkbox>

  <mat-form-field appearance="outline" class="full-width driver-search-field">
    <mat-label>Buscar y Seleccionar empresa</mat-label>
    <input
      type="text"
      placeholder="Escriba el nombre del la empresa..."
      aria-label="cliente"
      matInput
      [formControl]="companySearchCtrl"
      [matAutocomplete]="autoDriver"
    />
    <button
      *ngIf="companySearchCtrl.value && !isLoadingCompanies"
      matSuffix
      mat-icon-button
      aria-label="Limpiar"
      (click)="clearDriverSelection()"
    >
      <mat-icon>close</mat-icon>
    </button>
    <mat-icon matSuffix *ngIf="!companySearchCtrl.value && !isLoadingCompanies"
      >person_search</mat-icon
    >
    <mat-progress-spinner
      *ngIf="isLoadingCompanies"
      matSuffix
      mode="indeterminate"
      diameter="20"
    ></mat-progress-spinner>

    <mat-autocomplete
      #autoDriver="matAutocomplete"
      [displayWith]="displayDriverName"
      (optionSelected)="onDriverSelected($event)"
    >
      @for (driver of filteredCompanies$ | async; track driver.id) {
      <mat-option [value]="driver">
        <div class="driver-option">
          <span>{{ driver.username }}</span>
        </div>
      </mat-option>
      } @if ((filteredCompanies$ | async)?.length === 0 && !isLoadingCompanies
      && companySearchCtrl.value) {
      <mat-option disabled>No se encontraron motorizados.</mat-option>
      }
    </mat-autocomplete>

    <mat-error *ngIf="orderForm.get('company_id')?.hasError('required')"
      >Requerido</mat-error
    >
  </mat-form-field>

  <div class="form-grid">
    <mat-form-field appearance="outline">
      <mat-label>Nombre del destinatario</mat-label>
      <input
        matInput
        formControlName="recipient_name"
        placeholder="Nombre completo"
      />
      <mat-icon matSuffix>person_outline</mat-icon>
      <mat-error *ngIf="orderForm.get('recipient_name')?.hasError('required')"
        >Requerido</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Tel칠fono del destinatario</mat-label>
      <input
        matInput
        formControlName="recipient_phone"
        type="tel"
        placeholder=""
      />
      <mat-icon matSuffix>phone_outline</mat-icon>
      <mat-hint align="end">No se debe agregar el +51</mat-hint>
      <mat-error *ngIf="orderForm.get('recipient_phone')?.hasError('required')"
        >Requerido</mat-error
      >
      <mat-error *ngIf="orderForm.get('recipient_phone')?.hasError('pattern')"
        >Tel칠fono inv치lido</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline" class="driver-search-field">
      <mat-label>Buscar y Seleccionar distrito</mat-label>
      <input
        type="text"
        placeholder="Escriba el nombre del distrito..."
        aria-label="distrito"
        matInput
        [formControl]="districSearchCtrl"
        [matAutocomplete]="autoDistric"
      />
      <button
        *ngIf="districSearchCtrl.value && !isLoadingDistricts"
        matSuffix
        mat-icon-button
        aria-label="Limpiar"
        (click)="clearDistrictSelection()"
      >
        <mat-icon>close</mat-icon>
      </button>
      <mat-icon
        matSuffix
        *ngIf="!districSearchCtrl.value && !isLoadingDistricts"
        >person_search</mat-icon
      >
      <mat-progress-spinner
        *ngIf="isLoadingDistricts"
        matSuffix
        mode="indeterminate"
        diameter="20"
      ></mat-progress-spinner>

      <mat-autocomplete
        #autoDistric="matAutocomplete"
        [displayWith]="displayDistricName"
        (optionSelected)="onDistrictSelected($event)"
      >
        @for (district of filteredDistricts$ | async; track district.id) {
        <mat-option [value]="district">
          <div class="driver-option">
            <span>{{ district.name_and_price }}</span>
          </div>
        </mat-option>
        } @if ((filteredDistricts$ | async)?.length === 0 && !isLoadingDistricts
        && districSearchCtrl.value) {
        <mat-option disabled>No se encontraron distritos.</mat-option>
        }
      </mat-autocomplete>

      <mat-error
        *ngIf="orderForm.get('delivery_district_id')?.hasError('required')"
        >Requerido</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-span-column">
      <mat-label>Direcci칩n de entrega</mat-label>
      <input
        matInput
        formControlName="delivery_address"
        placeholder="Ingresar lugar de entrega (M칤nimo 6 caracteres)"
      />

      <mat-error *ngIf="orderForm.get('delivery_address')?.hasError('required')"
        >Requerido</mat-error
      >
      <mat-error
        *ngIf="orderForm.get('delivery_address')?.hasError('minlength')"
        >M칤nimo 6 caracteres</mat-error
      >
    </mat-form-field>
  </div>

  <mat-divider class="section-divider"></mat-divider>

  <!-- <app-package-calculator
    [packageFormGroup]="packageDetailsFormGroup"
    [districtsCache]="districtsCache"
    [deliveryDistrictId]="orderForm.get('delivery_district_id')?.value"
    (shippingCostCalculated)="onShippingCostCalculated($event)"
    (calculationLoading)="onPackageCalculationLoading($event)"
  >
  </app-package-calculator> -->

  <!-- ======================================================= -->
  <!-- === SECCI칍N PARA A칌ADIR PAQUETES === -->
  <!-- ======================================================= -->

  <h3 class="section-subtitle">Tama침o del paquete</h3>

  <div [formGroup]="newItemForm">
    <mat-radio-group
      formControlName="package_type"
      aria-label="Tipo de paquete"
    >
      <mat-radio-button value="STANDARD"
        >Est치ndar (1 solo paquete)</mat-radio-button
      >
      <mat-radio-button value="CUSTOM"
        >Otros tama침os (M칰ltiples paquetes)</mat-radio-button
      >
    </mat-radio-group>
  </div>
  <div
    id="standard-package-info"
    class="info-box hidden"
    *ngIf="newItemForm.get('package_type')?.value === 'STANDARD'"
  >
    <div class="info-content">
      <span class="info-icon">游닍</span>
      <div class="info-text">
        <strong>Paquete Est치ndar seleccionado</strong>
        <div>{{ this.standardPackageLabel() }}</div>
      </div>
    </div>
  </div>
  <div
    class="warning-paquete-size"
    *ngIf="newItemForm.get('package_type')?.value === 'STANDARD'"
  >
    <p>
      Si su paquete excede las medidas y pesos est치ndar y no utiliza la
      calculadora de env칤o, se le cobrar치 en funci칩n de esas medidas sin previo
      aviso.
    </p>
  </div>
  <div class="max-dimensions-info">
    <p>{{ this.maxDimensionsInfo() }}</p>
  </div>
  <div *ngIf="newItemForm.get('package_type')?.value === 'CUSTOM'">
    <div [formGroup]="newItemForm" class="package-calculator-container">
      <h3 class="section-subtitle">A침adir Paquete a la Lista</h3>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Descripci칩n del Bulto</mat-label>
        <input
          matInput
          formControlName="description"
          placeholder="Ej: Zapatos, Laptop..."
          appAutoSelect
        />
        <mat-error *ngIf="newItemForm.get('description')?.hasError('required')"
          >Requerido</mat-error
        >
      </mat-form-field>

      <div class="custom-dimensions-grid">
        <mat-form-field appearance="outline">
          <mat-label>Largo (cm)</mat-label>
          <input
            matInput
            type="number"
            formControlName="length_cm"
            appAutoSelect
          />
          <mat-error *ngIf="newItemForm.get('length_cm')?.hasError('required')"
            >Requerido</mat-error
          >
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Ancho (cm)</mat-label>
          <input
            matInput
            type="number"
            formControlName="width_cm"
            appAutoSelect
          />
          <mat-error *ngIf="newItemForm.get('width_cm')?.hasError('required')"
            >Requerido</mat-error
          >
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Alto (cm)</mat-label>
          <input
            matInput
            type="number"
            formControlName="height_cm"
            appAutoSelect
          />
          <mat-error *ngIf="newItemForm.get('height_cm')?.hasError('required')"
            >Requerido</mat-error
          >
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Peso (kg)</mat-label>
          <input
            matInput
            type="number"
            formControlName="weight_kg"
            appAutoSelect
          />
          <mat-error *ngIf="newItemForm.get('weight_kg')?.hasError('required')"
            >Requerido</mat-error
          >
        </mat-form-field>
      </div>

      <div class="add-item-button-container">
        <button
          mat-flat-button
          type="button"
          class="btn-corp-primary"
          (click)="addItemToList()"
        >
          <mat-icon>add</mat-icon>
          Agregar Paquete a la Lista
        </button>
      </div>
      <div
        class="shipping-cost-display-package"
        *ngIf="newItemForm.get('package_type')?.value === 'CUSTOM'"
      >
        Costo de env칤o del paquete =
        <span class="cost-value"
          >S/ {{ shippingCostPackage() | number : "1.2-2" }}</span
        >
      </div>
    </div>

    <div
      *ngIf="itemsFormArray.controls.length > 0"
      class="package-list-container"
    >
      <h3 class="section-subtitle">Desglose de Paquetes</h3>
      <mat-form-field appearance="outline" class="discount-field">
        <mat-label>% Descuento Adicional</mat-label>
        <input
          matInput
          type="number"
          [value]="multiPackageDiscountPercentage()"
          (input)="
            multiPackageDiscountPercentage.set(+$any($event.target).value)
          "
          [disabled]="!this.hasPermissionToEditPercentage()"
        />
        <mat-icon matSuffix>percent</mat-icon>
      </mat-form-field>

      <table
        mat-table
        [dataSource]="itemsDataSource"
        class="mat-elevation-z2 items-table"
      >
        <!-- Columna Descripci칩n -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Descripci칩n</th>
          <td mat-cell *matCellDef="let element">
            {{ element.value.description }}
          </td>
        </ng-container>

        <!-- Columna Medidas -->
        <ng-container matColumnDef="medidas">
          <th mat-header-cell *matHeaderCellDef>Medidas</th>
          <td mat-cell *matCellDef="let element">
            {{ element.value.length_cm }}x{{ element.value.width_cm }}x{{
              element.value.height_cm
            }}cm <br />
            <small>{{ element.value.weight_kg }}kg</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="basePrice">
          <th mat-header-cell *matHeaderCellDef>Precio Base</th>
          <td mat-cell *matCellDef="let element">
            {{ element.value.basePrice | currency : "S/ " }}
          </td>
        </ng-container>

        <ng-container matColumnDef="tipo">
          <th mat-header-cell *matHeaderCellDef>Tipo</th>
          <td mat-cell *matCellDef="let element">
            <span
              [ngClass]="{
                'principal-item': element.value.isPrincipal,
                'additional-item': !element.value.isPrincipal
              }"
            >
              {{ element.value.isPrincipal ? "Principal" : "Adicional" }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="finalPrice">
          <th mat-header-cell *matHeaderCellDef>Precio Final</th>
          <td mat-cell *matCellDef="let element">
            <!-- Si el item NO es principal y tiene descuento, muestra el precio tachado -->
            <div
              *ngIf="
                !element.value.isPrincipal &&
                element.value.finalPrice < element.value.basePrice
              "
              class="discounted-price"
            >
              <span class="original-price">{{
                element.value.basePrice | currency : "S/ "
              }}</span>
              <span class="final-price">{{
                element.value.finalPrice | currency : "S/ "
              }}</span>
            </div>

            <!-- Si es principal o no tiene descuento, muestra el precio normal -->
            <div
              *ngIf="
                element.value.isPrincipal ||
                element.value.finalPrice >= element.value.basePrice
              "
            >
              {{ element.value.finalPrice | currency : "S/ " }}
            </div>
          </td>
        </ng-container>

        <!-- Columna Eliminar -->
        <ng-container matColumnDef="eliminar">
          <th mat-header-cell *matHeaderCellDef>Eliminar</th>
          <td mat-cell *matCellDef="let element; let i = index">
            <button
              mat-icon-button
              color="warn"
              type="button"
              (click)="removeItem(i)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="itemsDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: itemsDisplayedColumns"></tr>
      </table>
    </div>
  </div>

  <div class="shipping-cost-display">
    Costo de env칤o =
    <span class="cost-value"
      >S/ {{ orderForm.get("shipping_cost")?.value | number : "1.2-2" }}</span
    >
    <mat-progress-spinner
      *ngIf="isCalculatingShipping()"
      mode="indeterminate"
      diameter="20"
      class="cost-spinner"
    ></mat-progress-spinner>
  </div>

  <mat-divider class="section-divider"></mat-divider>

  <!-- Secci칩n 3: Detalles del Env칤o y Pago -->
  <div class="form-grid">
    <mat-form-field appearance="outline" class="full-span-column">
      <mat-label>쯈u칠 env칤a?</mat-label>
      <input
        matInput
        formControlName="item_description"
        placeholder="Detalle del pedido"
      />
      <mat-icon matSuffix>inventory_2_outline</mat-icon>
      <mat-error *ngIf="orderForm.get('item_description')?.hasError('required')"
        >Requerido</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-span-column">
      <mat-label>Observaciones (Opcional)</mat-label>
      <textarea
        matInput
        formControlName="observations"
        placeholder="쯈u칠 env칤as?..."
        rows="3"
      ></textarea>
    </mat-form-field>

    <mat-form-field
      appearance="outline"
      class="full-span-column"
      *ngIf="orderForm.get('observation_shipping_cost_modification')?.enabled"
    >
      <mat-label>Observaci칩n de modificaci칩n de costo de env칤o</mat-label>
      <textarea
        matInput
        formControlName="observation_shipping_cost_modification"
        placeholder="Ingrese la raz칩n de la modificaci칩n del costo de env칤o"
        rows="3"
      ></textarea>
      <mat-error
        *ngIf="
          orderForm
            .get('observation_shipping_cost_modification')
            ?.hasError('required')
        "
        >Requerido</mat-error
      >
    </mat-form-field>
  </div>
</form>
