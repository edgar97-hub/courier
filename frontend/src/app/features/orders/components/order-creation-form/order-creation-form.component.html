<form
  [formGroup]="orderForm"
  (ngSubmit)="onSubmit()"
  class="order-creation-form"
>
  <h2 class="form-section-title">Registrar pedido</h2>

  <mat-checkbox
    formControlName="isExpress"
    color="primary"
    class="standard-checkbox"
    (click)="getCheckboxValue()"
  >
    Express
  </mat-checkbox>

  <mat-form-field
    appearance="outline"
    class="full-width driver-search-field"
    *ngIf="!isCompany()"
  >
    <mat-label>Buscar y Seleccionar empresa</mat-label>
    <input
      type="text"
      placeholder="Escriba el nombre del la empresa..."
      aria-label="cliente"
      matInput
      [formControl]="driverSearchCtrl"
      [matAutocomplete]="autoDriver"
    />
    <button
      *ngIf="driverSearchCtrl.value && !isLoadingDrivers"
      matSuffix
      mat-icon-button
      aria-label="Limpiar"
      (click)="clearDriverSelection()"
    >
      <mat-icon>close</mat-icon>
    </button>
    <mat-icon matSuffix *ngIf="!driverSearchCtrl.value && !isLoadingDrivers"
      >person_search</mat-icon
    >
    <mat-progress-spinner
      *ngIf="isLoadingDrivers"
      matSuffix
      mode="indeterminate"
      diameter="20"
    ></mat-progress-spinner>

    <mat-autocomplete
      #autoDriver="matAutocomplete"
      [displayWith]="displayDriverName"
      (optionSelected)="onDriverSelected($event)"
    >
      @for (driver of filteredDrivers$ | async; track driver.id) {
      <mat-option [value]="driver">
        <div class="driver-option">
          <span>{{ driver.username }}</span>
        </div>
      </mat-option>
      } @if ((filteredDrivers$ | async)?.length === 0 && !isLoadingDrivers &&
      driverSearchCtrl.value) {
      <mat-option disabled>No se encontraron motorizados.</mat-option>
      }
    </mat-autocomplete>

    <mat-error *ngIf="orderForm.get('company_id')?.hasError('required')"
      >Requerido</mat-error
    >
  </mat-form-field>
  <div class="form-grid">
    <mat-form-field appearance="outline">
      <mat-label>Tipo de env√≠o</mat-label>
      <mat-select formControlName="shipment_type">
        <mat-option *ngFor="let type of shipmentTypes" [value]="type">{{
          type
        }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Nombre del destinatario</mat-label>
      <input
        matInput
        formControlName="recipient_name"
        placeholder="Nombre completo"
      />
      <mat-icon matSuffix>person_outline</mat-icon>
      <mat-error *ngIf="orderForm.get('recipient_name')?.hasError('required')"
        >Requerido</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Tel√©fono del destinatario</mat-label>
      <input
        matInput
        formControlName="recipient_phone"
        type="tel"
        placeholder=""
      />
      <mat-icon matSuffix>phone_outline</mat-icon>
      <mat-hint align="end">No se debe agregar el +51</mat-hint>
      <mat-error *ngIf="orderForm.get('recipient_phone')?.hasError('required')"
        >Requerido</mat-error
      >
      <mat-error *ngIf="orderForm.get('recipient_phone')?.hasError('pattern')"
        >Tel√©fono inv√°lido</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline" class="driver-search-field">
      <mat-label>Buscar y Seleccionar distrito</mat-label>
      <input
        type="text"
        placeholder="Escriba el nombre del distrito..."
        aria-label="distrito"
        matInput
        [formControl]="districtSearchCtrl"
        [matAutocomplete]="autoDistric"
      />
      <button
        *ngIf="districtSearchCtrl.value && !isLoadingDistricts"
        matSuffix
        mat-icon-button
        aria-label="Limpiar"
        (click)="clearDistrictSelection()"
      >
        <mat-icon>close</mat-icon>
      </button>
      <mat-icon
        matSuffix
        *ngIf="!districtSearchCtrl.value && !isLoadingDistricts"
        >person_search</mat-icon
      >
      <mat-progress-spinner
        *ngIf="isLoadingDistricts"
        matSuffix
        mode="indeterminate"
        diameter="20"
      ></mat-progress-spinner>

      <mat-autocomplete
        #autoDistric="matAutocomplete"
        [displayWith]="displayDistrictName"
        (optionSelected)="onDistrictSelected($event)"
      >
        @for (district of filteredDistricts$ | async; track district.id) {
        <mat-option [value]="district">
          <div class="driver-option">
            <span>{{ district.name_and_price }}</span>
          </div>
        </mat-option>
        } @if ((filteredDistricts$ | async)?.length === 0 && !isLoadingDistricts
        && districtSearchCtrl.value) {
        <mat-option disabled>No se encontraron distritos.</mat-option>
        }
      </mat-autocomplete>

      <mat-error
        *ngIf="orderForm.get('delivery_district_id')?.hasError('required')"
        >Requerido</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-span-column">
      <mat-label>Direcci√≥n de entrega</mat-label>
      <input
        matInput
        formControlName="delivery_address"
        placeholder="Ingresar lugar de entrega (M√≠nimo 6 caracteres)"
      />
      <mat-hint align="end"
        >No acepta caracteres especiales se borran autom√°ticos</mat-hint
      >
      <mat-error *ngIf="orderForm.get('delivery_address')?.hasError('required')"
        >Requerido</mat-error
      >
      <mat-error
        *ngIf="orderForm.get('delivery_address')?.hasError('minlength')"
        >M√≠nimo 6 caracteres</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Coordenadas (Opcional)</mat-label>
      <input
        matInput
        formControlName="delivery_coordinates"
        placeholder="-12.070,-77.012"
      />
      <mat-icon matSuffix>location_on_outline</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha Entrega</mat-label>
      <input
        matInput
        [matDatepicker]="deliveryDatePicker"
        formControlName="delivery_date"
        [min]="minDeliveryDate"
      />
      <mat-datepicker-toggle
        matSuffix
        [for]="deliveryDatePicker"
      ></mat-datepicker-toggle>
      <mat-datepicker #deliveryDatePicker></mat-datepicker>
      <mat-error *ngIf="orderForm.get('delivery_date')?.hasError('required')"
        >Requerido</mat-error
      >
    </mat-form-field>
  </div>

  <mat-divider class="section-divider"></mat-divider>

  <!-- ======================================================= -->
  <!-- === SECCI√ìN PARA A√ëADIR PAQUETES === -->
  <!-- ======================================================= -->

  <h3 class="section-subtitle">Tama√±o del paquete</h3>

  <!-- El radio button que controla el MODO GENERAL (dentro de newItemForm) -->
  <div [formGroup]="newItemForm">
    <mat-radio-group
      formControlName="package_type"
      aria-label="Tipo de paquete"
    >
      <mat-radio-button value="STANDARD"
        >Est√°ndar (1 solo paquete)</mat-radio-button
      >
      <mat-radio-button value="CUSTOM"
        >Otros tama√±os (M√∫ltiples paquetes)</mat-radio-button
      >
    </mat-radio-group>
  </div>
  <div
    id="standard-package-info"
    class="info-box hidden"
    *ngIf="newItemForm.get('package_type')?.value === 'STANDARD'"
  >
    <div class="info-content">
      <span class="info-icon">üì¶</span>
      <div class="info-text">
        <strong>Paquete Est√°ndar seleccionado</strong>
        <div>{{ this.standardPackageLabel() }}</div>
      </div>
    </div>
  </div>
  <div
    class="warning-paquete-size"
    *ngIf="newItemForm.get('package_type')?.value === 'STANDARD'"
  >
    <p>
      Si su paquete excede las medidas y pesos est√°ndar y no utiliza la
      calculadora de env√≠o, se le cobrar√° en funci√≥n de esas medidas sin previo
      aviso.
    </p>
  </div>
  <div class="max-dimensions-info">
    <p>{{ this.maxDimensionsInfo() }}</p>
  </div>
  <div *ngIf="newItemForm.get('package_type')?.value === 'CUSTOM'">
    <div [formGroup]="newItemForm" class="package-calculator-container">
      <h3 class="section-subtitle">A√±adir Paquete a la Lista</h3>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Descripci√≥n del Bulto</mat-label>
        <input
          matInput
          formControlName="description"
          placeholder="Ej: Zapatos, Laptop..."
          appAutoSelect
        />
        <mat-error *ngIf="newItemForm.get('description')?.hasError('required')"
          >Requerido</mat-error
        >
      </mat-form-field>

      <div class="custom-dimensions-grid">
        <mat-form-field appearance="outline">
          <mat-label>Largo (cm)</mat-label>
          <input
            matInput
            type="number"
            formControlName="length_cm"
            appAutoSelect
          />
          <mat-error *ngIf="newItemForm.get('length_cm')?.hasError('required')"
            >Requerido</mat-error
          >
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Ancho (cm)</mat-label>
          <input
            matInput
            type="number"
            formControlName="width_cm"
            appAutoSelect
          />
          <mat-error *ngIf="newItemForm.get('width_cm')?.hasError('required')"
            >Requerido</mat-error
          >
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Alto (cm)</mat-label>
          <input
            matInput
            type="number"
            formControlName="height_cm"
            appAutoSelect
          />
          <mat-error *ngIf="newItemForm.get('height_cm')?.hasError('required')"
            >Requerido</mat-error
          >
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Peso (kg)</mat-label>
          <input
            matInput
            type="number"
            formControlName="weight_kg"
            appAutoSelect
          />
          <mat-error *ngIf="newItemForm.get('weight_kg')?.hasError('required')"
            >Requerido</mat-error
          >
        </mat-form-field>
      </div>

      <div class="add-item-button-container">
        <button
          mat-flat-button
          type="button"
          class="btn-corp-primary"
          (click)="addItemToList()"
        >
          <mat-icon>add</mat-icon>
          Agregar Paquete a la Lista
        </button>
      </div>
      <div
        class="shipping-cost-display-package"
        *ngIf="newItemForm.get('package_type')?.value === 'CUSTOM'"
      >
        Costo de env√≠o del paquete =
        <span class="cost-value"
          >S/ {{ shippingCostPackage() | number : "1.2-2" }}</span
        >
      </div>
    </div>

    <div
      *ngIf="itemsFormArray.controls.length > 0"
      class="package-list-container"
    >
      <h3 class="section-subtitle">Desglose de Paquetes</h3>
      <mat-form-field appearance="outline" class="discount-field">
        <mat-label>% Descuento Adicional</mat-label>
        <input
          matInput
          [value]="multiPackageDiscountPercentage()"
          (input)="
            multiPackageDiscountPercentage.set(+$any($event.target).value)
          "
          [disabled]="!this.hasPermissionToEditPercentage()"
        />
        <mat-icon matSuffix>percent</mat-icon>
      </mat-form-field>

      <table
        mat-table
        [dataSource]="itemsDataSource"
        class="mat-elevation-z2 items-table"
      >
        <!-- Columna Descripci√≥n -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Descripci√≥n</th>
          <td mat-cell *matCellDef="let element">
            {{ element.value.description }}
          </td>
        </ng-container>

        <!-- Columna Medidas -->
        <ng-container matColumnDef="medidas">
          <th mat-header-cell *matHeaderCellDef>Medidas</th>
          <td mat-cell *matCellDef="let element">
            {{ element.value.length_cm }}x{{ element.value.width_cm }}x{{
              element.value.height_cm
            }}cm <br />
            <small>{{ element.value.weight_kg }}kg</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="basePrice">
          <th mat-header-cell *matHeaderCellDef>Precio Base</th>
          <td mat-cell *matCellDef="let element">
            {{ element.value.basePrice | currency : "S/ " }}
          </td>
        </ng-container>

        <ng-container matColumnDef="tipo">
          <th mat-header-cell *matHeaderCellDef>Tipo</th>
          <td mat-cell *matCellDef="let element">
            <span
              [ngClass]="{
                'principal-item': element.value.isPrincipal,
                'additional-item': !element.value.isPrincipal
              }"
            >
              {{ element.value.isPrincipal ? "Principal" : "Adicional" }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="finalPrice">
          <th mat-header-cell *matHeaderCellDef>Precio Final</th>
          <td mat-cell *matCellDef="let element">
            <!-- Si el item NO es principal y tiene descuento, muestra el precio tachado -->
            <div
              *ngIf="
                !element.value.isPrincipal &&
                element.value.finalPrice < element.value.basePrice
              "
              class="discounted-price"
            >
              <span class="original-price">{{
                element.value.basePrice | currency : "S/ "
              }}</span>
              <span class="final-price">{{
                element.value.finalPrice | currency : "S/ "
              }}</span>
            </div>

            <!-- Si es principal o no tiene descuento, muestra el precio normal -->
            <div
              *ngIf="
                element.value.isPrincipal ||
                element.value.finalPrice >= element.value.basePrice
              "
            >
              {{ element.value.finalPrice | currency : "S/ " }}
            </div>
          </td>
        </ng-container>

        <!-- Columna Eliminar -->
        <ng-container matColumnDef="eliminar">
          <th mat-header-cell *matHeaderCellDef>Eliminar</th>
          <td mat-cell *matCellDef="let element; let i = index">
            <button
              mat-icon-button
              color="warn"
              type="button"
              (click)="removeItem(i)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="itemsDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: itemsDisplayedColumns"></tr>
      </table>
    </div>
  </div>

  <div class="shipping-cost-display">
    Costo de env√≠o =
    <span class="cost-value"
      >S/
      {{ this.orderForm.get("shipping_cost")?.value | number : "1.2-2" }}</span
    >
  </div>

  <mat-divider class="section-divider"></mat-divider>

  <!-- Secci√≥n 3: Detalles del Env√≠o y Pago -->
  <div class="form-grid">
    <mat-form-field appearance="outline" class="full-span-column">
      <mat-label>¬øQu√© env√≠a?</mat-label>
      <input
        matInput
        formControlName="item_description"
        placeholder="Detalle del pedido"
      />
      <mat-icon matSuffix>inventory_2_outline</mat-icon>
      <mat-error *ngIf="orderForm.get('item_description')?.hasError('required')"
        >Requerido</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Monto total a cobrar</mat-label>
      <input
        matInput
        formControlName="amount_to_collect_at_delivery"
        type="number"
        min="0"
        placeholder="S/"
      />
      <span matPrefix>S/ </span>
      <mat-error
        *ngIf="
          orderForm.get('amount_to_collect_at_delivery')?.hasError('required')
        "
        >Requerido</mat-error
      >
      <mat-error
        *ngIf="orderForm.get('amount_to_collect_at_delivery')?.hasError('min')"
        >Monto no puede ser negativo</mat-error
      >
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>M√©todo de Pago (para cobro en entrega)</mat-label>
      <mat-select formControlName="payment_method_for_collection">
        <mat-option
          *ngFor="let method of paymentMethodsForCollection"
          [value]="method"
          >{{ method }}</mat-option
        >
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-span-column">
      <mat-label>Observaciones (Opcional)</mat-label>
      <textarea
        matInput
        formControlName="observations"
        placeholder="¬øQu√© env√≠as?..."
        rows="3"
      ></textarea>
    </mat-form-field>
  </div>
  <div class="add-order-button-container">
    <button
      mat-flat-button
      class="btn-corp-primary"
      type="submit"
      [disabled]="orderForm.invalid"
    >
      <mat-icon>add_shopping_cart</mat-icon> AGREGAR PEDIDO AL LISTADO
      <mat-icon>arrow_downward</mat-icon>
    </button>
  </div>
</form>
