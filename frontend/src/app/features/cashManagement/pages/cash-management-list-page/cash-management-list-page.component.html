<div class="page-container">
  <mat-card class="mat-card">
    <mat-card-header class="mat-card-header">
      <mat-card-title class="mat-card-title">Gestión de Caja</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filterForm" class="filter-form">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Fecha Inicio</mat-label>
          <input
            matInput
            [matDatepicker]="startDatePicker"
            formControlName="startDate"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="startDatePicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #startDatePicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Fecha Fin</mat-label>
          <input
            matInput
            [matDatepicker]="endDatePicker"
            formControlName="endDate"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="endDatePicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #endDatePicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Tipo de Movimiento</mat-label>
          <mat-select formControlName="typeMovement">
            <mat-option value="">Todos</mat-option>
            <mat-option value="INGRESO">Ingreso</mat-option>
            <mat-option value="EGRESO">Egreso</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Forma de Pago</mat-label>
          <mat-select formControlName="paymentsMethod">
            <mat-option value="">Todos</mat-option>
            <mat-option value="Efectivo">Efectivo</mat-option>
            <mat-option value="Otros">Otros</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Add user filter if needed -->
      </form>
      <div class="form-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="applyFilters()"
          class="btn-corp-primary"
        >
          <mat-icon>filter_list</mat-icon> Aplicar Filtros
        </button>
        <button
          mat-raised-button
          color="accent"
          (click)="openAddMovementDialog()"
          class="btn-corp-primary"
        >
          <mat-icon>add</mat-icon> Registrar Movimiento
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="mat-card summary-section">
    <mat-card-header class="mat-card-header">
      <mat-card-title class="mat-card-title">Resumen de Saldos</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="isLoadingSummary" class="loading-overlay">
        <mat-spinner diameter="30"></mat-spinner>
      </div>
      <div *ngIf="summary$ | async as summary" class="summary-grid">
        <mat-card class="summary-card income-card">
          <mat-card-content>
            <div class="summary-label">Total Ingresos</div>
            <div class="summary-value">
              {{ summary.totalIncome | currency : "S/ " }}
            </div>
          </mat-card-content>
        </mat-card>
        <mat-card class="summary-card expense-card">
          <mat-card-content>
            <div class="summary-label">Total Egresos</div>
            <div class="summary-value">
              {{ summary.totalExpense | currency : "S/ " }}
            </div>
          </mat-card-content>
        </mat-card>
        <mat-card class="summary-card balance-card">
          <mat-card-content>
            <div class="summary-label">Saldo del Periodo</div>
            <div
              class="summary-value"
              [ngClass]="{
                'text-green-700': summary.balance >= 0,
                'text-red-700': summary.balance < 0
              }"
            >
              {{ summary.balance | currency : "S/ " }}
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="mat-cards">
    <mat-card-header class="mat-card-headers">
      <!-- Removed MatCardTitle for "Movimientos de Caja" -->
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="isLoadingResults" class="loading-overlay">
        <mat-spinner diameter="30"></mat-spinner>
      </div>
      <div class="">
        <table
          mat-table
          [dataSource]="(cashMovements$ | async) || []"
          matSort
          class="mat-table"
        >
          <!-- Code Column -->
          <ng-container matColumnDef="code">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="mat-header-cell"
            >
              N°
            </th>
            <td mat-cell *matCellDef="let element" class="mat-cell">
              {{ element.code }}
            </td>
          </ng-container>

          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="mat-header-cell"
            >
              Fecha
            </th>
            <td mat-cell *matCellDef="let element" class="mat-cell">
              {{ element.date | date : "dd/MM/yyyy" }}
            </td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="typeMovement">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="mat-header-cell"
            >
              Tipo
            </th>
            <td mat-cell *matCellDef="let element" class="mat-cell">
              {{ element.typeMovement }}
            </td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="mat-header-cell"
            >
              Monto
            </th>
            <td mat-cell *matCellDef="let element" class="mat-cell">
              {{ element.amount | currency : "S/ " }}
            </td>
          </ng-container>

          <!-- Payment Method Column -->
          <ng-container matColumnDef="paymentsMethod">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="mat-header-cell"
            >
              Forma de Pago
            </th>
            <td mat-cell *matCellDef="let element" class="mat-cell">
              {{ element.paymentsMethod }}
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="mat-header-cell"
            >
              Descripción
            </th>
            <td mat-cell *matCellDef="let element" class="mat-cell">
              {{ element.description }}
            </td>
          </ng-container>

          <!-- User Column -->
          <ng-container matColumnDef="user">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              class="mat-header-cell"
            >
              Usuario
            </th>
            <td mat-cell *matCellDef="let element" class="mat-cell">
              {{ element.user?.username }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="mat-header-cell">
              Acciones
            </th>
            <td mat-cell *matCellDef="let element">
              <button
                mat-icon-button
                [matMenuTriggerFor]="actionsMenu"
                aria-label="Acciones"
              >
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionsMenu="matMenu">
                <button mat-menu-item (click)="editMovement(element)">
                  <mat-icon>edit</mat-icon>
                  <span>Editar</span>
                </button>
                <button mat-menu-item (click)="generatePdf(element.id)">
                  <mat-icon>picture_as_pdf</mat-icon>
                  <span>Generar PDF</span>
                </button>
                <button mat-menu-item (click)="deleteMovement(element.id)">
                  <mat-icon>delete</mat-icon>
                  <span>Eliminar</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <!-- Row shown when there is no matching data. -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" colspan="7">
              No hay movimientos de caja que coincidan con los filtros.
            </td>
          </tr>
        </table>

        <mat-paginator
          [length]="totalItems"
          [pageSize]="pageSize"
          [pageSizeOptions]="[5, 10, 20, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        ></mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>
