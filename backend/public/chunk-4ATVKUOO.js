import{a as Z,b as ee}from"./chunk-24IQJ7FX.js";import{a as Ce,b as Pe}from"./chunk-UIDYBQS3.js";import{a as Q,d as W,f as X,i as Y}from"./chunk-V3FD5NRF.js";import{a as pe,b as de,e as ge,h as ue,i as fe,m as _e,n as he}from"./chunk-7NEAIHF5.js";import{b as te,d as ne,f as ie,g as oe,k as re,n as se,o as ae,q as le,r as ce,s as me,t as Se,u as xe}from"./chunk-TIJNC7MJ.js";import{Ac as K,B as h,Bb as F,Bc as J,Cb as s,Db as R,Eb as x,Ka as E,L as T,La as l,M as w,Qb as H,Ua as j,W as b,X as v,Za as S,a as M,aa as V,ab as c,b as O,cc as G,f as I,fa as p,i as L,j as A,jb as r,jc as z,kb as n,lb as f,mb as N,mc as k,na as d,nb as B,nd as be,oa as g,oc as q,p as D,pb as $,pd as ve,q as P,rb as u,s as U,sb as m}from"./chunk-GBK3QFXL.js";var C={business_name:null,address:null,phone_number:null,logo_url:null,terms_conditions_url:null};var y=class a{http=p(q);authService=p(J);apiUrl=K.apiUrl+"/settings";settingsSubject=new A(null);settings$=this.settingsSubject.asObservable();constructor(){}getAuthHeaders(){let e=this.authService.getAccessToken();return e?new k({"Content-Type":"application/json",codrr_token:e}):new k({"Content-Type":"application/json"})}loadSettings(){let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrl+"/all",{headers:e}).pipe(U(t=>t||C),v(t=>{this.settingsSubject.next(t),console.log("SettingsService: Settings loaded from API and Subject updated",t)}),h(this.handleError("loadSettings",C))):P(()=>new Error("Not authenticated to fetch users."))}saveSettings(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(this.apiUrl+"/edit/"+e.id,e,{headers:t}).pipe(v(o=>{this.settingsSubject.next(o),console.log("SettingsService: Settings saved and Subject updated",o)}),h(this.handleError("saveSettings"))):P(()=>new Error("Not authenticated to fetch users."))}uploadLogo(e){let t=new FormData;return t.append("logoFile",e,e.name),this.http.post(`${this.apiUrl}/upload-logo`,t).pipe(v(o=>console.log("SettingsService: Logo uploaded",o)),h(this.handleError("uploadLogo")))}uploadTermsPdf(e){let t=new FormData;return t.append("termsPdfFile",e,e.name),console.log("SettingsService: Uploading terms PDF...",e.name),this.http.post(`${this.apiUrl}/upload-terms-pdf`,t).pipe(v(o=>console.log("SettingsService: Terms PDF uploaded",o)),h(this.handleError("uploadTermsPdf")))}handleError(e="operation",t){return o=>(console.error(`${e} failed: ${o.message}`,o),t!==void 0?D(t):P(()=>new Error(`Error in ${e}. Details: ${o.message||"Server error"}`)))}getCurrentSettings(){return this.settingsSubject.value}static \u0275fac=function(t){return new(t||a)};static \u0275prov=V({token:a,factory:a.\u0275fac,providedIn:"root"})};function Me(a,e){a&1&&(r(0,"div",7),f(1,"mat-progress-spinner",8),n())}function Te(a,e){a&1&&(r(0,"mat-error"),s(1," Se requiere el nombre de la empresa. "),n())}function we(a,e){if(a&1&&(N(0),s(1," Archivo actual: "),r(2,"a",34),s(3),n(),B()),a&2){let t=m(2);l(2),c("href",t.currentTermsUrl,E),l(),R(t.currentTermsUrl.split("/").pop()||"View Terms")}}function Ee(a,e){a&1&&(r(0,"span",35),s(1,"A\xFAn no se ha cargado ning\xFAn PDF de T\xE9rminos y Condiciones."),n())}function ke(a,e){a&1&&(r(0,"p",25),s(1," Sube un archivo PDF con tus t\xE9rminos y condiciones. "),n())}function Oe(a,e){if(a&1&&(r(0,"p",25),s(1),n()),a&2){let t=m(2);l(),x(" Selected: ",t.selectedTermsFile.name," ")}}function Ie(a,e){if(a&1){let t=$();r(0,"mat-card",9)(1,"mat-card-content")(2,"form",10),u("ngSubmit",function(){d(t);let i=m();return g(i.onSaveSettings())}),r(3,"h2"),s(4,"Nombre del negocio"),n(),r(5,"mat-form-field",11)(6,"mat-label"),s(7,"Nombre de la empresa"),n(),f(8,"input",12),r(9,"mat-icon",13),s(10,"storefront"),n(),S(11,Te,2,0,"mat-error",14),n(),r(12,"mat-form-field",11)(13,"mat-label"),s(14,"Direcc\xF3n"),n(),f(15,"input",15),n(),r(16,"div",16)(17,"mat-form-field",17)(18,"mat-label"),s(19,"Telefono"),n(),f(20,"input",18),r(21,"mat-icon",13),s(22,"phone"),n()()(),r(23,"h2"),s(24,"Marca y aspectos legales"),n(),r(25,"div",19)(26,"p",20),s(27,"Logotipo de empresa"),n(),r(28,"div",21),f(29,"img",22),n(),r(30,"input",23,0),u("change",function(i){d(t);let _=m();return g(_.onLogoFileSelected(i))}),n(),r(32,"button",24),u("click",function(){d(t);let i=F(31);return g(i.click())}),r(33,"mat-icon"),s(34,"cloud_upload"),n(),s(35),n(),r(36,"p",25),s(37,"Recomendado: PNG, JPG, SVG. Max 2MB."),n()(),r(38,"div",26)(39,"p",20),s(40," T\xE9rminos y condiciones (PDF) "),n(),r(41,"div",27),S(42,we,4,2,"ng-container",28)(43,Ee,2,0,"ng-template",null,1,H),n(),r(45,"input",29,2),u("change",function(i){d(t);let _=m();return g(_.onTermsFileSelected(i))}),n(),r(47,"button",24),u("click",function(){d(t);let i=F(46);return g(i.click())}),r(48,"mat-icon"),s(49,"cloud_upload"),n(),s(50),n(),S(51,ke,2,0,"p",30)(52,Oe,2,1,"p",30),n(),r(53,"mat-card-actions",31)(54,"button",32),u("click",function(){d(t);let i=m();return g(i.onDiscardChanges())}),s(55," Descartar cambios "),n(),r(56,"button",33)(57,"mat-icon"),s(58,"save"),n(),s(59),n()()()()()}if(a&2){let t,o=F(44),i=m();l(2),c("formGroup",i.settingsForm),l(9),c("ngIf",(t=i.settingsForm.get("business_name"))==null?null:t.hasError("required")),l(18),c("src",i.logoPreviewUrl||"assets/placeholder-logo.png",E),l(6),x(" ",i.selectedLogoFile?"Change Logo ("+i.selectedLogoFile.name+")":"Subir nuevo logotipo"," "),l(7),c("ngIf",i.currentTermsUrl)("ngIfElse",o),l(8),x(" ",i.selectedTermsFile?"Change PDF ("+i.selectedTermsFile.name+")":"Subir nuevo PDF"," "),l(),c("ngIf",!i.selectedTermsFile),l(),c("ngIf",i.selectedTermsFile),l(2),c("disabled",i.isSaving||!i.settingsForm.dirty),l(2),c("disabled",i.isSaving||i.settingsForm.invalid||!i.settingsForm.dirty),l(3),x(" ",i.isSaving?"Guardando...":"Guardar configuracion"," ")}}var Fe=class a{fb=p(ce);settingsService=p(y);snackBar=p(Ce);settingsForm;isLoadingInitialData=!0;isSaving=!1;currentLogoUrl=null;selectedLogoFile=null;logoPreviewUrl=null;currentTermsUrl=null;selectedTermsFile=null;destroy$=new L;ngOnInit(){this.buildForm(C),this.loadCurrentSettings()}buildForm(e){this.settingsForm=this.fb.group({id:[e.id],business_name:[e.business_name,ne.required],address:[e.address],phone_number:[e.phone_number],logo_url:[e.logo_url],terms_conditions_url:[e.terms_conditions_url]}),this.currentLogoUrl=e.logo_url,this.logoPreviewUrl=e.logo_url,this.currentTermsUrl=e.terms_conditions_url}loadCurrentSettings(){this.isLoadingInitialData=!0,this.settingsService.loadSettings().pipe(b(this.destroy$),T(()=>this.isLoadingInitialData=!1)).subscribe({next:e=>{e.length&&(this.settingsForm.patchValue(O(M({},e),{id:e[0].id,business_name:e[0].business_name,address:e[0].address,phone_number:e[0].phone_number})),this.currentLogoUrl=e[0].logo_url,this.logoPreviewUrl=e[0].logo_url,this.currentTermsUrl=e[0].terms_conditions_url,console.log("this.settingsForm",this.settingsForm))},error:e=>{this.snackBar.open("Failed to load current settings. Please try again.","Close",{duration:5e3,panelClass:["error-snackbar"],verticalPosition:"top"})}})}onLogoFileSelected(e){let o=e.target.files;if(o&&o.length>0){this.selectedLogoFile=o[0];let i=new FileReader;i.onload=_=>{this.logoPreviewUrl=_.target.result},i.readAsDataURL(this.selectedLogoFile),this.settingsForm.get("logo_url")?.markAsDirty()}else this.selectedLogoFile=null,this.logoPreviewUrl=this.currentLogoUrl}onTermsFileSelected(e){let o=e.target.files;o&&o.length>0?(this.selectedTermsFile=o[0],this.settingsForm.get("terms_conditions_url")?.markAsDirty(),console.log("Terms PDF selected:",this.selectedTermsFile.name)):this.selectedTermsFile=null}onSaveSettings(){return I(this,null,function*(){if(this.settingsForm.invalid){this.snackBar.open("Please correct the errors in the form.","Close",{duration:3e3,panelClass:["error-snackbar"]}),this.settingsForm.markAllAsTouched();return}this.isSaving=!0;let e=M({},this.settingsForm.value);if(this.selectedLogoFile)try{let t=yield this.settingsService.uploadLogo(this.selectedLogoFile).pipe(w(),b(this.destroy$)).toPromise();if(t?.logo_url)e.logo_url=t.logo_url;else throw new Error("Logo URL not returned from upload.")}catch(t){console.error("Logo upload failed:",t),this.snackBar.open("Logo upload failed. Settings not saved.","Close",{duration:4e3,panelClass:["error-snackbar"],verticalPosition:"top"}),this.isSaving=!1;return}if(this.selectedTermsFile)try{let t=yield this.settingsService.uploadTermsPdf(this.selectedTermsFile).pipe(w(),b(this.destroy$)).toPromise();if(t?.terms_conditions_url)e.terms_conditions_url=t.terms_conditions_url;else throw new Error("Terms & Conditions URL not returned from PDF upload.")}catch(t){console.error("Terms PDF upload failed:",t),this.snackBar.open("Terms & Conditions PDF upload failed. Settings not saved.","Close",{duration:4e3,panelClass:["error-snackbar"],verticalPosition:"top"}),this.isSaving=!1;return}this.settingsService.saveSettings(e).pipe(b(this.destroy$),T(()=>this.isSaving=!1)).subscribe({next:t=>{this.snackBar.open("Settings saved successfully!","OK",{duration:3e3,verticalPosition:"top",panelClass:["success-snackbar"]}),this.settingsForm.patchValue(t),this.settingsForm.markAsPristine(),this.currentLogoUrl=t.logo_url,this.logoPreviewUrl=t.logo_url,this.selectedLogoFile=null,this.currentTermsUrl=t.terms_conditions_url,this.selectedTermsFile=null},error:t=>{this.snackBar.open("Failed to save settings. Please try again.","Retry",{duration:5e3,verticalPosition:"top",panelClass:["error-snackbar"]})}})})}onDiscardChanges(){this.loadCurrentSettings(),this.selectedLogoFile=null,this.selectedTermsFile=null,this.settingsForm.markAsPristine(),this.snackBar.open("Changes discarded.","OK",{duration:2e3,verticalPosition:"top"})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=j({type:a,selectors:[["app-settings-page"]],decls:6,vars:2,consts:[["logoUploadInput",""],["noTermsFile",""],["termsUploadInput",""],[1,"page-container","settings-container"],[1,"page-header"],["class","spinner-overlay",4,"ngIf"],["class","settings-card",4,"ngIf"],[1,"spinner-overlay"],["mode","indeterminate","diameter","60"],[1,"settings-card"],[3,"ngSubmit","formGroup"],["appearance","outline",1,"full-width"],["matInput","","formControlName","business_name","required",""],["matSuffix",""],[4,"ngIf"],["matInput","","formControlName","address"],[1,"form-row"],["appearance","outline",1,"flex-field"],["matInput","","formControlName","phone_number"],[1,"logo-section","file-upload-section"],[1,"mat-body-1","section-subtitle"],[1,"logo-preview-container"],["alt","Vista previa del logotipo",1,"logo-preview",3,"src"],["type","file","accept","image/png, image/jpeg, image/svg+xml",2,"display","none",3,"change"],["mat-stroked-button","","type","button",1,"upload-button",3,"click"],[1,"mat-caption","hint"],[1,"terms-pdf-section","file-upload-section"],[1,"current-file-info"],[4,"ngIf","ngIfElse"],["type","file","accept","application/pdf",2,"display","none",3,"change"],["class","mat-caption hint",4,"ngIf"],["align","end",1,"form-actions"],["mat-stroked-button","","type","button",3,"click","disabled"],["mat-flat-button","","color","primary","type","submit",3,"disabled"],["target","_blank",1,"file-link",3,"href"],[1,"no-file-text"]],template:function(t,o){t&1&&(r(0,"div",3)(1,"div",4)(2,"h1"),s(3,"Configuraci\xF3n de la aplicaci\xF3n"),n()(),S(4,Me,2,0,"div",5)(5,Ie,60,12,"mat-card",6),n()),t&2&&(l(4),c("ngIf",o.isLoadingInitialData),l(),c("ngIf",!o.isLoadingInitialData&&o.settingsForm))},dependencies:[z,G,me,re,te,ie,oe,le,se,ae,Y,Q,X,W,fe,ue,pe,de,ge,he,_e,ve,be,xe,Se,Pe,ee,Z],styles:[".page-container[_ngcontent-%COMP%]{padding:24px}.settings-container[_ngcontent-%COMP%]{max-width:800px;margin:0 auto}.page-header[_ngcontent-%COMP%]{margin-bottom:24px}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:2em;font-weight:500;color:var(--mat-toolbar-standard-title-text-color, #333)}.spinner-overlay[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#ffffffb3;z-index:1000}h2[_ngcontent-%COMP%]{font-size:1.5em;margin-top:24px;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,.12);color:var(--mat-card-title-text-color, #333);font-weight:400}h2[_ngcontent-%COMP%]:first-of-type{margin-top:0}.full-width[_ngcontent-%COMP%]{width:100%;margin-bottom:20px}.form-row[_ngcontent-%COMP%]{display:flex;gap:20px;margin-bottom:20px}.form-row[_ngcontent-%COMP%]   .flex-field[_ngcontent-%COMP%]{flex:1}.logo-section[_ngcontent-%COMP%]{margin-bottom:24px;padding:16px;border:1px solid #e0e0e0;border-radius:4px;background-color:#fafafa}.logo-section[_ngcontent-%COMP%]   .mat-body-1[_ngcontent-%COMP%]{font-weight:500;margin-bottom:12px}.logo-preview-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;margin-bottom:16px;min-height:120px}.logo-preview[_ngcontent-%COMP%]{max-width:200px;max-height:100px;object-fit:contain;border:1px solid #ccc;border-radius:4px;background-color:#fff;padding:5px}.hint[_ngcontent-%COMP%]{display:block;text-align:center;color:#757575}.form-actions[_ngcontent-%COMP%]{margin-top:32px;padding-top:24px;border-top:1px solid rgba(0,0,0,.12)}.file-upload-section[_ngcontent-%COMP%]{margin-bottom:24px;padding:16px;border:1px solid #e0e0e0;border-radius:8px;background-color:#f9f9f9}.file-upload-section[_ngcontent-%COMP%]   .section-subtitle[_ngcontent-%COMP%]{font-weight:500;margin-bottom:12px;font-size:1.1em;color:#424242}.logo-preview-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;margin-bottom:16px;min-height:120px;background-color:#f0f0f0;border-radius:4px}.logo-preview[_ngcontent-%COMP%]{max-width:200px;max-height:100px;object-fit:contain;border:1px dashed #ccc;padding:5px}.terms-pdf-section[_ngcontent-%COMP%]   .current-file-info[_ngcontent-%COMP%]{margin-bottom:12px;font-size:.9em}.terms-pdf-section[_ngcontent-%COMP%]   .current-file-info[_ngcontent-%COMP%]   .file-link[_ngcontent-%COMP%]{color:var(--mat-primary-default, #3f51b5);text-decoration:none;font-weight:500}.terms-pdf-section[_ngcontent-%COMP%]   .current-file-info[_ngcontent-%COMP%]   .file-link[_ngcontent-%COMP%]:hover{text-decoration:underline}.terms-pdf-section[_ngcontent-%COMP%]   .current-file-info[_ngcontent-%COMP%]   .no-file-text[_ngcontent-%COMP%]{font-style:italic;color:#757575}.upload-button[_ngcontent-%COMP%]{display:block;margin:0 auto 8px}.hint[_ngcontent-%COMP%]{display:block;text-align:center;color:#757575;font-size:.85em}"]})};export{Fe as SettingsPageComponent};
