import{a as pe}from"./chunk-RUOLSQVE.js";import"./chunk-JL4HNGFU.js";import{a as Kt,c as Yt}from"./chunk-INNR5TUR.js";import{a as Xt,b as Jt,c as Qt,d as qt}from"./chunk-6Q5D6C62.js";import{a as xt,b as Mt,d as Z,e as ee,f as bt,g as St,i as te}from"./chunk-EPOJPPLL.js";import{d as K}from"./chunk-OA3ZBEZL.js";import{c as It,d as Dt}from"./chunk-Y5YLFPPJ.js";import{a as ne,b as ie}from"./chunk-TIWSFICS.js";import"./chunk-7H6SUWW6.js";import"./chunk-F5X5MWHG.js";import{a as Ot,b as wt,c as kt,d as Tt,e as Ft,f as Rt,g as Nt,h as At,i as Lt,j as Bt,k as Ht,l as Vt,m as jt,n as le,o as Ut,p as se}from"./chunk-QTOZGGF4.js";import"./chunk-MS4AQ6UA.js";import{b as ae,d as oe,e as re}from"./chunk-PECN6JBI.js";import{a as $t,b as zt}from"./chunk-OFPIJO26.js";import{a as vt,c as Y,e as _t,f as Et,g as Ct,h as W}from"./chunk-M6APXQQA.js";import{d as yt}from"./chunk-QAYMNGMK.js";import"./chunk-ZHQNQEFC.js";import"./chunk-MUR4FGFA.js";import{b as Gt}from"./chunk-K6H7B7A7.js";import{b as Pt}from"./chunk-ZQWPYXMK.js";import{b as ht}from"./chunk-PHH6JU56.js";import"./chunk-R5U3N7CA.js";import{d as gt,e as ut}from"./chunk-E35XVMLM.js";import{a as j,b as q}from"./chunk-655RBLG6.js";import"./chunk-7RWCIHFI.js";import{D as mt,G as ct,H as dt,b as tt,f as nt,g as it,l as at,o as ot,r as rt,v as lt,x as st,z as pt}from"./chunk-43WGTYKX.js";import"./chunk-NKCNST4D.js";import"./chunk-3VA5ILTZ.js";import{a as Je,b as Qe,d as qe,e as Ke,f as Ye,g as We,h as Ze,i as et}from"./chunk-JPSKUWSR.js";import{a as J,b as Q}from"./chunk-O7CKCNSQ.js";import{a as Xe}from"./chunk-VITECNWY.js";import{c as D,d as ft,f as x}from"./chunk-6QAU3IBA.js";import"./chunk-E5NRZ37D.js";import{$b as He,Ab as y,Cb as f,Db as v,Dc as P,Ea as S,Ed as V,Fd as M,Hc as xe,I as R,Ic as Ve,J as we,Jb as Ee,Jc as je,Kb as Ce,Lb as he,Ob as I,Oc as $e,Pb as r,Q as ke,Qb as T,Qc as ze,Rb as c,Rc as Ue,Sb as U,Ua as l,Vc as X,Wc as Ge,Yb as Be,a as _e,aa as Te,ac as N,ba as z,bb as h,cc as A,da as Fe,fc as Pe,h as Ie,hb as g,ia as Re,kb as Ae,l as F,lb as s,m as De,na as d,nb as Le,t as Oe,tc as L,u as $,ub as a,uc as B,va as Ne,vb as n,vc as H,wa as E,wb as _,xa as C,xb as w,yb as k,zc as b}from"./chunk-DQQKDGFN.js";var O=class i{http=d(je);apiUrl=`${Ge.apiUrl}/planning-events`;authService=d(Xe);constructor(){}getAuthHeaders(){let e=this.authService.getAccessToken();return e?new xe({"Content-Type":"application/json",codrr_token:e}):new xe({"Content-Type":"application/json"})}getPlanningEvents(e,t,o,p,m){let u=new Ve().set("page_number",t.toString()).set("page_size",o.toString()).set("sort_field",p).set("sort_direction",m);return e.startDate&&(u=u.set("start_date",e.startDate)),e.endDate&&(u=u.set("end_date",e.endDate)),e.status&&(u=u.set("status",e.status)),this.http.get(this.apiUrl,{params:u}).pipe(R(this.handleError))}getPlanningEventDetails(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrl}/${e}`,{headers:t}).pipe(R(this.handleError)):$(()=>new Error("Not authenticated to fetch planning event details."))}importPlanningEventsFromParsedJson(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrl}/import-batch-json`,e,{headers:t}).pipe(R(this.handleImportError)):$(()=>new Error("Not authenticated to fetch users."))}handleImportError(e){console.error("API Import Error:",e);let t={success:!1,message:"Error de comunicaci\xF3n con el servidor durante la importaci\xF3n.",errors:[{row:0,message:`Error: ${e.status} - ${e.statusText||"Error desconocido"}`}]};return e.error&&typeof e.error=="object"&&"message"in e.error&&(t=_e(_e({},t),e.error)),$(()=>t)}handleError(e){let t="An unknown error occurred!";return e.error instanceof ErrorEvent?t=`Error: ${e.error.message}`:(t=`Error Code: ${e.status}
Message: ${e.message||e.error?.message||"Server error"}`,e.status===0&&(t="Could not connect to the server. Please check your network or if the server is running.")),console.error("API Error in PlanningEventsService:",e),$(()=>new Error(t))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=Re({token:i,factory:i.\u0275fac,providedIn:"root"})};function an(i,e){i&1&&(a(0,"div",16),_(1,"mat-progress-spinner",17),n())}function on(i,e){i&1&&(a(0,"th",18),r(1,"N\xB0"),n())}function rn(i,e){if(i&1&&(a(0,"td",19),r(1),n()),i&2){let t=e.$implicit;l(),c(" ",t.planningEventIdExternal," ")}}function ln(i,e){i&1&&(a(0,"th",18),r(1,"Fecha"),n())}function sn(i,e){if(i&1&&(a(0,"td",19),r(1),N(2,"date"),n()),i&2){let t=e.$implicit;l(),c(" ",A(2,1,t.planningDate,"dd/MM/yyyy")," ")}}function pn(i,e){i&1&&(a(0,"th",18),r(1,"N\xB0 Rutas"),n())}function mn(i,e){if(i&1&&(a(0,"td",19),r(1),n()),i&2){let t=e.$implicit;l(),c(" ",(t.routes==null?null:t.routes.length)||0," ")}}function cn(i,e){i&1&&(a(0,"th",18),r(1,"N\xB0 Paradas"),n())}function dn(i,e){if(i&1&&(a(0,"td",19),r(1),n()),i&2){let t=e.$implicit,o=v();l(),c(" ",o.getTotalStops(t)," ")}}function gn(i,e){i&1&&(a(0,"th",18),r(1,"Estado"),n())}function un(i,e){if(i&1&&(a(0,"td",19)(1,"span",20),r(2),n()()),i&2){let t=e.$implicit,o=v();l(),s("ngClass",o.getStatusClass(t)),l(),c(" ",o.getStatus(t)," ")}}function fn(i,e){i&1&&(a(0,"th",21),r(1,"Acciones"),n())}function vn(i,e){if(i&1){let t=y();a(0,"td",19)(1,"button",22),f("click",function(){let p=E(t).$implicit,m=v();return C(m.onViewDetails(p))}),r(2," Ver Detalle "),n()()}}function _n(i,e){i&1&&_(0,"tr",23)}function En(i,e){i&1&&_(0,"tr",24)}function Cn(i,e){if(i&1&&(a(0,"tr",25)(1,"td",26),r(2," No se encontraron planes de ruta que coincidan con los filtros. "),n()()),i&2){let t=v();l(),Ae("colspan",t.displayedColumns.length)}}var me=class i{planningEvents=[];isLoading=!1;totalCount=0;pageSize=10;pageIndex=0;pageChanged=new S;sortChanged=new S;viewDetailsClicked=new S;displayedColumns=["planningEventIdExternal","planningDate","total_routes","total_stops","status","actions"];dataSource=new jt;paginator;sort;dialog=d(Y);snackBar=d(j);PlanningEventStatus=pe;constructor(){}ngOnChanges(e){e.planningEvents&&this.planningEvents&&(this.dataSource.data=this.planningEvents)}ngAfterViewInit(){}getStatusClass(e){return`status-${(e.routes.every(m=>m.stops.every(u=>u.order.status==="ENTREGADO"||u.order.status==="RECHAZADO EN PUNTO"))?"completed":"pending").toLowerCase().replace(/[\s_]+/g,"-")}`}getStatus(e){return e.routes.every(p=>p.stops.every(m=>m.order.status==="ENTREGADO"||m.order.status==="RECHAZADO EN PUNTO"))?"completed":"pending"}getTotalStops(e){return e.routes.reduce((t,o)=>o.stops?.length+t,0)}onViewDetails(e){this.viewDetailsClicked.emit(e.id)}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=h({type:i,selectors:[["app-planning-events-table"]],viewQuery:function(t,o){if(t&1&&(Ee(oe,5),Ee(le,5)),t&2){let p;Ce(p=he())&&(o.paginator=p.first),Ce(p=he())&&(o.sort=p.first)}},inputs:{planningEvents:"planningEvents",isLoading:"isLoading",totalCount:"totalCount",pageSize:"pageSize",pageIndex:"pageIndex"},outputs:{pageChanged:"pageChanged",sortChanged:"sortChanged",viewDetailsClicked:"viewDetailsClicked"},features:[Ne],decls:25,vars:8,consts:[[1,"table-wrapper","mat-elevation-z4"],["class","spinner-overlay",4,"ngIf"],["mat-table","","matSort","",3,"matSortChange","dataSource"],["matColumnDef","planningEventIdExternal"],["mat-header-cell","","mat-sort-header","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","planningDate"],["matColumnDef","total_routes"],["matColumnDef","total_stops"],["matColumnDef","status"],["matColumnDef","actions"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-header-row","",4,"matHeaderRowDef","matHeaderRowDefSticky"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","mat-row",4,"matNoDataRow"],["showFirstLastButtons","","aria-label","Seleccione p\xE1gina de planes de ruta",3,"page","length","pageSize","pageIndex"],[1,"spinner-overlay"],["mode","indeterminate","diameter","60"],["mat-header-cell","","mat-sort-header",""],["mat-cell",""],[1,"status-badge",3,"ngClass"],["mat-header-cell",""],["mat-flat-button","","color","primary",3,"click"],["mat-header-row",""],["mat-row",""],[1,"mat-row"],[1,"no-data-cell"]],template:function(t,o){t&1&&(a(0,"div",0),g(1,an,2,0,"div",1),a(2,"table",2),f("matSortChange",function(m){return o.sortChanged.emit(m)}),w(3,3),g(4,on,2,0,"th",4)(5,rn,2,1,"td",5),k(),w(6,6),g(7,ln,2,0,"th",4)(8,sn,3,4,"td",5),k(),w(9,7),g(10,pn,2,0,"th",4)(11,mn,2,1,"td",5),k(),w(12,8),g(13,cn,2,0,"th",4)(14,dn,2,1,"td",5),k(),w(15,9),g(16,gn,2,0,"th",4)(17,un,3,2,"td",5),k(),w(18,10),g(19,fn,2,0,"th",11)(20,vn,3,0,"td",5),k(),g(21,_n,1,0,"tr",12)(22,En,1,0,"tr",13)(23,Cn,3,1,"tr",14),n(),a(24,"mat-paginator",15),f("page",function(m){return o.pageChanged.emit(m)}),n()()),t&2&&(l(),s("ngIf",o.isLoading),l(),s("dataSource",o.dataSource),l(19),s("matHeaderRowDef",o.displayedColumns)("matHeaderRowDefSticky",!0),l(),s("matRowDefColumns",o.displayedColumns),l(2),s("length",o.totalCount)("pageSize",o.pageSize)("pageIndex",o.pageIndex))},dependencies:[P,L,H,b,Vt,Ot,kt,Nt,Tt,wt,At,Ft,Rt,Lt,Bt,Ht,re,oe,se,le,Ut,Q,J,x,D,M,ae,K,W,q,ht],styles:[".table-wrapper[_ngcontent-%COMP%]{position:relative;min-height:200px;border-radius:8px;overflow:hidden}.spinner-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;background:#fffc;z-index:10}.planning-events-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.planning-events-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .planning-events-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:12px 16px;border-bottom:1px solid #e0e0e0;text-align:left}.planning-events-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:#f5f5f5;font-weight:600;color:#555}.planning-events-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:last-child   td[_ngcontent-%COMP%]{border-bottom:none}.planning-events-table[_ngcontent-%COMP%]   .mat-row[_ngcontent-%COMP%]:hover{background-color:#f9f9f9}.status-badge[_ngcontent-%COMP%]{display:inline-block;padding:4px 8px;border-radius:4px;font-size:.85em;font-weight:500;color:#fff;text-transform:uppercase}.status-pending[_ngcontent-%COMP%]{background-color:#ffc107}.status-completed[_ngcontent-%COMP%]{background-color:#28a745}.status-cancelled[_ngcontent-%COMP%]{background-color:#dc3545}.status-desconocido[_ngcontent-%COMP%]{background-color:#6c757d}.actions-column-header[_ngcontent-%COMP%]{text-align:center}.actions-cell[_ngcontent-%COMP%]{text-align:center;white-space:nowrap}.no-data-cell[_ngcontent-%COMP%]{text-align:center;padding:20px;color:#777;font-style:italic}.mat-paginator[_ngcontent-%COMP%]{background:#fff;border-top:1px solid #e0e0e0;color:#555}"]})};function hn(i,e){if(i&1&&(a(0,"mat-option",8),r(1),n()),i&2){let t=e.$implicit;s("value",t),l(),c(" ",t," ")}}var ge=class i{filtersChanged=new S;filterForm;planningEventStatuses=Object.values(pe);fb=d(lt);datePipe=d(b);destroy$=new F;constructor(){let e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),o=new Date(e.getFullYear(),e.getMonth()+1,0);this.filterForm=this.fb.group({startDate:[t],endDate:[o],status:[null]})}ngOnInit(){this.filterForm.valueChanges.pipe(z(this.destroy$),we(400),ke((e,t)=>JSON.stringify(e)===JSON.stringify(t))).subscribe(()=>{this.applyFilters()})}applyFilters(){let e=this.filterForm.value,t={startDate:e.startDate?this.datePipe.transform(e.startDate,"yyyy-MM-dd"):null,endDate:e.endDate?this.datePipe.transform(e.endDate,"yyyy-MM-dd"):null,status:e.status||null};console.log("PlanningEventsFiltersComponent: Emitting filters",t),this.filtersChanged.emit(t)}clearFilters(){this.filterForm.reset({startDate:null,endDate:null,status:null})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=h({type:i,selectors:[["app-planning-events-filters"]],outputs:{filtersChanged:"filtersChanged"},features:[Be([Dt(),b])],decls:31,vars:7,consts:[["startDatePicker",""],["endDatePicker",""],[1,"filters-container",3,"formGroup"],["appearance","outline"],["matInput","","formControlName","startDate","placeholder","mm/dd/yyyy",3,"matDatepicker"],["matSuffix","",3,"for"],["matInput","","formControlName","endDate","placeholder","mm/dd/yyyy",3,"matDatepicker"],["formControlName","status","placeholder","Seleccione estado..."],[3,"value"],[3,"value",4,"ngFor","ngForOf"],[1,"filter-actions"],["mat-flat-button","","type","button",1,"btn-corp-primary",3,"click"],["mat-stroked-button","","type","button",1,"btn-corp-secondary",3,"click"]],template:function(t,o){if(t&1){let p=y();a(0,"form",2)(1,"mat-form-field",3)(2,"mat-label"),r(3,"Fecha de planificaci\xF3n inicio"),n(),_(4,"input",4)(5,"mat-datepicker-toggle",5)(6,"mat-datepicker",null,0),n(),a(8,"mat-form-field",3)(9,"mat-label"),r(10,"Fecha de planificaci\xF3n fin"),n(),_(11,"input",6)(12,"mat-datepicker-toggle",5)(13,"mat-datepicker",null,1),n(),a(15,"mat-form-field",3)(16,"mat-label"),r(17,"Estado"),n(),a(18,"mat-select",7)(19,"mat-option",8),r(20,"Todos"),n(),g(21,hn,2,2,"mat-option",9),n()(),a(22,"div",10)(23,"button",11),f("click",function(){return E(p),C(o.applyFilters())}),a(24,"mat-icon"),r(25,"search"),n(),r(26," Buscar "),n(),a(27,"button",12),f("click",function(){return E(p),C(o.clearFilters())}),a(28,"mat-icon"),r(29,"clear_all"),n(),r(30," Limpiar "),n()()()}if(t&2){let p=I(7),m=I(14);s("formGroup",o.filterForm),l(4),s("matDatepicker",p),l(),s("for",p),l(6),s("matDatepicker",m),l(),s("for",m),l(7),s("value",null),l(2),s("ngForOf",o.planningEventStatuses)}},dependencies:[P,B,st,at,tt,nt,it,ot,rt,dt,ct,pt,mt,ut,gt,qt,Xt,Jt,Qt,It,zt,$t,yt,x,D,M,V],styles:[".filters-container[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:20px;padding:20px;background-color:#f8f9fa;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 4px #0000000d}.mat-form-field[_ngcontent-%COMP%]{flex:1 1 auto;min-width:200px}.filter-actions[_ngcontent-%COMP%]{display:flex;gap:10px;align-items:center;margin-left:auto}.btn-corp-primary[_ngcontent-%COMP%]{background-color:#007bff;color:#fff}.btn-corp-secondary[_ngcontent-%COMP%]{border-color:#007bff;color:#007bff}"]})};var Mn=(i,e)=>({"success-message":i,"error-message":e});function bn(i,e){if(i&1&&(a(0,"span",16),r(1),n()),i&2){let t=v();l(),T(t.fileName)}}function Sn(i,e){if(i&1&&(a(0,"div",17)(1,"p"),r(2),n(),_(3,"mat-progress-bar",18),n()),i&2){let t=v();l(2),c("Importando archivo... ",t.uploadProgress,"%"),l(),s("value",t.uploadProgress)}}function yn(i,e){if(i&1&&(a(0,"div",25)(1,"mat-icon",26),r(2,"error_outline"),n(),a(3,"div",27),r(4),n()()),i&2){let t=e.$implicit;l(4),U(" Fila ",t.row,": ",t.message," ")}}function In(i,e){if(i&1&&(a(0,"div",22)(1,"h4"),r(2,"Detalles de Errores:"),n(),a(3,"mat-list",23),g(4,yn,5,2,"div",24),n()()),i&2){let t=v(2);l(4),s("ngForOf",t.importResult.errors)}}function Dn(i,e){if(i&1&&(a(0,"div",19)(1,"h3",20),r(2),n(),g(3,In,5,1,"div",21),n()),i&2){let t=v();l(),s("ngClass",He(3,Mn,t.importResult.success,!t.importResult.success)),l(),c(" ",t.importResult.message," "),l(),s("ngIf",t.importResult.errors&&t.importResult.errors.length>0)}}var On={ID_PLANIFICACION:"id_planificacion",FECHA_PLANIFICACION:"fecha_planificacion",ID_RUTA_PLANIFICADOR:"id_ruta_planificador",ID_CONDUCTOR:"id_conductor",ORDEN_PARADA:"orden_parada",ID_PEDIDO:"id_pedido",DIRECCION_ENTREGA:"direccion_entrega",HORA_ESTIMADA_LLEGADA:"hora_estimada_llegada"},fa=Object.keys(On),ue=class i{importCompleted=new S;selectedFile=null;fileName=null;isUploading=!1;uploadProgress=0;importResult=null;planningEventService=d(O);snackBar=d(j);dialogRef=d(vt);settingsService=d(Pt);destroy$=new F;enlace=null;constructor(){}ngOnInit(){}onFileSelected(e){let o=e.currentTarget.files;o&&o.length>0?(this.selectedFile=o[0],this.fileName=this.selectedFile.name,this.importResult=null,console.log("File selected:",this.selectedFile)):(this.selectedFile=null,this.fileName=null)}processImport(){return Ie(this,null,function*(){if(!this.selectedFile){this.snackBar.open("Por favor, selecciona un archivo Excel.","OK",{duration:3e3,panelClass:["warn-snackbar"]});return}this.isUploading=!0,this.uploadProgress=0,this.importResult=null;let e=setInterval(()=>{this.uploadProgress<90&&(this.uploadProgress+=10)},200);try{let t=yield this.readFileAndParseToJson(this.selectedFile);if(console.log("Parsed Excel to JSON:",t),t.length===0)throw new Error("El archivo Excel no contiene datos (despu\xE9s de las cabeceras) o el formato es incorrecto.");this.planningEventService.importPlanningEventsFromParsedJson(t).subscribe({next:o=>{clearInterval(e),this.uploadProgress=100,this.importResult=o,o.success&&o.importedCount&&o.importedCount>0?(this.snackBar.open(o.message,"OK",{duration:4e3,panelClass:["success-snackbar"]}),this.importCompleted.emit(!0)):(this.snackBar.open(o.message||"Algunos eventos de planificaci\xF3n no pudieron ser importados o hubo errores.","OK",{duration:6e3,panelClass:["warn-snackbar"]}),o.errors&&o.errors.length>0&&console.warn("Import errors from backend:",o.errors)),this.isUploading=!1},error:o=>{clearInterval(e),this.isUploading=!1,this.uploadProgress=0,this.importResult={success:!1,message:o.message||"Error en el servidor durante la importaci\xF3n."},this.snackBar.open(this.importResult.message,"OK",{duration:3e3,panelClass:["error-snackbar"]}),console.error("Error importing planning events:",o)}})}catch(t){clearInterval(e),this.isUploading=!1,this.uploadProgress=0,this.importResult={success:!1,message:t.message||"Error al procesar el archivo Excel."},this.snackBar.open(this.importResult.message,"OK",{duration:3e3,panelClass:["error-snackbar"]}),console.error("Error processing file:",t)}})}readFileAndParseToJson(e){return new Promise((t,o)=>{if(!e){o(new Error("No se proporcion\xF3 ning\xFAn archivo."));return}let p=new FileReader;p.onload=m=>{try{let u=m.target.result,be=Kt(u,{type:"binary",cellDates:!0}),Se=be.SheetNames[0];if(!Se){o(new Error("El archivo Excel no contiene hojas."));return}let Zt=be.Sheets[Se],en=Yt.sheet_to_json(Zt,{raw:!1,defval:null});t(en.filter(tn=>Object.values(tn).some(ye=>ye!==null&&ye!=="")))}catch(u){console.error("Error al leer el contenido de la hoja de Excel:",u),o(new Error("No se pudo leer el contenido de la hoja de Excel. Formato incorrecto."))}},p.onerror=m=>{console.error("Error en FileReader:",m),o(new Error("Ocurri\xF3 un error al intentar leer el archivo."))},p.readAsBinaryString(e)})}closeDialog(){this.dialogRef.close()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=h({type:i,selectors:[["app-planning-event-import-modal"]],outputs:{importCompleted:"importCompleted"},decls:69,vars:7,consts:[["fileInput",""],[1,"import-modal-container"],["mat-dialog-title",""],[1,"mat-typography"],[1,"instructions"],[2,"margin-bottom","10px"],[1,"column-descriptions"],[1,"file-input-container"],["mat-raised-button","",1,"btn-corp-primary",2,"height","60px",3,"click","disabled"],["hidden","","type","file","accept",".xlsx, .xls",3,"change"],["class","file-name-display",4,"ngIf"],["class","upload-progress-container",4,"ngIf"],["class","import-results",4,"ngIf"],["align","end"],["mat-stroked-button","",1,"btn-corp-secondary",3,"click","disabled"],["mat-flat-button","",1,"btn-corp-primary",3,"click","disabled"],[1,"file-name-display"],[1,"upload-progress-container"],["mode","determinate",3,"value"],[1,"import-results"],[3,"ngClass"],["class","error-details",4,"ngIf"],[1,"error-details"],["dense",""],["class","error-item",4,"ngFor","ngForOf"],[1,"error-item"],["matListItemIcon","","color","warn"],[2,"overflow-wrap","break-word !important"]],template:function(t,o){if(t&1){let p=y();a(0,"div",1)(1,"h2",2),r(2,"Importar Eventos de Planificaci\xF3n desde Excel"),n(),a(3,"mat-dialog-content",3)(4,"p",4),r(5," Sigue estos pasos para importar tus eventos de planificaci\xF3n de forma masiva: "),n(),a(6,"ol")(7,"li")(8,"div",5),r(9," Descarga la plantilla de Excel para asegurar el formato correcto de los datos. "),n()(),a(10,"li"),r(11," Completa la plantilla con la informaci\xF3n de tus eventos. Aseg\xFArate de que el orden y nombre de las columnas coincidan con la plantilla. "),n(),a(12,"li")(13,"strong"),r(14,"Descripci\xF3n de las Columnas Esperadas en la Plantilla:"),n(),a(15,"ul",6)(16,"li")(17,"strong"),r(18,"ID_PLANIFICACION:"),n(),r(19," Identificador \xFAnico de la planificaci\xF3n. "),n(),a(20,"li")(21,"strong"),r(22,"FECHA_PLANIFICACION:"),n(),r(23," Fecha de la planificaci\xF3n. Formato DD/MM/AAAA. "),n(),a(24,"li")(25,"strong"),r(26,"ID_RUTA_PLANIFICADOR:"),n(),r(27," Identificador de la ruta del planificador. "),n(),a(28,"li")(29,"strong"),r(30,"ID_CONDUCTOR:"),n(),r(31," Identificador del conductor asignado. "),n(),a(32,"li")(33,"strong"),r(34,"ORDEN_PARADA:"),n(),r(35," Orden de la parada en la ruta."),n(),a(36,"li")(37,"strong"),r(38,"ID_PEDIDO:"),n(),r(39," Identificador del pedido asociado. "),n(),a(40,"li")(41,"strong"),r(42,"DIRECCION_ENTREGA:"),n(),r(43," Direcci\xF3n de entrega del pedido. "),n(),a(44,"li")(45,"strong"),r(46,"HORA_ESTIMADA_LLEGADA:"),n(),r(47," Hora estimada de llegada. Formato HH:MM. "),n()()(),a(48,"li"),r(49,"Guarda el archivo en formato .xlsx o .xls."),n(),a(50,"li"),r(51,'Selecciona el archivo completo y haz clic en "Importar Eventos".'),n()(),a(52,"div",7)(53,"button",8),f("click",function(){E(p);let u=I(58);return C(u.click())}),a(54,"mat-icon"),r(55,"attach_file"),n(),r(56," Seleccionar Archivo Excel "),n(),a(57,"input",9,0),f("change",function(u){return E(p),C(o.onFileSelected(u))}),n(),g(59,bn,2,1,"span",10),n(),g(60,Sn,4,2,"div",11)(61,Dn,4,6,"div",12),n(),a(62,"mat-dialog-actions",13)(63,"button",14),f("click",function(){return E(p),C(o.closeDialog())}),r(64," Cerrar "),n(),a(65,"button",15),f("click",function(){return E(p),C(o.processImport())}),a(66,"mat-icon"),r(67,"upload"),n(),r(68),n()()()}t&2&&(l(53),s("disabled",o.isUploading),l(6),s("ngIf",o.fileName),l(),s("ngIf",o.isUploading),l(),s("ngIf",o.importResult),l(2),s("disabled",o.isUploading),l(2),s("disabled",!o.selectedFile||o.isUploading),l(3),c(" ",o.isUploading?"Importando...":"Importar Eventos"," "))},dependencies:[P,L,B,H,W,_t,Ct,Et,x,D,M,V,ie,ne,te,ee,Z,ae],styles:[".import-modal-container[_ngcontent-%COMP%]{padding:20px;min-width:400px}.instructions[_ngcontent-%COMP%]{margin-bottom:15px;line-height:1.5}ol[_ngcontent-%COMP%]{margin-bottom:20px;padding-left:20px}li[_ngcontent-%COMP%]{margin-bottom:10px}.template-button[_ngcontent-%COMP%]{margin-top:10px}.column-descriptions[_ngcontent-%COMP%]{list-style-type:disc;margin-left:20px;margin-top:10px}.column-descriptions[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin-bottom:5px}.file-input-container[_ngcontent-%COMP%]{display:flex;align-items:center;gap:15px;margin-top:20px;margin-bottom:20px}.file-name-display[_ngcontent-%COMP%]{font-style:italic;color:#555}.upload-progress-container[_ngcontent-%COMP%]{margin-top:20px;text-align:center}.import-results[_ngcontent-%COMP%]{margin-top:20px;padding:15px;border-radius:8px;background-color:#f0f0f0}.success-message[_ngcontent-%COMP%]{color:#4caf50;font-weight:700}.error-message[_ngcontent-%COMP%]{color:#f44336;font-weight:700}.error-details[_ngcontent-%COMP%]{margin-top:10px;border-top:1px solid #ccc;padding-top:10px}.error-item[_ngcontent-%COMP%]{display:flex;align-items:flex-start;margin-bottom:5px;word-break:break-word}.error-item[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{margin-right:8px;font-size:20px;line-height:1}.error-data-preview[_ngcontent-%COMP%]{font-family:monospace;background-color:#e0e0e0;padding:2px 5px;border-radius:3px;word-break:break-all}.btn-corp-primary[_ngcontent-%COMP%]{background-color:#007bff;color:#fff}.btn-corp-secondary[_ngcontent-%COMP%]{border-color:#007bff;color:#007bff}.warn-snackbar[_ngcontent-%COMP%]{background-color:#ffc107;color:#333}.success-snackbar[_ngcontent-%COMP%]{background-color:#28a745;color:#fff}.error-snackbar[_ngcontent-%COMP%]{background-color:#dc3545;color:#fff}"]})};var fe=class i{planningEventsService=d(O);router=d(ze);snackBar=d(j);dialog=d(Y);planningEvents=[];isLoading=!1;totalPlanningEventCount=0;currentPageIndex=0;currentPageSize=10;currentSortField="planningDate";currentSortDirection="desc";datePipe=d(b);now=new Date;firstDay=new Date(this.now.getFullYear(),this.now.getMonth(),1);lastDay=new Date(this.now.getFullYear(),this.now.getMonth()+1,0);filterCriteriaSubject=new De({startDate:this.datePipe.transform(this.firstDay,"yyyy-MM-dd"),endDate:this.datePipe.transform(this.lastDay,"yyyy-MM-dd"),status:null});destroy$=new F;constructor(){}ngOnInit(){this.filterCriteriaSubject.pipe(z(this.destroy$),Fe(()=>this.currentPageIndex=0)).subscribe(()=>{this.fetchPlanningEvents()})}fetchPlanningEvents(){this.isLoading=!0;let e=this.filterCriteriaSubject.value??1;this.planningEventsService.getPlanningEvents(e,this.currentPageIndex+1,this.currentPageSize,this.currentSortField,this.currentSortDirection).pipe(z(this.destroy$),R(t=>(this.snackBar.open(t.message||"Failed to load planning events.","Close",{duration:5e3,panelClass:["error-snackbar"]}),this.isLoading=!1,[]))).subscribe(t=>{this.planningEvents=t.items,this.totalPlanningEventCount=t.total_count||0,this.isLoading=!1,console.log("Planning Events fetched:",t)})}openImportModal(){let e=this.dialog.open(ue,{width:"90%",maxWidth:"700px",autoFocus:!1});e.componentInstance.importCompleted.subscribe(t=>{t&&(console.log("Import completed, reloading orders..."),this.fetchPlanningEvents())}),e.afterClosed().subscribe(t=>{console.log("The import dialog was closed",t)})}onFiltersChanged(e){console.log("PlanningEventsListPage: Filters changed",e),this.filterCriteriaSubject.next(e)}onPageChanged(e){console.log("PlanningEventsListPage: Page changed",e),this.currentPageIndex=e.pageIndex,this.currentPageSize=e.pageSize,this.fetchPlanningEvents()}onSortChanged(e){console.log("PlanningEventsListPage: Sort changed",e),this.currentSortField=e.active,this.currentSortDirection=e.direction,this.currentPageIndex=0,this.fetchPlanningEvents()}onViewDetails(e){this.router.navigate(["/planning-events",e])}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=h({type:i,selectors:[["app-planning-events-list-page"]],decls:12,vars:5,consts:[[1,"page-content-wrapper"],[1,"page-title-bar"],[1,"page-title"],[1,"breadcrumbs"],[3,"filtersChanged"],[1,"table-controls-bar"],[1,"records-info"],[1,"actions-group"],["mat-flat-button","",1,"btn-corp-primary",3,"click"],[3,"pageChanged","sortChanged","viewDetailsClicked","planningEvents","isLoading","totalCount","pageSize","pageIndex"]],template:function(t,o){t&1&&(a(0,"div",0)(1,"div",1)(2,"h1",2),r(3,"Listado de Planes de Ruta"),n(),_(4,"div",3),n(),a(5,"app-planning-events-filters",4),f("filtersChanged",function(m){return o.onFiltersChanged(m)}),n(),a(6,"div",5),_(7,"div",6),a(8,"div",7)(9,"button",8),f("click",function(){return o.openImportModal()}),r(10," Importar Nuevo Plan de Ruta "),n()()(),a(11,"app-planning-events-table",9),f("pageChanged",function(m){return o.onPageChanged(m)})("sortChanged",function(m){return o.onSortChanged(m)})("viewDetailsClicked",function(m){return o.onViewDetails(m)}),n()()),t&2&&(l(11),s("planningEvents",o.planningEvents)("isLoading",o.isLoading)("totalCount",o.totalPlanningEventCount)("pageSize",o.currentPageSize)("pageIndex",o.currentPageIndex))},dependencies:[P,X,q,x,D,M,K,Gt,re,se,me,ge],styles:[".page-content-wrapper[_ngcontent-%COMP%]{padding:20px}.page-title-bar[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.page-title[_ngcontent-%COMP%]{font-size:24px;font-weight:700;color:#333}.table-controls-bar[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.actions-group[_ngcontent-%COMP%]{display:flex;gap:10px}"]})};function wn(i,e){if(i&1){let t=y();a(0,"mat-list-item",14),f("click",function(){let p=E(t).$implicit,m=v(2);return C(m.selectRoute(p))}),a(1,"mat-icon",15),r(2,"person_pin"),n(),a(3,"div",16),r(4),n(),a(5,"div",17)(6,"span"),r(7),n(),a(8,"div",18)(9,"span"),r(10),n(),_(11,"mat-progress-bar",19),n()()()}if(i&2){let t=e.$implicit,o=v(2);Le("selected-route",t.id===(o.selectedRoute==null?null:o.selectedRoute.id)),l(4),c(" ",t.driverCode||"Sin Conductor"," "),l(3),T(t.vehicle||"Sin Veh\xEDculo"),l(3),U("",o.getCompletedStops(t)," / ",t.stops.length," Paradas"),l(),s("value",o.getRouteProgress(t))}}function kn(i,e){if(i&1&&(a(0,"div",21),_(1,"div",26),a(2,"div",27)(3,"span"),r(4),n()(),a(5,"div",23)(6,"strong"),r(7),n(),a(8,"p",28)(9,"span"),r(10),n(),r(11," | "),a(12,"span"),r(13),n(),r(14," - "),a(15,"span"),r(16),n(),r(17," | "),a(18,"span",29),r(19),n()()()()),i&2){let t=e.$implicit,o=v(3);l(2),s("ngClass",o.getStopStatusClass(t.order.status)),l(2),T(t.sequenceOrder),l(3),T(t.address),l(3),c("Pedido #",t.orderCode,""),l(3),c("Llegada: ",t.plannedStartTime,""),l(3),c("Salida: ",t.plannedEndTime,""),l(2),s("ngClass",o.getStopStatusClass(t.order.status)),l(),T(t.order.status)}}function Tn(i,e){if(i&1&&(a(0,"div",21),_(1,"div",26),a(2,"div",30)(3,"mat-icon"),r(4,"flag"),n()(),a(5,"div",23)(6,"strong"),r(7),n(),a(8,"p"),r(9),N(10,"date"),n()()()),i&2){let t=v(3);l(7),c("Destino: ",t.selectedRoute.completionPoint||"No definido",""),l(2),c(" Hora de Llegada Estimada: ",A(10,2,t.selectedRoute.vehicleEndTime,"shortTime")," ")}}function Fn(i,e){if(i&1&&(a(0,"mat-card")(1,"mat-card-header")(2,"mat-card-title"),r(3),n(),a(4,"mat-card-subtitle"),r(5),n()(),a(6,"mat-card-content")(7,"div",20)(8,"div",21)(9,"div",22)(10,"mat-icon"),r(11,"warehouse"),n()(),a(12,"div",23)(13,"strong"),r(14),n(),a(15,"p"),r(16),N(17,"date"),n()()(),g(18,kn,20,8,"div",24)(19,Tn,11,5,"div",25),n()()()),i&2){let t=v(2);l(3),c("Detalle de Ruta: ",t.selectedRoute.driverCode,""),l(2),c("Veh\xEDculo: ",t.selectedRoute.vehicle,""),l(9),c("Partida: ",t.selectedRoute.startingPoint||"No definido",""),l(2),c(" Hora de Salida Estimada: ",A(17,6,t.selectedRoute.vehicleStartTime,"shortTime")," "),l(2),s("ngForOf",t.selectedRoute.stops),l(),s("ngIf",t.selectedRoute.completionPoint)}}function Rn(i,e){i&1&&(a(0,"div",31)(1,"mat-icon"),r(2,"touch_app"),n(),a(3,"p"),r(4,"Selecciona una ruta de la lista para ver su detalle."),n()())}function Nn(i,e){if(i&1&&(a(0,"div",3)(1,"mat-card",4)(2,"mat-card-header")(3,"div",5)(4,"mat-icon"),r(5,"event_note"),n()(),a(6,"mat-card-title"),r(7),n(),a(8,"mat-card-subtitle"),r(9),N(10,"date"),n()(),a(11,"mat-card-actions",6)(12,"a",7)(13,"mat-icon"),r(14,"arrow_back"),n(),r(15," Volver a la Lista "),n()()(),a(16,"div",8)(17,"div",9)(18,"mat-card")(19,"mat-card-content")(20,"mat-list")(21,"h3",10),r(22,"Rutas de la Jornada"),n(),g(23,wn,12,7,"mat-list-item",11),n()()()(),a(24,"div",12),g(25,Fn,20,9,"mat-card",13)(26,Rn,5,0,"ng-template",null,1,Pe),n()()()),i&2){let t=I(27),o=v();l(7),U(" ","N\xB0: ","",o.planningEvent.planningEventIdExternal,""),l(2),c(" Planificaci\xF3n para el ",A(10,6,o.planningEvent.planningDate,"fullDate")," "),l(14),s("ngForOf",o.planningEvent.routes),l(2),s("ngIf",o.selectedRoute)("ngIfElse",t)}}function An(i,e){i&1&&_(0,"mat-spinner")}function Ln(i,e){i&1&&(a(0,"p"),r(1,"Cargando detalles de la planificaci\xF3n..."),n())}function Bn(i,e){if(i&1&&(a(0,"div",31),g(1,An,1,0,"mat-spinner",32)(2,Ln,2,0,"p",32),n()),i&2){let t=v();l(),s("ngIf",!t.planningEvent),l(),s("ngIf",!t.planningEvent)}}var ve=class i{route=d($e);planningEventService=d(O);routeSubscription;planningEvent=null;selectedRoute=null;pollingInterval;ngOnInit(){this.routeSubscription=this.route.paramMap.pipe(Te(e=>{let t=e.get("id");return t?this.planningEventService.getPlanningEventDetails(t):Oe(null)})).subscribe({next:e=>{e&&(this.planningEvent=e,this.planningEvent.routes&&this.planningEvent.routes.length>0?this.selectedRoute=this.planningEvent.routes[0]:this.selectedRoute=null,this.startPolling())},error:e=>{console.error("Error loading planning event details",e)}})}selectRoute(e){this.selectedRoute=e}getCompletedStops(e){return e.stops?e.stops.filter(t=>t.status==="COMPLETED").length:0}getRouteProgress(e){return!e.stops||e.stops.length===0?0:this.getCompletedStops(e)/e.stops.length*100}getStopStatusClass(e){return`status-${e}`}startPolling(){this.pollingInterval&&clearInterval(this.pollingInterval),this.pollingInterval=setInterval(()=>{this.refreshData()},3e4)}refreshData(){this.planningEvent?.id&&this.planningEventService.getPlanningEventDetails(this.planningEvent.id.toString()).subscribe({next:e=>{if(e){let t=this.selectedRoute?.id;this.planningEvent=e,this.selectedRoute=this.planningEvent.routes.find(o=>o.id===t)||(this.planningEvent.routes.length>0?this.planningEvent.routes[0]:null)}},error:e=>{console.error("Error refreshing planning event data",e)}})}ngOnDestroy(){this.routeSubscription&&this.routeSubscription.unsubscribe(),this.pollingInterval&&clearInterval(this.pollingInterval)}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=h({type:i,selectors:[["app-planning-event-detail-page"]],decls:3,vars:2,consts:[["loadingOrError",""],["noRouteSelected",""],["class","page-container",4,"ngIf","ngIfElse"],[1,"page-container"],[1,"page-header-card"],["mat-card-avatar","",1,"header-icon"],["align","end"],["mat-stroked-button","","routerLink","/planning-events",1,"btn-corp-primary"],[1,"detail-layout"],[1,"route-list-panel"],["mat-subheader",""],[3,"selected-route","click",4,"ngFor","ngForOf"],[1,"route-detail-panel"],[4,"ngIf","ngIfElse"],[3,"click"],["matListItemIcon",""],["matListItemTitle",""],["matListItemLine",""],[1,"progress-summary"],["mode","determinate",3,"value"],[1,"timeline"],[1,"timeline-item"],[1,"timeline-icon","start"],[1,"timeline-content"],["class","timeline-item",4,"ngFor","ngForOf"],["class","timeline-item",4,"ngIf"],[1,"timeline-connector"],[1,"timeline-icon",3,"ngClass"],[1,"stop-details"],[1,"status-text",3,"ngClass"],[1,"timeline-icon","end"],[1,"placeholder"],[4,"ngIf"]],template:function(t,o){if(t&1&&g(0,Nn,28,9,"div",2)(1,Bn,3,2,"ng-template",null,0,Pe),t&2){let p=I(2);s("ngIf",o.planningEvent)("ngIfElse",p)}},dependencies:[P,L,B,H,b,X,Ue,et,Je,Ye,Ze,qe,We,Ke,Qe,M,V,te,ee,bt,Z,St,Mt,xt,ie,ne,Q,J,x,ft],styles:["[_nghost-%COMP%]{display:block;padding:24px}.page-header-card[_ngcontent-%COMP%]{margin-bottom:24px}.header-icon[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;background-color:#f0f0f0;margin-right:16px}.header-icon[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:24px;color:#3f51b5}.detail-layout[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:24px}.route-list-panel[_ngcontent-%COMP%]{flex:1 1 350px;min-width:300px}.route-detail-panel[_ngcontent-%COMP%]{flex:2 1 500px}.mat-list-item[_ngcontent-%COMP%]{cursor:pointer;transition:background-color .3s ease;border-left:4px solid transparent;margin-bottom:8px;height:auto!important;padding-top:8px;padding-bottom:8px}.mat-list-item[_ngcontent-%COMP%]:hover{background-color:#f5f5f5}.selected-route[_ngcontent-%COMP%]{background-color:#e8eaf6;border-left-color:#3f51b5}.progress-summary[_ngcontent-%COMP%]{margin-top:8px;font-size:.8em;color:#666}.progress-summary[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:block;margin-bottom:4px}.placeholder[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:400px;color:#999}.placeholder[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:48px;width:48px;height:48px}.placeholder[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-top:16px}.timeline[_ngcontent-%COMP%]{position:relative;padding-left:30px}.timeline-item[_ngcontent-%COMP%]{position:relative;padding-bottom:20px}.timeline-connector[_ngcontent-%COMP%]{position:absolute;left:-16px;top:12px;width:2px;height:100%;background-color:#e0e0e0}.timeline-icon[_ngcontent-%COMP%]{position:absolute;left:-25px;top:0;width:24px;height:24px;border-radius:50%;background-color:#ccc;color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;border:2px solid white;z-index:1}.timeline-icon.start[_ngcontent-%COMP%], .timeline-icon.end[_ngcontent-%COMP%]{width:32px;height:32px;left:-29px}.timeline-icon.start[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%], .timeline-icon.end[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:20px}.timeline-icon.start[_ngcontent-%COMP%]{background-color:#4caf50}.timeline-icon.end[_ngcontent-%COMP%]{background-color:#f44336}.timeline-content[_ngcontent-%COMP%]{padding-left:20px}.timeline-content[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{display:block;font-weight:500}.timeline-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:4px 0 0;font-size:.9em;color:#666}.timeline-content[_ngcontent-%COMP%]   .stop-details[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:8px;align-items:center}.status-PENDIENTE[_ngcontent-%COMP%]{background-color:#9e9e9e}.status-ENTREGADO[_ngcontent-%COMP%]{background-color:#4caf50}.status-INCIDENCIA[_ngcontent-%COMP%]{background-color:#ff9800}.status-text.status-PENDIENTE[_ngcontent-%COMP%]{color:#9e9e9e}.status-text.status-ENTREGADO[_ngcontent-%COMP%]{color:#fff;font-weight:700}.status-text.status-INCIDENCIA[_ngcontent-%COMP%]{color:#ff9800;font-weight:700}"]})};var uo=[{path:"",component:fe},{path:":id",component:ve}];export{uo as PLANNING_EVENTS_ROUTES};
