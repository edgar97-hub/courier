import{a as ae}from"./chunk-GMV5DR2V.js";import{a as le,c as se}from"./chunk-INNR5TUR.js";import{d as Q,e as ee,i as te}from"./chunk-OMPPSW6K.js";import{a as ie,b as ne}from"./chunk-GDDGCRCE.js";import{a as oe,b as re}from"./chunk-3W245IEO.js";import{a as K,e as J,f as $,g as W,h as Y}from"./chunk-GXNIZWNA.js";import{b as Z}from"./chunk-4UMFQSK3.js";import{a as q}from"./chunk-3IGH7FBX.js";import{b as G,c as H,e as j}from"./chunk-2H2YZZAU.js";import{Bb as A,Db as p,Ea as M,Eb as x,Ec as V,Gd as X,Hd as z,Ia as b,Pb as F,Qb as e,Rb as w,Sb as O,Ta as P,Tb as N,Va as l,Za as T,ac as k,ba as I,cb as D,eb as R,h as v,ib as f,l as S,mb as s,na as u,uc as L,vb as i,vc as B,wa as g,wb as t,wc as U,xa as E,xb as y}from"./chunk-YUSEJVZ2.js";var ue=(a,r)=>({"success-message":a,"error-message":r});function ge(a,r){if(a&1&&(i(0,"span",17),e(1),t()),a&2){let o=x();l(),w(o.fileName)}}function Ee(a,r){if(a&1&&(i(0,"div",18)(1,"p"),e(2),t(),y(3,"mat-progress-bar",19),t()),a&2){let o=x();l(2),O("Importando archivo... ",o.uploadProgress,"%"),l(),s("value",o.uploadProgress)}}function fe(a,r){if(a&1&&(i(0,"div",26)(1,"mat-icon",27),e(2,"error_outline"),t(),i(3,"div",28),e(4),t()()),a&2){let o=r.$implicit;l(4),N(" Fila ",o.row,": ",o.message," ")}}function xe(a,r){if(a&1&&(i(0,"div",23)(1,"h4"),e(2,"Detalles de Errores:"),t(),i(3,"mat-list",24),f(4,fe,5,2,"div",25),t()()),a&2){let o=x(2);l(4),s("ngForOf",o.importResult.errors)}}function Oe(a,r){if(a&1&&(i(0,"div",20)(1,"h3",21),e(2),t(),f(3,xe,5,1,"div",22),t()),a&2){let o=x();l(),s("ngClass",k(3,ue,o.importResult.success,!o.importResult.success)),l(),O(" ",o.importResult.message," "),l(),s("ngIf",o.importResult.errors&&o.importResult.errors.length>0)}}var _e={"TIPO DE ENVIO":"type_order_transfer_to_warehouse","NOMBRE DEL DESTINATARIO":"recipient_name","TELEFONO DESTINATARIO 9 DIGITOS":"recipient_phone",DISTRITO:"delivery_district_name","DIRECCION DE ENTREGA":"delivery_address","FECHA DE ENTREGA (DIA/MES/A\xD1O)":"delivery_date","DETALLE DEL PRODUCTO":"item_description","MONTO A COBRAR":"amount_to_collect_at_delivery","FORMA DE PAGO":"payment_method_for_collection",OBSERVACION:"observations"},Xe=Object.keys(_e),de=class a{importCompleted=new M;selectedFile=null;fileName=null;isUploading=!1;uploadProgress=0;importResult=null;orderService=u(ae);snackBar=u(q);dialogRef=u(K);settingsService=u(Z);destroy$=new S;enlace=null;constructor(){}ngOnInit(){this.settingsService.loadSettings().pipe(I(this.destroy$)).subscribe({next:r=>{r.length&&(this.enlace=r[0].excel_import_template_url)},error:r=>{console.log("err",r)}})}onFileSelected(r){let n=r.currentTarget.files;n&&n.length>0?(this.selectedFile=n[0],this.fileName=this.selectedFile.name,this.importResult=null,console.log("File selected:",this.selectedFile)):(this.selectedFile=null,this.fileName=null)}downloadTemplate(){return this.snackBar.open("Plantilla con validaci\xF3n descargada.","OK",{duration:2e3}),this.enlace||""}processImport(){return v(this,null,function*(){if(!this.selectedFile){this.snackBar.open("Por favor, selecciona un archivo Excel.","OK",{duration:3e3,panelClass:["warn-snackbar"]});return}this.isUploading=!0,this.uploadProgress=0,this.importResult=null;let r=setInterval(()=>{this.uploadProgress<90&&(this.uploadProgress+=10)},200);try{let o=yield this.readFileAndParseToJson(this.selectedFile);if(o=o.filter(n=>n["DISTRITO (SELECCIONE SOLO DEL LISTADO)"]),console.log("Parsed Excel to JSON:",o),o.length===0)throw new Error("El archivo Excel no contiene datos (despu\xE9s de las cabeceras) o el formato es incorrecto.");this.orderService.importOrdersFromParsedJson(o).subscribe({next:n=>{clearInterval(r),this.uploadProgress=100,this.importResult=n,n.success&&n.importedCount&&n.importedCount>0?(this.snackBar.open(n.message,"OK",{duration:4e3,panelClass:["success-snackbar"]}),this.importCompleted.emit(!0)):(this.snackBar.open(n.message||"Algunos pedidos no pudieron ser importados o hubo errores.","OK",{duration:6e3,panelClass:["warn-snackbar"]}),n.errors&&n.errors.length>0&&console.warn("Import errors from backend:",n.errors)),this.isUploading=!1},error:n=>{clearInterval(r),this.isUploading=!1,this.uploadProgress=0,this.importResult={success:!1,message:n.message||"Error en el servidor durante la importaci\xF3n."},this.snackBar.open(this.importResult.message,"OK",{duration:3e3,panelClass:["error-snackbar"]}),console.error("Error importing orders:",n)}})}catch(o){clearInterval(r),this.isUploading=!1,this.uploadProgress=0,this.importResult={success:!1,message:o.message||"Error al procesar el archivo Excel."},this.snackBar.open(this.importResult.message,"OK",{duration:3e3,panelClass:["error-snackbar"]}),console.error("Error processing file:",o)}})}readFileAndParseToJson(r){return new Promise((o,n)=>{if(!r){n(new Error("No se proporcion\xF3 ning\xFAn archivo."));return}let d=new FileReader;d.onload=c=>{try{let m=c.target.result,_=le(m,{type:"binary",cellDates:!1}),h=_.SheetNames[0];if(!h){n(new Error("El archivo Excel no contiene hojas."));return}let me=_.Sheets[h],C=se.sheet_to_json(me,{raw:!1,defval:"",blankrows:!1});console.log(C),o(C)}catch(m){console.error("Error al leer el contenido de la hoja de Excel:",m),n(new Error("No se pudo leer el contenido de la hoja de Excel. Formato incorrecto."))}},d.onerror=c=>{console.error("Error en FileReader:",c),n(new Error("Ocurri\xF3 un error al intentar leer el archivo."))},d.readAsBinaryString(r)})}closeDialog(){this.dialogRef.close()}static \u0275fac=function(o){return new(o||a)};static \u0275cmp=D({type:a,selectors:[["app-order-import-modal"]],outputs:{importCompleted:"importCompleted"},decls:113,vars:8,consts:[["fileInput",""],[1,"import-modal-container"],["mat-dialog-title",""],[1,"mat-typography"],[1,"instructions"],[2,"margin-bottom","10px"],["mat-flat-button","","target","_blank","matTooltip","Descargar la plantilla en formato .xlsx (.xls tambi\xE9n soportado)",1,"template-button","btn-corp-primary",3,"href"],[1,"column-descriptions"],[1,"file-input-container"],["mat-raised-button","",1,"btn-corp-primary",2,"height","60px",3,"click","disabled"],["hidden","","type","file","accept",".xlsx, .xls",3,"change"],["class","file-name-display",4,"ngIf"],["class","upload-progress-container",4,"ngIf"],["class","import-results",4,"ngIf"],["align","end"],["mat-stroked-button","",1,"btn-corp-secondary",3,"click","disabled"],["mat-flat-button","",1,"btn-corp-primary",3,"click","disabled"],[1,"file-name-display"],[1,"upload-progress-container"],["mode","determinate",3,"value"],[1,"import-results"],[3,"ngClass"],["class","error-details",4,"ngIf"],[1,"error-details"],["dense",""],["class","error-item",4,"ngFor","ngForOf"],[1,"error-item"],["matListItemIcon","","color","warn"],[2,"overflow-wrap","break-word !important"]],template:function(o,n){if(o&1){let d=A();i(0,"div",1)(1,"h2",2),e(2,"Importar Pedidos desde Excel"),t(),i(3,"mat-dialog-content",3)(4,"p",4),e(5," Sigue estos pasos para importar tus pedidos de forma masiva: "),t(),i(6,"ol")(7,"li")(8,"div",5),e(9," Descarga la plantilla de Excel para asegurar el formato correcto de los datos. "),t(),i(10,"a",6)(11,"mat-icon"),e(12,"cloud_download"),t(),e(13," Descargar Plantilla "),t()(),i(14,"li"),e(15," Completa la plantilla con la informaci\xF3n de tus pedidos. Aseg\xFArate de que el orden y nombre de las columnas coincidan con la plantilla. "),t(),i(16,"li")(17,"strong"),e(18,"Descripci\xF3n de las Columnas Esperadas en la Plantilla:"),t(),i(19,"ul",7)(20,"li")(21,"strong"),e(22,"TIPO DE ENVIO:"),t(),e(23," Indica la modalidad del env\xEDo. Valores comunes: "),i(24,"code"),e(25,"CONTRAENTREGA"),t(),e(26,", "),i(27,"code"),e(28,"SOLO ENTREGAR"),t(),e(29,","),i(30,"code"),e(31,"CAMBIO"),t(),e(32,","),i(33,"code"),e(34,"RECOJO"),t(),e(35,". *(Esta columna podr\xEDa tener una lista desplegable en la plantilla).* "),t(),i(36,"li")(37,"strong"),e(38,"NOMBRE DEL DESTINATARIO:"),t(),e(39," Nombre completo de la persona que recibir\xE1 el pedido. "),t(),i(40,"li")(41,"strong"),e(42,"TELEFONO DESTINATARIO 9 DIGITOS:"),t(),e(43," N\xFAmero de celular del destinatario, debe contener exactamente 9 d\xEDgitos. "),t(),i(44,"li")(45,"strong"),e(46,"DISTRITO (SELECCIONE SOLO DEL LISTADO):"),t(),e(47," El distrito de entrega. Es crucial seleccionar uno de los distritos v\xE1lidos que se mostrar\xE1n en la lista desplegable de esta columna en la plantilla. "),t(),i(48,"li")(49,"strong"),e(50,"DIRECCION DE ENTREGA:"),t(),e(51," Direcci\xF3n completa y detallada donde se entregar\xE1 el pedido (calle, n\xFAmero, urbanizaci\xF3n, referencia, etc.). "),t(),i(52,"li")(53,"strong"),e(54,"FECHA DE ENTREGA (DIA/MES/A\xD1O):"),t(),e(55," Fecha programada para la entrega del pedido. Utiliza el formato DD/MM/AAAA (ej. 25/12/2023). "),t(),i(56,"li")(57,"strong"),e(58,"DETALLE DEL PRODUCTO:"),t(),e(59,' Descripci\xF3n breve pero clara de lo que se est\xE1 enviando (ej. "Ropa y Zapatillas", "Documentos Urgentes", "Regalo Sorpresa"). '),t(),i(60,"li")(61,"strong"),e(62,"MONTO A COBRAR:"),t(),e(63," Si el env\xEDo es "),i(64,"code"),e(65,"CONTRAENTREGA"),t(),e(66,", indica aqu\xED el monto exacto que el courier debe cobrar al destinatario. Si es "),i(67,"code"),e(68,"SOLO ENTREGAR"),t(),e(69,", este campo puede dejarse vac\xEDo o con 0. "),t(),i(70,"li")(71,"strong"),e(72,"FORMA DE PAGO:"),t(),e(73,' Indica c\xF3mo se realizar\xE1 el pago del "MONTO A COBRAR" si aplica. Ejemplos: '),i(74,"code"),e(75,"EFECTIVO"),t(),e(76,", "),i(77,"code"),e(78,"YAPE"),t(),e(79,", "),i(80,"code"),e(81,"PLIN"),t(),e(82,", "),i(83,"code"),e(84,"TRANSFERENCIA"),t(),e(85,". Si es no se realizar\xE1 cobro, puedes indicarlo con la opcion "),i(86,"code"),e(87,"NO COBRAR"),t()(),i(88,"li")(89,"strong"),e(90,"OBSERVACION:"),t(),e(91,' Cualquier nota o indicaci\xF3n adicional importante para el courier o para la gesti\xF3n del pedido (ej. "Entregar solo al titular", "Llamar antes de llegar", "Paquete fr\xE1gil"). '),t()()(),i(92,"li"),e(93,"Guarda el archivo en formato .xlsx o .xls."),t(),i(94,"li"),e(95,'Selecciona el archivo completo y haz clic en "Importar Pedidos".'),t()(),i(96,"div",8)(97,"button",9),p("click",function(){g(d);let m=F(102);return E(m.click())}),i(98,"mat-icon"),e(99,"attach_file"),t(),e(100," Seleccionar Archivo Excel "),t(),i(101,"input",10,0),p("change",function(m){return g(d),E(n.onFileSelected(m))}),t(),f(103,ge,2,1,"span",11),t(),f(104,Ee,4,2,"div",12)(105,Oe,4,6,"div",13),t(),i(106,"mat-dialog-actions",14)(107,"button",15),p("click",function(){return g(d),E(n.closeDialog())}),e(108," Cerrar "),t(),i(109,"button",16),p("click",function(){return g(d),E(n.processImport())}),i(110,"mat-icon"),e(111,"upload"),t(),e(112),t()()()}o&2&&(l(10),s("href",n.enlace,P),l(87),s("disabled",n.isUploading),l(6),s("ngIf",n.fileName),l(),s("ngIf",n.isUploading),l(),s("ngIf",n.importResult),l(2),s("disabled",n.isUploading),l(2),s("disabled",!n.selectedFile||n.isUploading),l(3),O(" ",n.isUploading?"Importando...":"Importar Pedidos"," "))},dependencies:[V,L,B,U,Y,J,W,$,j,H,G,z,X,ne,ie,te,ee,Q,re,oe],styles:[".import-modal-container[_ngcontent-%COMP%]{width:100%}mat-dialog-content[_ngcontent-%COMP%]{padding-top:0;line-height:1.6;font-size:.95em;overflow-y:auto}.instructions[_ngcontent-%COMP%]{margin-bottom:16px;font-weight:500}ol[_ngcontent-%COMP%]{padding-left:20px;margin-bottom:24px}ol[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin-bottom:12px}.template-button[_ngcontent-%COMP%]{margin-left:8px;vertical-align:middle;transform:translateY(-2px)}.file-input-container[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px;margin-bottom:24px;padding:16px;border:1px dashed #ccc;border-radius:4px;background-color:#f9f9f9}@media (max-width: 500px){.file-input-container[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.file-input-container[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%;margin-bottom:8px}}.file-name-display[_ngcontent-%COMP%]{font-style:italic;color:#555;word-break:break-all}.upload-progress-container[_ngcontent-%COMP%]{margin:20px 0}.upload-progress-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:8px;font-weight:500}.import-results[_ngcontent-%COMP%]{margin-top:24px;padding:16px;border-radius:4px;border:1px solid #ddd}.import-results[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-top:0;margin-bottom:12px;font-weight:600}.success-message[_ngcontent-%COMP%]{color:#2e7d32;border-left:4px solid #2e7d32;padding-left:12px}.error-message[_ngcontent-%COMP%]{color:#c62828;border-left:4px solid #c62828;padding-left:12px}.error-details[_ngcontent-%COMP%]{margin-top:16px}.error-details[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin-bottom:8px;font-size:1em;font-weight:500}.error-item[_ngcontent-%COMP%]{padding-bottom:8px!important;border-bottom:1px dotted #eee}.error-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.error-item[_ngcontent-%COMP%]   .mat-mdc-list-item-line[_ngcontent-%COMP%]{white-space:normal!important}.error-data-preview[_ngcontent-%COMP%]{font-size:.8em;color:#757575;display:block;margin-top:4px}mat-dialog-actions[_ngcontent-%COMP%]{padding:8px 24px 16px!important}@media (max-height: 600px){mat-dialog-content[_ngcontent-%COMP%]{max-height:55vh}}ol[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin-bottom:10px}.column-descriptions[_ngcontent-%COMP%]{list-style-type:disc;margin-top:8px;margin-bottom:16px;font-size:.9em;background-color:#f9f9f9;padding:10px 15px 10px 30px;border-radius:4px}.column-descriptions[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin-bottom:8px;line-height:1.5}.column-descriptions[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:#3f51b5}.column-descriptions[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]   code[_ngcontent-%COMP%]{background-color:#e0e0e0;padding:1px 4px;border-radius:3px;font-family:monospace}"]})};var ce=class a{constructor(r){this.el=r}alreadySelected=!1;onFocus(){this.selectText()}onClickOrTouch(){this.alreadySelected||(this.selectText(),this.alreadySelected=!0,setTimeout(()=>this.alreadySelected=!1,1e3))}selectText(){setTimeout(()=>{let r=this.el.nativeElement;r&&typeof r.select=="function"&&r.select()},0)}static \u0275fac=function(o){return new(o||a)(T(b))};static \u0275dir=R({type:a,selectors:[["","appAutoSelect",""]],hostBindings:function(o,n){o&1&&p("focus",function(){return n.onFocus()})("click",function(){return n.onClickOrTouch()})("touchend",function(){return n.onClickOrTouch()})}})};export{ce as a,de as b};
