import{a as Ot}from"./chunk-GJEYWMJR.js";import{a as It,b as wt,c as fe}from"./chunk-INNR5TUR.js";import{d as mt,e as pt,i as ct}from"./chunk-JBWENUMD.js";import{a as dt,b as ue}from"./chunk-GDDGCRCE.js";import{a as ut,b as gt,c as ft,d as ht,e as bt,f as _t,g as Ct,h as vt,i as Et,j as Dt,k as St,l as Rt,m as xt,n as Tt,p as yt}from"./chunk-V54F6JIJ.js";import{d as ge,e as Mt}from"./chunk-4CRKJGVD.js";import"./chunk-SNHOSZ4S.js";import"./chunk-BYXBJQAS.js";import{a as pe,b as nt,c as at,d as st,e as ce,f as de,g as lt,h as V}from"./chunk-GXNIZWNA.js";import"./chunk-JJSTB54W.js";import"./chunk-YRCWJJOQ.js";import{a as L}from"./chunk-K72O7MSM.js";import"./chunk-5PZ25QHJ.js";import{d as ae,e as se}from"./chunk-44LGRUYF.js";import{a as le,b as me}from"./chunk-3IGH7FBX.js";import"./chunk-7RWCIHFI.js";import{A as it,D as rt,G as oe,H as ne,b as ee,d as w,f as te,g as Qe,j as Je,l as Ke,m as We,n as Ye,o as Ze,r as et,v as tt,x as ie,z as re}from"./chunk-ICWTIKD4.js";import"./chunk-BWBG2IHT.js";import"./chunk-U3COC3EF.js";import{i as ze}from"./chunk-K4QNRRQ5.js";import{b as Ge}from"./chunk-ASKMK2H5.js";import{a as Xe}from"./chunk-XRPHOQB2.js";import{a as ot,b as B,e as P}from"./chunk-2H2YZZAU.js";import"./chunk-NUMYIFQH.js";import{$ as we,Ac as $e,Bb as A,Db as g,Ea as y,Eb as I,Ec as x,F as Te,Gd as M,Hd as T,I as J,J as ye,Jc as Re,Ka as O,Kb as j,Kc as je,Lb as H,Lc as He,Mb as q,Pb as Fe,Q as Ie,Qb as a,Rb as R,Sb as v,Sc as qe,Tb as Ne,Va as l,Yc as Z,Za as Oe,_b as ke,a as Se,ac as Ae,ba as K,bc as Be,cb as E,dc as Le,h as xe,ia as W,ib as u,l as $,lb as Pe,mb as p,na as d,t as Me,u as N,uc as Ve,vb as n,vc as Ue,wa as f,wb as o,wc as Y,xa as h,xb as C,yb as D,zb as S}from"./chunk-YUSEJVZ2.js";var F=class i{http=d(He);apiUrl=`${Z.apiUrl}/distributor-records`;authService=d(Xe);getAuthHeaders(){let e=this.authService.getAccessToken();return e?new Re({"Content-Type":"application/json",codrr_token:e}):new Re({"Content-Type":"application/json"})}getMyRegistrationsPaginated(e,t,r,s,m){let c=this.getAuthHeaders();if(!this.authService.getAccessToken())return N(()=>new Error("Not authenticated to fetch users."));let b=new je().set("page",e?.toString()).set("limit",t?.toString()).set("sortField",r).set("sortOrder",s);return m&&(b=b.set("search",m)),this.http.get(this.apiUrl,{params:b,headers:c})}createRegistration(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(this.apiUrl+"/create",e,{headers:t}):N(()=>new Error("Not authenticated to fetch users."))}updateRegistration(e,t){let r=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.patch(`${this.apiUrl}/${e}`,t,{headers:r}):N(()=>new Error("No autenticado para actualizar registro."))}deleteRegistration(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.delete(`${this.apiUrl}/${e}`,{headers:t}):N(()=>new Error("No autenticado para eliminar registro."))}importOrdersFromParsedJson(e){console.log("OrderService: Sending parsed JSON to backend for import",e);let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrl}/import-batch-json`,e,{headers:t}).pipe(J(this.handleImportError)):N(()=>new Error("Not authenticated to fetch users."))}handleImportError(e){console.error("API Import Error:",e);let t={success:!1,message:"Error de comunicaci\xF3n con el servidor durante la importaci\xF3n.",errors:[{row:0,message:`Error: ${e.status} - ${e.statusText||"Error desconocido"}`}]};return e.error&&typeof e.error=="object"&&"message"in e.error&&(t=Se(Se({},t),e.error)),N(()=>t)}downloadTemplate(){return this.http.get(`${this.apiUrl}/template`,{responseType:"blob"})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=W({token:i,factory:i.\u0275fac,providedIn:"root"})};var he=class i{searchChanged=new y;searchControl=new Je("");destroy$=new $;constructor(){}ngOnInit(){this.searchControl.valueChanges.pipe(ye(400),Ie(),K(this.destroy$)).subscribe(e=>{console.log("FilterToolbar: Search term changed to ->",e),this.searchChanged.emit(e||"")})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=E({type:i,selectors:[["app-filter-toolbar"]],outputs:{searchChanged:"searchChanged"},decls:7,vars:1,consts:[[1,"filter-containers"],["appearance","outline",1,"search-fields"],["matInput","","placeholder","Buscar por cliente, DNI, destino...",3,"formControl"],["matSuffix",""]],template:function(t,r){t&1&&(n(0,"div",0)(1,"mat-form-field",1)(2,"mat-label"),a(3,"Buscar..."),o(),C(4,"input",2),n(5,"mat-icon",3),a(6,"search"),o()()()),t&2&&(l(4),p("formControl",r.searchControl))},dependencies:[ie,ee,te,Ye,T,M,ne,oe,re,rt,se,ae],encapsulation:2})};var Vt=()=>[5,10,20];function Ut(i,e){i&1&&(n(0,"th",17),a(1,"N\xB0"),o())}function $t(i,e){if(i&1&&(n(0,"td",18),a(1),o()),i&2){let t=e.$implicit;l(),R(t.code)}}function jt(i,e){i&1&&(n(0,"th",17),a(1,"Remitente"),o())}function Ht(i,e){if(i&1&&(n(0,"td",18),a(1),o()),i&2){let t=e.$implicit;l(),R(t.user==null?null:t.user.username)}}function qt(i,e){i&1&&(n(0,"th",17),a(1,"Fecha Registro"),o())}function Xt(i,e){if(i&1&&(n(0,"td",18),a(1),Be(2,"date"),o()),i&2){let t=e.$implicit;l(),v(" ",Le(2,1,t.createdAt,"dd/MM/yyyy HH:mm")," ")}}function zt(i,e){i&1&&(n(0,"th",17),a(1,"Nombre Cliente"),o())}function Gt(i,e){if(i&1&&(n(0,"td",18),a(1),o()),i&2){let t=e.$implicit;l(),R(t.clientName)}}function Qt(i,e){i&1&&(n(0,"th",17),a(1,"DNI"),o())}function Jt(i,e){if(i&1&&(n(0,"td",18),a(1),o()),i&2){let t=e.$implicit;l(),R(t.clientDni)}}function Kt(i,e){i&1&&(n(0,"th",17),a(1,"Tel\xE9fono"),o())}function Wt(i,e){if(i&1&&(n(0,"td",18),a(1),o()),i&2){let t=e.$implicit;l(),R(t.clientPhone)}}function Yt(i,e){i&1&&(n(0,"th",17),a(1,"Destino"),o())}function Zt(i,e){if(i&1&&(n(0,"td",18),a(1),o()),i&2){let t=e.$implicit;l(),v(" ",t.destinationAddress," ")}}function ei(i,e){i&1&&(n(0,"th",17),a(1,"Observaci\xF3n"),o())}function ti(i,e){if(i&1&&(n(0,"td",18),a(1),o()),i&2){let t=e.$implicit;l(),v(" ",t.observation," ")}}function ii(i,e){i&1&&C(0,"tr",19)}function ri(i,e){i&1&&C(0,"tr",20)}function oi(i,e){if(i&1&&(n(0,"tr",21)(1,"td",22),a(2," A\xFAn no has creado ning\xFAn registro. "),o()()),i&2){let t=I();l(),Pe("colspan",t.displayedColumns.length)}}function ni(i,e){i&1&&(n(0,"th",17),a(1,"Acciones"),o())}function ai(i,e){if(i&1){let t=A();n(0,"td",18)(1,"div",23)(2,"button",24),g("click",function(){let s=f(t).$implicit,m=I();return h(m.onEdit(s))}),n(3,"mat-icon"),a(4,"edit"),o()(),n(5,"button",25),g("click",function(){let s=f(t).$implicit,m=I();return h(m.onDelete(s.id))}),n(6,"mat-icon"),a(7,"delete"),o()(),n(8,"button",26),g("click",function(){let s=f(t).$implicit,m=I();return h(m.onPrint(s.id))}),n(9,"mat-icon"),a(10,"print"),o()()()()}}var z=class i{registrationService=d(F);appStore=d(L);edit=new y;delete=new y;print=new y;showActions=!1;destroy$=new $;displayedColumns=["code","user","createdAt","clientName","clientDni","clientPhone","destinationAddress","observation"];dataSource=new xt;resultsLength=0;isLoadingResults=!0;paginator;sort;search$=new $;set searchTerm(e){this._searchTerm=e,this.paginator&&(this.paginator.pageIndex=0,console.log(this._searchTerm),this.search$.next(),this.fetchData())}_searchTerm="";ngOnInit(){let e=this.appStore.currentUser()?.role;(e==="ADMINISTRADOR"||e==="RECEPCIONISTA")&&(this.showActions=!0,this.displayedColumns.push("actions"))}ngAfterViewInit(){!this.sort||!this.paginator||(this.sort.sortChange.subscribe(()=>this.paginator.pageIndex=0),this.fetchData(),Te(this.sort.sortChange,this.paginator.page,this.search$).pipe(we({}),K(this.destroy$)).subscribe(()=>this.fetchData()))}onEdit(e){this.edit.emit(e)}onDelete(e){this.delete.emit(e)}onPrint(e){this.print.emit(e)}fetchData(){this.isLoadingResults=!0,this.registrationService.getMyRegistrationsPaginated(this.paginator.pageIndex+1,this.paginator.pageSize,this.sort?.active||"createdAt",this.sort?.direction.toUpperCase()||"DESC",this._searchTerm).pipe(J(()=>(this.isLoadingResults=!1,Me(null)))).subscribe(e=>{this.isLoadingResults=!1,e?(this.resultsLength=e.total,this.dataSource.data=e.data):(this.dataSource.data=[],this.resultsLength=0)})}reloadData(){this.paginator&&(this.paginator.pageIndex=0),this.fetchData()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=E({type:i,selectors:[["app-registrations-table"]],viewQuery:function(t,r){if(t&1&&(j(ge,5),j(Tt,5)),t&2){let s;H(s=q())&&(r.paginator=s.first),H(s=q())&&(r.sort=s.first)}},inputs:{searchTerm:"searchTerm"},outputs:{edit:"edit",delete:"delete",print:"print"},decls:33,vars:7,consts:[[1,"table-container","mat-elevation-z4"],["mat-table","",3,"dataSource"],["matColumnDef","code"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","user"],["matColumnDef","createdAt"],["matColumnDef","clientName"],["matColumnDef","clientDni"],["matColumnDef","clientPhone"],["matColumnDef","destinationAddress"],["matColumnDef","observation"],["mat-header-row","",4,"matHeaderRowDef","matHeaderRowDefSticky"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","mat-row",4,"matNoDataRow"],["matColumnDef","actions"],["aria-label","Seleccionar p\xE1gina de registros",3,"length","pageSizeOptions"],["mat-header-cell",""],["mat-cell",""],["mat-header-row",""],["mat-row",""],[1,"mat-row"],[1,"mat-cell"],[2,"display","flex","gap","10px !important"],["mat-icon-button","","matTooltip","Editar Registro",3,"click"],["mat-icon-button","","color","warn","matTooltip","Eliminar Registro",3,"click"],["mat-icon-button","","matTooltip","Imprimir R\xF3tulo",3,"click"]],template:function(t,r){t&1&&(n(0,"div",0)(1,"table",1),D(2,2),u(3,Ut,2,0,"th",3)(4,$t,2,1,"td",4),S(),D(5,5),u(6,jt,2,0,"th",3)(7,Ht,2,1,"td",4),S(),D(8,6),u(9,qt,2,0,"th",3)(10,Xt,3,4,"td",4),S(),D(11,7),u(12,zt,2,0,"th",3)(13,Gt,2,1,"td",4),S(),D(14,8),u(15,Qt,2,0,"th",3)(16,Jt,2,1,"td",4),S(),D(17,9),u(18,Kt,2,0,"th",3)(19,Wt,2,1,"td",4),S(),D(20,10),u(21,Yt,2,0,"th",3)(22,Zt,2,1,"td",4),S(),D(23,11),u(24,ei,2,0,"th",3)(25,ti,2,1,"td",4),S(),u(26,ii,1,0,"tr",12)(27,ri,1,0,"tr",13)(28,oi,3,1,"tr",14),D(29,15),u(30,ni,2,0,"th",3)(31,ai,11,0,"td",4),S(),o(),C(32,"mat-paginator",16),o()),t&2&&(l(),p("dataSource",r.dataSource),l(25),p("matHeaderRowDef",r.displayedColumns)("matHeaderRowDefSticky",!0),l(),p("matRowDefColumns",r.displayedColumns),l(5),p("length",r.resultsLength)("pageSizeOptions",ke(6,Vt)))},dependencies:[x,$e,Rt,ut,ft,Ct,ht,gt,vt,bt,_t,Et,Dt,St,Mt,ge,yt,Ge,T,M],styles:[".table-container[_ngcontent-%COMP%]{width:100%;overflow-x:auto;border-radius:8px}table[_ngcontent-%COMP%]{width:100%}"]})};function si(i,e){i&1&&(n(0,"mat-error"),a(1,"El nombre es requerido."),o())}function li(i,e){i&1&&(n(0,"mat-error"),a(1,"El DNI es requerido."),o())}function mi(i,e){i&1&&(n(0,"mat-error"),a(1,"Debe contener 8 d\xEDgitos."),o())}function pi(i,e){i&1&&(n(0,"mat-error"),a(1,"El tel\xE9fono es requerido."),o())}function ci(i,e){i&1&&(n(0,"mat-error"),a(1,"Debe contener 9 d\xEDgitos."),o())}function di(i,e){i&1&&(n(0,"mat-error"),a(1,"El destino es requerido."),o())}function ui(i,e){i&1&&(n(0,"mat-error"),a(1,"La direcci\xF3n es muy corta."),o())}var _e=class i{initialData=null;isEditMode=!1;formSubmit=new y;formCancel=new y;fb=d(tt);form;constructor(){this.form=this.fb.group({clientName:["",[w.required,w.minLength(3)]],clientDni:["",[w.required,w.minLength(8)]],clientPhone:["",[w.required,w.minLength(9)]],observation:[""],destinationAddress:["",[w.required,w.minLength(5)]]})}ngOnInit(){this.initialData&&this.form.patchValue(this.initialData)}onSubmit(){this.form.valid&&(this.formSubmit.emit(this.form.value),this.form.reset(),Object.keys(this.form.controls).forEach(e=>{this.form.get(e)?.setErrors(null),this.form.get(e)?.markAsUntouched()}))}onCancelClick(){this.formCancel.emit()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=E({type:i,selectors:[["app-registration-form"]],inputs:{initialData:"initialData",isEditMode:"isEditMode"},outputs:{formSubmit:"formSubmit",formCancel:"formCancel"},decls:36,vars:11,consts:[[1,"registration-form",3,"ngSubmit","formGroup"],[1,"form-grid"],["appearance","outline"],["matInput","","formControlName","clientName","placeholder","Ej: Juan P\xE9rez","cdkFocusInitial",""],[4,"ngIf"],["matInput","","formControlName","clientDni","type","number","placeholder","8 d\xEDgitos"],["matInput","","formControlName","clientPhone","type","tel","placeholder","9 d\xEDgitos"],["appearance","outline",1,"full-width"],["matInput","","formControlName","destinationAddress","placeholder","Ej: Av. Javier Prado 123, San Isidro, Lima","rows","3"],["matInput","","formControlName","observation","placeholder",""],[1,"form-actions"],["mat-stroked-button","","type","button",1,"btn-corp-secondary",2,"padding","25px !important",3,"click"],["mat-raised-button","","color","primary","type","submit",1,"btn-corp-primary",2,"padding","25px !important",3,"disabled"]],template:function(t,r){if(t&1&&(n(0,"form",0),g("ngSubmit",function(){return r.onSubmit()}),n(1,"div",1)(2,"mat-form-field",2)(3,"mat-label"),a(4,"Nombre de Cliente"),o(),C(5,"input",3),u(6,si,2,0,"mat-error",4),o(),n(7,"mat-form-field",2)(8,"mat-label"),a(9,"DNI"),o(),C(10,"input",5),u(11,li,2,0,"mat-error",4)(12,mi,2,0,"mat-error",4),o(),n(13,"mat-form-field",2)(14,"mat-label"),a(15,"Tel\xE9fono"),o(),C(16,"input",6),u(17,pi,2,0,"mat-error",4)(18,ci,2,0,"mat-error",4),o(),n(19,"mat-form-field",7)(20,"mat-label"),a(21,"Destino (Direcci\xF3n Completa)"),o(),C(22,"textarea",8),u(23,di,2,0,"mat-error",4)(24,ui,2,0,"mat-error",4),o(),n(25,"mat-form-field",7)(26,"mat-label"),a(27,"Observaci\xF3n"),o(),C(28,"input",9),o()(),n(29,"div",10)(30,"button",11),g("click",function(){return r.onCancelClick()}),a(31," Cancelar "),o(),n(32,"button",12)(33,"mat-icon"),a(34),o(),a(35),o()()()),t&2){let s,m,c,b,Q,U,De;p("formGroup",r.form),l(6),p("ngIf",(s=r.form.get("clientName"))==null?null:s.hasError("required")),l(5),p("ngIf",(m=r.form.get("clientDni"))==null?null:m.hasError("required")),l(),p("ngIf",(c=r.form.get("clientDni"))==null?null:c.hasError("pattern")),l(5),p("ngIf",(b=r.form.get("clientPhone"))==null?null:b.hasError("required")),l(),p("ngIf",(Q=r.form.get("clientPhone"))==null?null:Q.hasError("pattern")),l(5),p("ngIf",(U=r.form.get("destinationAddress"))==null?null:U.hasError("required")),l(),p("ngIf",(De=r.form.get("destinationAddress"))==null?null:De.hasError("minlength")),l(8),p("disabled",r.form.invalid),l(2),R(r.isEditMode?"save":"add"),l(),v(" ",r.isEditMode?"Guardar Cambios":"A\xF1adir Registro"," ")}},dependencies:[x,Y,ie,Ke,ee,We,te,Qe,Ze,et,ne,oe,re,it,se,ae,P,B,T,M],styles:[".registration-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-top:20px}.form-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}.full-width[_ngcontent-%COMP%]{grid-column:1/-1}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:8px;margin-top:24px}"]})};var G=class i{constructor(e){this.data=e;e&&e.registration?(this.isEditMode=!0,this.registrationData=e.registration):(this.isEditMode=!1,this.registrationData=null)}dialogRef=d(pe);isEditMode;registrationData;onFormSubmit(e){this.dialogRef.close(e)}onCancel(){this.dialogRef.close()}static \u0275fac=function(t){return new(t||i)(Oe(nt))};static \u0275cmp=E({type:i,selectors:[["app-registration-form-dialog"]],decls:4,vars:3,consts:[["mat-dialog-title",""],[3,"formSubmit","formCancel","initialData","isEditMode"]],template:function(t,r){t&1&&(n(0,"h2",0),a(1),o(),n(2,"mat-dialog-content")(3,"app-registration-form",1),g("formSubmit",function(m){return r.onFormSubmit(m)})("formCancel",function(){return r.onCancel()}),o()()),t&2&&(l(),v(" ",r.isEditMode?"Editar":"Nuevo"," Datos de Envio "),l(2),p("initialData",r.registrationData)("isEditMode",r.isEditMode))},dependencies:[x,V,ce,de,P,_e],encapsulation:2})};var fi=(i,e)=>({"success-message":i,"error-message":e});function hi(i,e){if(i&1&&(n(0,"div",13)(1,"span"),a(2,"Archivo listo para importar: "),n(3,"strong"),a(4),o()()()),i&2){let t,r=I();l(4),R((t=r.selectedFile())==null?null:t.name)}}function bi(i,e){i&1&&(n(0,"div",14)(1,"p"),a(2,"Procesando archivo, por favor espera..."),o(),C(3,"mat-progress-bar",15),o())}function _i(i,e){if(i&1&&(n(0,"div",22)(1,"mat-icon",23),a(2,"error_outline"),o(),n(3,"span"),a(4),o()()),i&2){let t=e.$implicit;l(4),Ne("Fila ",t.row,": ",t.message,"")}}function Ci(i,e){if(i&1&&(n(0,"div",19)(1,"h4"),a(2,"Detalles de Errores:"),o(),n(3,"mat-list",20),u(4,_i,5,2,"div",21),o()()),i&2){let t,r=I(2);l(4),p("ngForOf",(t=r.importResult())==null?null:t.errors)}}function vi(i,e){if(i&1&&(n(0,"div",16)(1,"h3",17),a(2),o(),u(3,Ci,5,1,"div",18),o()),i&2){let t,r,s,m=I();l(),p("ngClass",Ae(3,fi,(t=m.importResult())==null?null:t.success,!((t=m.importResult())!=null&&t.success))),l(),v(" ",(r=m.importResult())==null?null:r.message," "),l(),p("ngIf",((s=m.importResult())==null?null:s.errors)&&((s=m.importResult())==null||s.errors==null?null:s.errors.length)>0)}}var Ei={"NOMBRE DE CLIENTE":"clientName",DNI:"clientDni",TEL\u00C9FONO:"clientPhone",DESTINO:"destinationAddress",OBSERVACION:"observation"},Di=Object.keys(Ei),Ce=class i{registrationService=d(F);snackBar=d(le);dialogRef=d(pe);selectedFile=O(null);isProcessing=O(!1);importResult=O(null);onFileSelected(e){let t=e.target;t.files&&t.files.length>0&&(this.selectedFile.set(t.files[0]),this.importResult.set(null))}onDownloadTemplate(){try{let r=[["NOMBRE DE CLIENTE","DNI","TEL\xC9FONO","DESTINO","OBSERVACION"],...[{"NOMBRE DE CLIENTE":"Juan P\xE9rez Garc\xEDa",DNI:"12345678",TEL\u00C9FONO:"987654321",DESTINO:"Av. Javier Prado Este 123, San Isidro, Lima, Per\xFA",OBSERVACION:""}].map(b=>[b["NOMBRE DE CLIENTE"],b.DNI,b.TEL\u00C9FONO,b.DESTINO,b.OBSERVACION])],s=fe.aoa_to_sheet(r);s["!cols"]=[{wch:30},{wch:15},{wch:15},{wch:50},{wch:50}];let c=wt({Sheets:{Registros:s},SheetNames:["Registros"]},{bookType:"xlsx",type:"array"});this.saveAsExcelFile(c,"plantilla_registros_distribuidor"),this.snackBar.open("Descargando plantilla...","OK",{duration:2e3})}catch(e){console.error("Error al generar la plantilla de Excel:",e),this.snackBar.open("Error al generar la plantilla.","Cerrar")}}saveAsExcelFile(e,t){let r=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8"}),s=document.createElement("a"),m=URL.createObjectURL(r);s.href=m,s.download=`${t}.xlsx`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(m)}processImport(){return xe(this,null,function*(){let e=this.selectedFile();if(!e){this.snackBar.open("Por favor, selecciona un archivo Excel.","Cerrar");return}this.isProcessing.set(!0),this.importResult.set(null);try{let t=yield this.readFileAndParse(e);if(t.length===0)throw new Error("El archivo Excel no contiene filas de datos v\xE1lidas.");this.registrationService.importOrdersFromParsedJson(t).subscribe({next:r=>{this.importResult.set(r),this.isProcessing.set(!1),r.success&&(this.snackBar.open(r.message,"OK",{duration:4e3}),setTimeout(()=>this.dialogRef.close(!0),2e3))},error:r=>{let s=r.error?.message||["Error desconocido del servidor."];this.importResult.set({success:!1,message:"El archivo contiene datos inv\xE1lidos. Por favor, revisa los errores.",errors:Array.isArray(s)?s.map((m,c)=>({row:c+2,message:m})):[{row:0,message:s}]}),this.isProcessing.set(!1)}})}catch(t){this.importResult.set({success:!1,message:t.message}),this.isProcessing.set(!1)}})}readFileAndParse(e){return new Promise((t,r)=>{let s=new FileReader;s.onload=m=>{try{let c=It(m.target.result,{type:"binary"}),b=c.Sheets[c.SheetNames[0]],Q=(fe.sheet_to_json(b,{header:1})[0]||[]).map(_=>_.trim().toUpperCase()),U=Di.filter(_=>!Q.includes(_));if(U.length>0)return r(new Error(`Cabeceras faltantes o incorrectas en el Excel: ${U.join(", ")}`));let kt=fe.sheet_to_json(b).map(_=>({clientName:_["NOMBRE DE CLIENTE"]?.toString().trim()||"",clientDni:_.DNI?.toString().trim()||"",clientPhone:_.TEL\u00C9FONO?.toString().trim()||"",destinationAddress:_.DESTINO?.toString().trim()||"",observation:_.OBSERVACION?.toString().trim()||""})).filter(_=>_.clientName||_.clientDni||_.clientPhone||_.destinationAddress||_.observation);t(kt)}catch{r(new Error("No se pudo leer el archivo Excel. Aseg\xFArate de que el formato sea correcto."))}},s.onerror=()=>r(new Error("Ocurri\xF3 un error al leer el archivo.")),s.readAsBinaryString(e)})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=E({type:i,selectors:[["app-distributor-import-dialog"]],decls:33,vars:9,consts:[["fileInput",""],["mat-dialog-title",""],[1,"mat-typography"],[1,"dialog-actions"],["mat-stroked-button","",1,"btn-corp-secondary",3,"click"],["mat-stroked-button","",1,"btn-corp-primary",3,"click","disabled"],["hidden","","type","file","accept",".xlsx, .xls, .csv",3,"change"],["class","file-info",4,"ngIf"],["class","upload-progress-container",4,"ngIf"],["class","import-results",4,"ngIf"],["align","center",2,"gap","10px"],["mat-button","",1,"btn-corp-secondary",3,"mat-dialog-close","disabled"],["mat-raised-button","","color","primary",1,"btn-corp-primary",3,"click","disabled"],[1,"file-info"],[1,"upload-progress-container"],["mode","indeterminate"],[1,"import-results"],[3,"ngClass"],["class","error-details",4,"ngIf"],[1,"error-details"],["dense",""],["class","error-item",4,"ngFor","ngForOf"],[1,"error-item"],["matListItemIcon","","color","warn"]],template:function(t,r){if(t&1){let s=A();n(0,"h2",1),a(1,"Importaci\xF3n Masiva de Registros"),o(),n(2,"mat-dialog-content",2)(3,"p"),a(4,"Sigue estos pasos para importar tus registros desde un archivo Excel:"),o(),n(5,"ol")(6,"li"),a(7," Descarga nuestra plantilla para asegurar que las columnas tengan el formato correcto. "),o(),n(8,"li"),a(9,"Llena la plantilla con los datos de tus registros."),o(),n(10,"li"),a(11,'Guarda el archivo y s\xFAbelo usando el bot\xF3n "Seleccionar Archivo".'),o()(),n(12,"div",3)(13,"button",4),g("click",function(){return f(s),h(r.onDownloadTemplate())}),n(14,"mat-icon"),a(15,"download"),o(),a(16," Descargar Plantilla "),o(),n(17,"button",5),g("click",function(){f(s);let c=Fe(22);return h(c.click())}),n(18,"mat-icon"),a(19,"attach_file"),o(),a(20," Seleccionar Archivo "),o(),n(21,"input",6,0),g("change",function(c){return f(s),h(r.onFileSelected(c))}),o()(),u(23,hi,5,1,"div",7)(24,bi,4,0,"div",8)(25,vi,4,6,"div",9),o(),n(26,"mat-dialog-actions",10)(27,"button",11),a(28),o(),n(29,"button",12),g("click",function(){return f(s),h(r.processImport())}),n(30,"mat-icon"),a(31,"upload"),o(),a(32),o()()}if(t&2){let s;l(17),p("disabled",r.isProcessing()),l(6),p("ngIf",r.selectedFile()&&!r.isProcessing()),l(),p("ngIf",r.isProcessing()),l(),p("ngIf",r.importResult()),l(2),p("mat-dialog-close",!1)("disabled",r.isProcessing()),l(),v(" ",(s=r.importResult())!=null&&s.success?"Cerrar":"Cancelar"," "),l(),p("disabled",!r.selectedFile()||r.isProcessing()),l(3),v(" ",r.isProcessing()?"Importando...":"Confirmar Importaci\xF3n"," ")}},dependencies:[x,Ve,Ue,Y,V,st,ce,lt,de,P,B,T,M,ue,dt,ct,pt,mt,me],styles:[".dialog-actions[_ngcontent-%COMP%]{display:flex;gap:16px;margin:24px 0;justify-content:center;flex-wrap:wrap}.file-info[_ngcontent-%COMP%]{text-align:center;font-style:italic;color:#3f51b5;margin-top:16px;font-weight:500}.upload-progress-container[_ngcontent-%COMP%]{margin-top:20px;text-align:center}.import-results[_ngcontent-%COMP%]{margin-top:20px;padding:16px;border-radius:4px}.import-results[_ngcontent-%COMP%]   .success-message[_ngcontent-%COMP%]{color:#2e7d32;background-color:#e8f5e9;padding:8px;border-radius:4px}.import-results[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{color:#c62828;background-color:#ffebee;padding:8px;border-radius:4px}.error-details[_ngcontent-%COMP%]{margin-top:16px;max-height:200px;overflow-y:auto;border:1px solid #ffcdd2;padding:8px}.error-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:.9em}"]})};var ve=class i{registrationService=d(F);snackBar=d(le);dialog=d(at);appStore=d(L);registrationsTable;searchTerm=O("");isUploading=O(!1);isAdminOrReceptionist=O(!1);onRefreshTable(){this.snackBar.open("Actualizando lista de registros...","",{duration:2e3}),this.registrationsTable&&this.registrationsTable.reloadData()}ngAfterViewInit(){this.onRefreshTable();let e=this.appStore.currentUser()?.role;(e==="ADMINISTRADOR"||e==="RECEPCIONISTA")&&this.isAdminOrReceptionist.set(!0)}onSearchChanged(e){console.log("term",e),this.searchTerm.set(e)}openManualRegistrationDialog(){this.dialog.open(G,{width:"600px",disableClose:!0}).afterClosed().subscribe(t=>{t&&this.registrationService.createRegistration(t).subscribe({next:()=>{this.snackBar.open("Registro creado con \xE9xito.","OK",{duration:3e3}),this.registrationsTable&&this.registrationsTable.reloadData()},error:r=>this.snackBar.open(`Error al crear el registro: ${r.message}`,"Cerrar")})})}handleEdit(e){this.dialog.open(G,{width:"600px",disableClose:!0,data:{registration:e}}).afterClosed().subscribe(r=>{r&&this.registrationService.updateRegistration(e.id,r).subscribe({next:()=>{this.snackBar.open("Registro actualizado con \xE9xito.","OK",{duration:3e3}),this.registrationsTable.reloadData()},error:s=>this.snackBar.open(`Error al actualizar: ${s.message}`,"Cerrar")})})}handleDelete(e){let t={title:"Confirmar Eliminaci\xF3n",message:"\xBFEst\xE1s seguro de que quieres eliminar este registro? Esta acci\xF3n no se puede deshacer.",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar",confirmButtonColor:"warn"};this.dialog.open(Ot,{data:t}).afterClosed().subscribe(s=>{s&&this.registrationService.deleteRegistration(e).subscribe({next:()=>{this.snackBar.open("Registro eliminado con \xE9xito.","OK",{duration:3e3}),this.registrationsTable.reloadData()},error:m=>this.snackBar.open(`Error al eliminar: ${m.message}`,"Cerrar")})})}handlePrint(e){let t=Z.apiUrl+"/distributor-records/"+e+"/pdf-rotulado";window.open(t,"_blank")}openMassiveImportDialog(){this.dialog.open(Ce,{width:"600px",disableClose:!0}).afterClosed().subscribe(t=>{t&&this.onRefreshTable()})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=E({type:i,selectors:[["app-registration-page"]],viewQuery:function(t,r){if(t&1&&j(z,5),t&2){let s;H(s=q())&&(r.registrationsTable=s.first)}},decls:23,vars:2,consts:[["registrationsTable",""],[1,"page-container"],[1,"header"],[1,"page-title"],[1,"header-actions"],["mat-stroked-button","",1,"btn-corp-secondary",3,"click"],["mat-raised-button","","color","primary",1,"btn-corp-primary",3,"click"],[1,"history-section"],[1,"filter-controls"],[3,"searchChanged"],["mat-icon-button","","matTooltip","Actualizar la lista",1,"refresh-button","btn-corp-primary",3,"click"],[3,"edit","delete","print","searchTerm"]],template:function(t,r){if(t&1){let s=A();n(0,"div",1)(1,"div",2)(2,"h1",3),a(3),o(),n(4,"div",4)(5,"button",5),g("click",function(){return f(s),h(r.openMassiveImportDialog())}),n(6,"mat-icon"),a(7,"upload_file"),o(),n(8,"span"),a(9,"Importar desde Excel"),o()(),n(10,"button",6),g("click",function(){return f(s),h(r.openManualRegistrationDialog())}),n(11,"mat-icon"),a(12,"add"),o(),n(13,"span"),a(14,"Nuevo Registro"),o()()()(),n(15,"div",7)(16,"div",8)(17,"app-filter-toolbar",9),g("searchChanged",function(c){return f(s),h(r.onSearchChanged(c))}),o(),n(18,"button",10),g("click",function(){return f(s),h(r.onRefreshTable())}),n(19,"mat-icon"),a(20,"refresh"),o()()(),n(21,"app-registrations-table",11,0),g("edit",function(c){return f(s),h(r.handleEdit(c))})("delete",function(c){return f(s),h(r.handleDelete(c))})("print",function(c){return f(s),h(r.handlePrint(c))}),o()()()}t&2&&(l(3),v(" ",r.isAdminOrReceptionist()?"Gesti\xF3n de Registros de Envio":"Mis Registros de Distribuidor"," "),l(18),p("searchTerm",r.searchTerm()))},dependencies:[x,ze,P,B,ot,T,M,me,ue,V,he,z],styles:[".page-container[_ngcontent-%COMP%]{padding:24px}.header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:24px}.page-title[_ngcontent-%COMP%]{margin:0}.header-actions[_ngcontent-%COMP%]{display:flex;gap:16px;flex-shrink:0}.history-section[_ngcontent-%COMP%]{margin-top:24px}.filter-controls[_ngcontent-%COMP%]{display:flex;gap:16px;justify-content:center;margin-bottom:16px}.filter-controls[_ngcontent-%COMP%]   app-filter-toolbar[_ngcontent-%COMP%]{flex-grow:1}@media (max-width: 768px){.page-container[_ngcontent-%COMP%]{padding:16px}.header[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.header-actions[_ngcontent-%COMP%]{width:100%;flex-direction:column}.header-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}@media (max-width: 768px) and (max-width: 480px){.header-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:none}.header-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{margin-right:0}}"]})};var Ee=class i{appStore=d(L);router=d(qe);canActivate(e,t){let r=this.appStore.currentUser();return r&&r.role==="EMPRESA_DISTRIBUIDOR"||r&&r.role==="ADMINISTRADOR"||r&&r.role==="RECEPCIONISTA"?!0:this.router.createUrlTree(["/unauthorized"])}static \u0275fac=function(t){return new(t||i)};static \u0275prov=W({token:i,factory:i.\u0275fac,providedIn:"root"})};var Io=[{path:"",component:ve,canActivate:[Ee]}];export{Io as DISTRIBUTOR_RECORDS_ROUTES};
