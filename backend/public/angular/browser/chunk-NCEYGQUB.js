import{a as w}from"./chunk-QOYZNJPJ.js";import{Gc as f,Hc as h,I as n,Ic as A,O as _,Vc as d,a as l,ca as v,ha as E,j as b,ma as O,t as p,u as a,x as m}from"./chunk-NTZTTLCP.js";var k=class u{apiUrlOrders=d.apiUrl+"/orders";apiUrlDistricts=d.apiUrl+"/districts";apiUrlUsers=d.apiUrl+"/users";apiUrlSettings=d.apiUrl+"/settings";http=O(A);authService=O(w);constructor(){}getAuthHeaders(){let e=this.authService.getAccessToken();return e?new f({"Content-Type":"application/json",codrr_token:e}):new f({"Content-Type":"application/json"})}getOrders(e,t=1,s=10,r="id",o="desc"){let i=new h().set("page_number",t.toString()).set("page_size",s.toString()).set("sort_field",r).set("sort_direction",o);e&&(e.start_date&&(i=i.set("start_date",e.start_date)),e.end_date&&(i=i.set("end_date",e.end_date)),e.status&&(i=i.set("status",e.status)),e.search_term&&e.search_term.trim()!==""&&(i=i.set("search_term",e.search_term.trim())),e.myOrders&&(i=i.set("my_orders","true")));let g=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrlOrders,{params:i,headers:g}).pipe(m(c=>c),n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}getOrders2(e,t="id",s="desc"){let r=new h().set("sort_field",t).set("sort_direction",s);e&&(e.start_date&&(r=r.set("start_date",e.start_date)),e.end_date&&(r=r.set("end_date",e.end_date)),e.status&&(r=r.set("status",e.status)),e.search_term&&e.search_term.trim()!==""&&(r=r.set("search_term",e.search_term.trim())));let o=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrlOrders+"/filtered-orders",{params:r,headers:o}).pipe(m(i=>i.items),n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}getOrderStatuses(){return new b(e=>{e.next(["REGISTRADO","RECOGIDO","EN ALMACEN","EN TRANSITO","ENTREGADO","CANCELADO","RECHAZADO EN PUNTO","REPROGRAMADO","ANULADO"]),e.complete()})}getDeliveryDistricts(){let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlDistricts}/all`,{headers:e}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}updateOrderStatus(e,t,s,r,o,i){let g=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let c={orderId:e,reason:s,newStatus:t,action:"CAMBIO DE ESTADO"};return r&&(c.product_delivery_photo_url=r),o&&(c.payment_method_for_shipping_cost=o),i&&(c.payment_method_for_collection=i),this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:c},{headers:g}).pipe(n(this.handleError))}getMaxPackageDimensions(){let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlSettings}/all`,{headers:e}).pipe(v(t=>console.log("OrderService: API response for max dimensions:",t)),m(t=>{if(console.log("apiResponse",t),t.length){let s="Est\xE1ndar : "+t[0].standard_measurements_length+"cmx"+t[0].standard_measurements_width+"cmx"+t[0].standard_measurements_height+"cm "+t[0].standard_measurements_weight+"kg",r="Las entregas en motorizado permiten paquetes de hasta "+t[0].maximum_measurements_length+" cm x "+t[0].maximum_measurements_width+" cm x  "+t[0].maximum_measurements_height+" cm y "+t[0].maximum_measurements_weight+" kg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van.";return{max_length_cm:t[0].maximum_measurements_length,max_width_cm:t[0].maximum_measurements_width,max_height_cm:t[0].maximum_measurements_height,max_weight_kg:t[0].maximum_measurements_weight,sta_length_cm:t[0].standard_measurements_length,sta_width_cm:t[0].standard_measurements_width,sta_height_cm:t[0].standard_measurements_height,sta_weight_kg:t[0].standard_measurements_weight,volumetric_factor:t[0].volumetric_factor,standard_package_info:s,info_text:r}}return{max_length_cm:0,max_width_cm:0,max_height_cm:0,max_weight_kg:0,sta_length_cm:0,sta_width_cm:0,sta_height_cm:0,sta_weight_kg:0,volumetric_factor:0,standard_package_info:"",info_text:""}}),n(t=>(console.error("OrderService: API error fetching max package dimensions. Details:",t.message),p({max_length_cm:30,max_width_cm:25,max_height_cm:45,max_weight_kg:5,standard_package_info:"Est\xE1ndar : 30cmx15cmx20cm 1.5kg",info_text:"Las entregas en motorizado permiten paquetes de hasta 25\u202Fcm x 30\u202Fcm x 45\u202Fcm y 5\u202Fkg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van."}).pipe(_(200))))):a(()=>new Error("Not authenticated to fetch users."))}calculateShippingCost(e){console.log("packageData",e),console.log("OrderService: Calculating shipping cost (simulated) for",e);let t=8;return e.package_size_type==="custom"&&(t=10,(e.package_weight_kg||0)>2&&(t+=5),((e.package_length_cm||0)>30||(e.package_width_cm||0)>25||(e.package_height_cm||0)>20)&&(t+=4)),e.delivery_district_id==="D003"&&(t+=2),p({shipping_cost:t}).pipe(_(500))}createBatchOrders(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrlOrders}/batch-create`,e,{headers:t}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}importOrdersFromParsedJson(e){console.log("OrderService: Sending parsed JSON to backend for import",e);let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrlOrders}/import-batch-json`,e,{headers:t}).pipe(n(this.handleImportError)):a(()=>new Error("Not authenticated to fetch users."))}getAvailableDrivers(e){let t=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let s=new h().set("search_term",e).set("role","MOTORIZADO");return this.http.get(`${this.apiUrlUsers}/filtered`,{params:s,headers:t}).pipe(n(this.handleError))}getCompanies(e){let t=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let s=new h().set("search_term",e).set("role","EMPRESA");return this.http.get(`${this.apiUrlUsers}/filtered`,{params:s,headers:t}).pipe(n(this.handleError))}getDistricts(e){let t=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let s=new h().set("search_term",e);return this.http.get(`${this.apiUrlDistricts}/filtered`,{params:s,headers:t}).pipe(n(this.handleError))}assignDriverToOrder(e,t){let s=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/assign-driver-to-order/`+e,{motorizedId:t},{headers:s}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}rescheduleOrder(e,t,s){let r=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/reschedule-order/`+e,{newDate:t,reason:s},{headers:r}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}updateOrderAmountToCollect(e,t,s){let r=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let o={orderId:e,newValue:t,notes:s,action:"MODIFICACI\xD3N DEL MONTO A COBRAR"};return this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:o},{headers:r}).pipe(n(this.handleError))}updateOrderShippingCost(e,t,s){let r=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let o={orderId:e,newValue:t,notes:s,action:"MODIFICACI\xD3N DEL COSTO DE ENV\xCDO"};return this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:o},{headers:r}).pipe(n(this.handleError))}handleImportError(e){console.error("API Import Error:",e);let t={success:!1,message:"Error de comunicaci\xF3n con el servidor durante la importaci\xF3n.",errors:[{row:0,message:`Error: ${e.status} - ${e.statusText||"Error desconocido"}`}]};return e.error&&typeof e.error=="object"&&"message"in e.error&&(t=l(l({},t),e.error)),a(()=>t)}handleError(e){let t="An unknown error occurred!";return e.error instanceof ErrorEvent?t=`Error: ${e.error.message}`:(t=`Error Code: ${e.status}
Message: ${e.message||e.error?.message||"Server error"}`,e.status===0&&(t="Could not connect to the server. Please check your network or if the server is running.")),console.error("API Error in OrderService:",e),a(()=>new Error(t))}static \u0275fac=function(t){return new(t||u)};static \u0275prov=E({token:u,factory:u.\u0275fac,providedIn:"root"})};export{k as a};
