import{a as A}from"./chunk-XRPHOQB2.js";import{I as n,Jc as b,Kc as c,Lc as w,O as f,Yc as m,a as l,da as O,ia as E,j as v,na as x,t as p,u as a,x as h}from"./chunk-YUSEJVZ2.js";var k=class u{apiUrlOrders=m.apiUrl+"/orders";apiUrlDistricts=m.apiUrl+"/districts";apiUrlUsers=m.apiUrl+"/users";apiUrlSettings=m.apiUrl+"/settings";http=x(w);authService=x(A);constructor(){}getAuthHeaders(){let t=this.authService.getAccessToken();return t?new b({"Content-Type":"application/json",codrr_token:t}):new b({"Content-Type":"application/json"})}getActiveDistricts(t,e){let r=new c;t&&(r=r.set("startDate",t)),e&&(r=r.set("endDate",e));let s=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlOrders}/active-districts`,{params:r,headers:s}).pipe(h(o=>o.data||[])):a(()=>new Error("Not authenticated to fetch users."))}getOrders(t,e=1,r=10,s="id",o="desc"){let i=new c().set("page_number",e.toString()).set("page_size",r.toString()).set("sort_field",s).set("sort_direction",o);t&&(t.start_date&&(i=i.set("start_date",t.start_date)),t.end_date&&(i=i.set("end_date",t.end_date)),t.status&&(i=i.set("status",t.status)),t.search_term&&t.search_term.trim()!==""&&(i=i.set("search_term",t.search_term.trim())),t.myOrders&&(i=i.set("my_orders","true")),t.isExpress&&(i=i.set("isExpress","true")),t.districts&&(i=i.set("districts",t.districts.join("|"))));let g=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrlOrders,{params:i,headers:g}).pipe(h(_=>_),n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}getOrders2(t,e="id",r="desc"){let s=new c().set("sort_field",e).set("sort_direction",r);t&&(t.start_date&&(s=s.set("start_date",t.start_date)),t.end_date&&(s=s.set("end_date",t.end_date)),t.status&&(s=s.set("status",t.status)),t.search_term&&t.search_term.trim()!==""&&(s=s.set("search_term",t.search_term.trim())),t.districts&&(s=s.set("districts",t.districts.join("|"))));let o=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrlOrders+"/filtered-orders",{params:s,headers:o}).pipe(h(i=>i.items),n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}getOrderStatuses(){return new v(t=>{t.next(["REGISTRADO","RECOGIDO","EN ALMACEN","EN TRANSITO","ENTREGADO","RECHAZADO EN PUNTO","REPROGRAMADO","ANULADO"]),t.complete()})}getDeliveryDistricts(t){let e=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let r=new c().set("is_express",t||"");return this.http.get(`${this.apiUrlDistricts}/all`,{params:r,headers:e}).pipe(n(this.handleError))}updateOrderStatus(t,e,r,s,o,i,g){let _=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let d={orderId:t,reason:r,newStatus:e,action:"CAMBIO DE ESTADO",updatedAt:g};return s&&(d.product_delivery_photo_url=s),o&&(d.payment_method_for_shipping_cost=o),i&&(d.payment_method_for_collection=i),this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:d},{headers:_}).pipe(n(this.handleError))}getMaxPackageDimensions(){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlSettings}/all`,{headers:t}).pipe(O(e=>console.log("OrderService: API response for max dimensions:",e)),h(e=>{if(console.log("apiResponse",e),e.length){let r=e[0].standard_measurements_length+"cm x "+e[0].standard_measurements_width+"cm x "+e[0].standard_measurements_height+"cm ("+e[0].standard_measurements_weight+"kg)",s="Las entregas en motorizado permiten paquetes de hasta "+e[0].maximum_measurements_length+" cm x "+e[0].maximum_measurements_width+" cm x  "+e[0].maximum_measurements_height+" cm y "+e[0].maximum_measurements_weight+" kg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van.";return{max_length_cm:e[0].maximum_measurements_length,max_width_cm:e[0].maximum_measurements_width,max_height_cm:e[0].maximum_measurements_height,max_weight_kg:e[0].maximum_measurements_weight,sta_length_cm:e[0].standard_measurements_length,sta_width_cm:e[0].standard_measurements_width,sta_height_cm:e[0].standard_measurements_height,sta_weight_kg:e[0].standard_measurements_weight,volumetric_factor:e[0].volumetric_factor,standard_package_info:r,info_text:s}}return{max_length_cm:0,max_width_cm:0,max_height_cm:0,max_weight_kg:0,sta_length_cm:0,sta_width_cm:0,sta_height_cm:0,sta_weight_kg:0,volumetric_factor:0,standard_package_info:"",info_text:""}}),n(e=>(console.error("OrderService: API error fetching max package dimensions. Details:",e.message),p({max_length_cm:30,max_width_cm:25,max_height_cm:45,max_weight_kg:5,standard_package_info:"Est\xE1ndar : 30cmx15cmx20cm 1.5kg",info_text:"Las entregas en motorizado permiten paquetes de hasta 25\u202Fcm x 30\u202Fcm x 45\u202Fcm y 5\u202Fkg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van."}).pipe(f(200))))):a(()=>new Error("Not authenticated to fetch users."))}getStandardPackageMeasurements(){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlSettings}/all`,{headers:t}).pipe(O(e=>console.log("OrderService: API response for max dimensions:",e)),h(e=>{if(console.log("apiResponse",e),e.length){let r="Est\xE1ndar : "+e[0].standard_measurements_length+"cmx"+e[0].standard_measurements_width+"cmx"+e[0].standard_measurements_height+"cm "+e[0].standard_measurements_weight+"kg",s="Las entregas en motorizado permiten paquetes de hasta "+e[0].maximum_measurements_length+" cm x "+e[0].maximum_measurements_width+" cm x  "+e[0].maximum_measurements_height+" cm y "+e[0].maximum_measurements_weight+" kg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van.";return{max_length_cm:e[0].maximum_measurements_length,max_width_cm:e[0].maximum_measurements_width,max_height_cm:e[0].maximum_measurements_height,max_weight_kg:e[0].maximum_measurements_weight,sta_length_cm:e[0].standard_measurements_length,sta_width_cm:e[0].standard_measurements_width,sta_height_cm:e[0].standard_measurements_height,sta_weight_kg:e[0].standard_measurements_weight,volumetric_factor:e[0].volumetric_factor,standard_package_info:r,info_text:s}}return{max_length_cm:0,max_width_cm:0,max_height_cm:0,max_weight_kg:0,sta_length_cm:0,sta_width_cm:0,sta_height_cm:0,sta_weight_kg:0,volumetric_factor:0,standard_package_info:"",info_text:""}}),n(e=>(console.error("OrderService: API error fetching max package dimensions. Details:",e.message),p({max_length_cm:30,max_width_cm:25,max_height_cm:45,max_weight_kg:5,standard_package_info:"Est\xE1ndar : 30cmx15cmx20cm 1.5kg",info_text:"Las entregas en motorizado permiten paquetes de hasta 25\u202Fcm x 30\u202Fcm x 45\u202Fcm y 5\u202Fkg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van."}).pipe(f(200))))):a(()=>new Error("Not authenticated to fetch users."))}createBatchOrders(t){let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrlOrders}/batch-create`,t,{headers:e}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}updateOrder(t,e){let r=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/update-order/`+t,e,{headers:r}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}getOrderById(t){let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlOrders}/order/`+t,{headers:e}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}importOrdersFromParsedJson(t){console.log("OrderService: Sending parsed JSON to backend for import",t);let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrlOrders}/import-batch-json`,t,{headers:e}).pipe(n(this.handleImportError)):a(()=>new Error("Not authenticated to fetch users."))}getAvailableDrivers(t){let e=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let r=new c().set("search_term",t).set("role","MOTORIZADO");return this.http.get(`${this.apiUrlUsers}/filtered`,{params:r,headers:e}).pipe(n(this.handleError))}getCompanies(t){let e=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let r=new c().set("search_term",t).set("role","EMPRESA,EMPRESA_DISTRIBUIDOR");return this.http.get(`${this.apiUrlUsers}/filtered`,{params:r,headers:e}).pipe(n(this.handleError))}getDistricts(t,e){let r=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let s=new c().set("search_term",t).set("is_express",e||"");return this.http.get(`${this.apiUrlDistricts}/filtered`,{params:s,headers:r}).pipe(n(this.handleError))}assignDriverToOrder(t,e){let r=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/assign-driver-to-order/`+t,{motorizedId:e},{headers:r}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}rescheduleOrder(t,e,r){let s=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/reschedule-order/`+t,{newDate:e,reason:r},{headers:s}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}updateOrderAmountToCollect(t,e,r){let s=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let o={orderId:t,newValue:e,notes:r,action:"MODIFICACI\xD3N DEL MONTO A COBRAR"};return this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:o},{headers:s}).pipe(n(this.handleError))}updateOrderShippingCost(t,e,r){let s=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let o={orderId:t,newValue:e,notes:r,action:"MODIFICACI\xD3N DEL COSTO DE ENV\xCDO"};return this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:o},{headers:s}).pipe(n(this.handleError))}getEffectiveDiscount(t){let e=new Date;if(t.multiPackageDiscountStartDate&&t.multiPackageDiscountEndDate){let r=new Date(t.multiPackageDiscountStartDate),s=new Date(t.multiPackageDiscountEndDate);if(e<r||e>s)return 0}return t.multiPackageDiscountPercentage||0}handleImportError(t){console.error("API Import Error:",t);let e={success:!1,message:"Error de comunicaci\xF3n con el servidor durante la importaci\xF3n.",errors:[{row:0,message:`Error: ${t.status} - ${t.statusText||"Error desconocido"}`}]};return t.error&&typeof t.error=="object"&&"message"in t.error&&(e=l(l({},e),t.error)),a(()=>e)}handleError(t){let e="An unknown error occurred!";return console.log("error",t),t.error instanceof ErrorEvent?e=`Error: ${t.error.message}`:(e=`${t.error?.message||t.message}`,t.status===0&&(e="Could not connect to the server. Please check your network or if the server is running.")),console.error("API Error in OrderService:",t),a(()=>new Error(e))}static \u0275fac=function(e){return new(e||u)};static \u0275prov=E({token:u,factory:u.\u0275fac,providedIn:"root"})};export{k as a};
