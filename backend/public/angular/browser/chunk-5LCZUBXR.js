import{a as Bt}from"./chunk-GJEYWMJR.js";import{a as At,b as Lt,c as Ce}from"./chunk-INNR5TUR.js";import{d as dt,e as ut,i as gt}from"./chunk-OMPPSW6K.js";import{a as ht,b as he}from"./chunk-GDDGCRCE.js";import{a as _t,b as bt,c as Ct,d as Dt,e as vt,f as Et,g as St,h as Rt,i as Mt,j as xt,k as yt,l as It,n as be,o as Ot,p as wt}from"./chunk-PM3VLQI7.js";import{d as _e,e as Tt}from"./chunk-URZB77TE.js";import"./chunk-WNVFSXTV.js";import"./chunk-BYXBJQAS.js";import{a as ue,b as lt,c as mt,d as pt,e as ge,f as fe,g as ct,h as K}from"./chunk-GXNIZWNA.js";import"./chunk-74KGK7YW.js";import{a as Q}from"./chunk-K72O7MSM.js";import{a as Pt,b as Ft,c as kt,d as Nt}from"./chunk-WF66USBX.js";import{c as ft}from"./chunk-PKHWH5C3.js";import"./chunk-3PSRRXT4.js";import"./chunk-5PZ25QHJ.js";import"./chunk-UAHG2GVE.js";import"./chunk-FR3NO5YB.js";import"./chunk-2JNWSY3M.js";import{d as X,e as G}from"./chunk-6IG52UKJ.js";import{a as ce,b as de}from"./chunk-3IGH7FBX.js";import"./chunk-7RWCIHFI.js";import{A as H,B as at,E as pe,H as z,I as q,b as U,d as P,f as j,g as se,h as tt,j as Z,l as it,m as rt,n as nt,o as le,r as me,w as ot,y as V}from"./chunk-2ONXJ7S3.js";import"./chunk-BWBG2IHT.js";import"./chunk-U3COC3EF.js";import{i as Ze}from"./chunk-K4QNRRQ5.js";import{b as et}from"./chunk-ASKMK2H5.js";import{a as We}from"./chunk-XRPHOQB2.js";import{a as st,b as J,e as F}from"./chunk-2H2YZZAU.js";import"./chunk-NUMYIFQH.js";import{Ac as Je,Bb as ne,Db as d,Ea as D,Eb as w,Ec as v,F as Ae,Gd as x,Hd as E,I as te,J as ie,Jc as Fe,Ka as O,Kb as Oe,Kc as Qe,Lb as we,Lc as Ke,Mb as Pe,Pb as W,Q as Le,Qb as a,Rb as M,Sb as b,Sc as Ye,Tb as je,Va as l,Yc as ae,Za as $e,_b as Ve,a as Te,ac as He,ba as $,bc as ze,cb as _,da as Be,dc as qe,h as ke,ia as re,ib as u,l as A,lb as Ue,mb as p,na as c,t as Ne,u as L,uc as Xe,vb as o,vc as Ge,wa as I,wb as n,wc as oe,xa as T,xb as f,yb as S,zb as R}from"./chunk-YUSEJVZ2.js";var k=class i{http=c(Ke);apiUrl=`${ae.apiUrl}/distributor-records`;authService=c(We);getAuthHeaders(){let e=this.authService.getAccessToken();return e?new Fe({"Content-Type":"application/json",codrr_token:e}):new Fe({"Content-Type":"application/json"})}getMyRegistrationsPaginated(e,t,r,s,m,g,C){let B=this.getAuthHeaders();if(!this.authService.getAccessToken())return L(()=>new Error("Not authenticated to fetch users."));let y=new Qe().set("page",e?.toString()).set("limit",t?.toString()).set("sortField",r).set("sortOrder",s).set("startDate",g?.toISOString()??"").set("endDate",C?.toISOString()??"");return m&&(y=y.set("search",m)),this.http.get(this.apiUrl,{params:y,headers:B})}createRegistration(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(this.apiUrl+"/create",e,{headers:t}):L(()=>new Error("Not authenticated to fetch users."))}updateRegistration(e,t){let r=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.patch(`${this.apiUrl}/${e}`,t,{headers:r}):L(()=>new Error("No autenticado para actualizar registro."))}deleteRegistration(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.delete(`${this.apiUrl}/${e}`,{headers:t}):L(()=>new Error("No autenticado para eliminar registro."))}importOrdersFromParsedJson(e){console.log("OrderService: Sending parsed JSON to backend for import",e);let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrl}/import-batch-json`,e,{headers:t}).pipe(te(this.handleImportError)):L(()=>new Error("Not authenticated to fetch users."))}handleImportError(e){console.error("API Import Error:",e);let t={success:!1,message:"Error de comunicaci\xF3n con el servidor durante la importaci\xF3n.",errors:[{row:0,message:`Error: ${e.status} - ${e.statusText||"Error desconocido"}`}]};return e.error&&typeof e.error=="object"&&"message"in e.error&&(t=Te(Te({},t),e.error)),L(()=>t)}downloadTemplate(){return this.http.get(`${this.apiUrl}/template`,{responseType:"blob"})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=re({token:i,factory:i.\u0275fac,providedIn:"root"})};var De=class i{searchChanged=new D;searchControl=new Z("");destroy$=new A;constructor(){}ngOnInit(){this.searchControl.valueChanges.pipe(ie(400),Le(),$(this.destroy$)).subscribe(e=>{this.searchChanged.emit(e||"")})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=_({type:i,selectors:[["app-filter-toolbar"]],outputs:{searchChanged:"searchChanged"},decls:7,vars:1,consts:[[1,"filter-container"],["appearance","outline",1,"search-fields"],["matInput","","placeholder","Buscar por cliente, DNI, destino...",3,"formControl"],["matSuffix",""]],template:function(t,r){t&1&&(o(0,"div",0)(1,"mat-form-field",1)(2,"mat-label"),a(3,"Buscar..."),n(),f(4,"input",2),o(5,"mat-icon",3),a(6,"search"),n()()()),t&2&&(l(4),p("formControl",r.searchControl))},dependencies:[V,U,j,nt,E,x,q,z,H,pe,G,X],encapsulation:2})};var Xt=()=>[10,20,30];function Gt(i,e){i&1&&(o(0,"th",18),a(1,"N\xB0"),n())}function Jt(i,e){if(i&1&&(o(0,"td",19),a(1),n()),i&2){let t=e.$implicit;l(),M(t.code)}}function Qt(i,e){i&1&&(o(0,"th",18),a(1,"Remitente"),n())}function Kt(i,e){if(i&1&&(o(0,"td",19),a(1),n()),i&2){let t=e.$implicit;l(),M(t.user==null?null:t.user.username)}}function Yt(i,e){i&1&&(o(0,"th",18),a(1,"Fecha Registro"),n())}function Wt(i,e){if(i&1&&(o(0,"td",19),a(1),ze(2,"date"),n()),i&2){let t=e.$implicit;l(),b(" ",qe(2,1,t.createdAt,"dd/MM/yyyy HH:mm")," ")}}function Zt(i,e){i&1&&(o(0,"th",18),a(1,"Nombre Cliente"),n())}function ei(i,e){if(i&1&&(o(0,"td",19),a(1),n()),i&2){let t=e.$implicit;l(),M(t.clientName)}}function ti(i,e){i&1&&(o(0,"th",18),a(1,"DNI"),n())}function ii(i,e){if(i&1&&(o(0,"td",19),a(1),n()),i&2){let t=e.$implicit;l(),M(t.clientDni)}}function ri(i,e){i&1&&(o(0,"th",18),a(1,"Tel\xE9fono"),n())}function ni(i,e){if(i&1&&(o(0,"td",19),a(1),n()),i&2){let t=e.$implicit;l(),M(t.clientPhone)}}function oi(i,e){i&1&&(o(0,"th",18),a(1,"Destino"),n())}function ai(i,e){if(i&1&&(o(0,"td",19),a(1),n()),i&2){let t=e.$implicit;l(),b(" ",t.destinationAddress," ")}}function si(i,e){i&1&&(o(0,"th",18),a(1,"Observaci\xF3n"),n())}function li(i,e){if(i&1&&(o(0,"td",19),a(1),n()),i&2){let t=e.$implicit;l(),b(" ",t.observation," ")}}function mi(i,e){i&1&&f(0,"tr",20)}function pi(i,e){i&1&&f(0,"tr",21)}function ci(i,e){if(i&1&&(o(0,"tr",22)(1,"td",23),a(2," A\xFAn no has creado ning\xFAn registro. "),n()()),i&2){let t=w();l(),Ue("colspan",t.displayedColumns.length)}}function di(i,e){i&1&&(o(0,"th",24),a(1,"Acciones"),n())}function ui(i,e){if(i&1){let t=ne();o(0,"td",19)(1,"div",25)(2,"button",26),d("click",function(){let s=I(t).$implicit,m=w();return T(m.onEdit(s))}),o(3,"mat-icon"),a(4,"edit"),n()(),o(5,"button",27),d("click",function(){let s=I(t).$implicit,m=w();return T(m.onDelete(s.id))}),o(6,"mat-icon"),a(7,"delete"),n()(),o(8,"button",28),d("click",function(){let s=I(t).$implicit,m=w();return T(m.onPrint(s.id))}),o(9,"mat-icon"),a(10,"print"),n()()()()}}var Ee=class i{registrationService=c(k);appStore=c(Q);dataSource=[];resultsLength=0;isLoadingResults=!0;showActions=!1;paramsChanged=new D;edit=new D;delete=new D;print=new D;destroy$=new A;displayedColumns=["code","user","createdAt","clientName","clientDni","clientPhone","destinationAddress","observation"];paginator;sort;search$=new A;set searchTerm(e){this._searchTerm=e,this.paginator&&(this.paginator.pageIndex=0,console.log(this._searchTerm),this.search$.next())}_searchTerm="";ngOnInit(){let e=this.appStore.currentUser()?.role;(e==="ADMINISTRADOR"||e==="RECEPCIONISTA")&&(this.showActions=!0,this.displayedColumns.push("actions"))}ngAfterViewInit(){setTimeout(()=>{if(!this.sort||!this.paginator){console.error("ERROR: MatSort o MatPaginator no se encontraron.");return}this.sort.sortChange.subscribe(()=>{this.paginator&&(this.paginator.pageIndex=0)}),Ae(this.sort.sortChange,this.paginator.page).pipe($(this.destroy$)).subscribe(()=>{console.log("Evento de tabla detectado! Emitiendo params..."),this.emitParams()})})}emitParams(){this.paramsChanged.emit({page:this.paginator.pageIndex+1,pageSize:this.paginator.pageSize,sort:this.sort.active||"createdAt",sortDirection:this.sort.direction.toUpperCase()||"DESC"})}onEdit(e){this.edit.emit(e)}onDelete(e){this.delete.emit(e)}onPrint(e){this.print.emit(e)}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=_({type:i,selectors:[["app-registrations-table"]],viewQuery:function(t,r){if(t&1&&(Oe(_e,5),Oe(be,5)),t&2){let s;we(s=Pe())&&(r.paginator=s.first),we(s=Pe())&&(r.sort=s.first)}},inputs:{dataSource:"dataSource",resultsLength:"resultsLength",isLoadingResults:"isLoadingResults",showActions:"showActions",searchTerm:"searchTerm"},outputs:{paramsChanged:"paramsChanged",edit:"edit",delete:"delete",print:"print"},decls:33,vars:7,consts:[[1,"table-container","mat-elevation-z4"],["mat-table","","matSort","",3,"dataSource"],["matColumnDef","code"],["mat-header-cell","","mat-sort-header","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","user"],["matColumnDef","createdAt"],["matColumnDef","clientName"],["matColumnDef","clientDni"],["matColumnDef","clientPhone"],["matColumnDef","destinationAddress"],["matColumnDef","observation"],["mat-header-row","",4,"matHeaderRowDef","matHeaderRowDefSticky"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","mat-row",4,"matNoDataRow"],["matColumnDef","actions"],["mat-header-cell","",4,"matHeaderCellDef"],["aria-label","Seleccionar p\xE1gina de registros",3,"length","pageSizeOptions"],["mat-header-cell","","mat-sort-header",""],["mat-cell",""],["mat-header-row",""],["mat-row",""],[1,"mat-row"],[1,"mat-cell"],["mat-header-cell",""],[2,"display","flex","gap","10px !important"],["mat-icon-button","","matTooltip","Editar Registro",3,"click"],["mat-icon-button","","color","warn","matTooltip","Eliminar Registro",3,"click"],["mat-icon-button","","matTooltip","Imprimir R\xF3tulo",3,"click"]],template:function(t,r){t&1&&(o(0,"div",0)(1,"table",1),S(2,2),u(3,Gt,2,0,"th",3)(4,Jt,2,1,"td",4),R(),S(5,5),u(6,Qt,2,0,"th",3)(7,Kt,2,1,"td",4),R(),S(8,6),u(9,Yt,2,0,"th",3)(10,Wt,3,4,"td",4),R(),S(11,7),u(12,Zt,2,0,"th",3)(13,ei,2,1,"td",4),R(),S(14,8),u(15,ti,2,0,"th",3)(16,ii,2,1,"td",4),R(),S(17,9),u(18,ri,2,0,"th",3)(19,ni,2,1,"td",4),R(),S(20,10),u(21,oi,2,0,"th",3)(22,ai,2,1,"td",4),R(),S(23,11),u(24,si,2,0,"th",3)(25,li,2,1,"td",4),R(),u(26,mi,1,0,"tr",12)(27,pi,1,0,"tr",13)(28,ci,3,1,"tr",14),S(29,15),u(30,di,2,0,"th",16)(31,ui,11,0,"td",4),R(),n(),f(32,"mat-paginator",17),n()),t&2&&(l(),p("dataSource",r.dataSource),l(25),p("matHeaderRowDef",r.displayedColumns)("matHeaderRowDefSticky",!0),l(),p("matRowDefColumns",r.displayedColumns),l(5),p("length",r.resultsLength)("pageSizeOptions",Ve(6,Xt)))},dependencies:[v,Je,It,_t,Ct,St,Dt,bt,Rt,vt,Et,Mt,xt,yt,Tt,_e,wt,be,Ot,et,E,x],styles:[".table-container[_ngcontent-%COMP%]{width:100%;overflow-x:auto;border-radius:8px}table[_ngcontent-%COMP%]{width:100%}"]})};function gi(i,e){i&1&&(o(0,"mat-error"),a(1,"El nombre es requerido."),n())}function fi(i,e){i&1&&(o(0,"mat-error"),a(1,"El DNI es requerido."),n())}function hi(i,e){i&1&&(o(0,"mat-error"),a(1,"Debe contener 8 d\xEDgitos."),n())}function _i(i,e){i&1&&(o(0,"mat-error"),a(1,"El tel\xE9fono es requerido."),n())}function bi(i,e){i&1&&(o(0,"mat-error"),a(1,"Debe contener 9 d\xEDgitos."),n())}function Ci(i,e){i&1&&(o(0,"mat-error"),a(1,"El destino es requerido."),n())}function Di(i,e){i&1&&(o(0,"mat-error"),a(1,"La direcci\xF3n es muy corta."),n())}var Se=class i{initialData=null;isEditMode=!1;formSubmit=new D;formCancel=new D;fb=c(ot);form;constructor(){this.form=this.fb.group({clientName:["",[P.required,P.minLength(3)]],clientDni:["",[P.required,P.minLength(8)]],clientPhone:["",[P.required,P.minLength(9)]],observation:[""],destinationAddress:["",[P.required,P.minLength(5)]]})}ngOnInit(){this.initialData&&this.form.patchValue(this.initialData)}onSubmit(){this.form.valid&&(this.formSubmit.emit(this.form.value),this.form.reset(),Object.keys(this.form.controls).forEach(e=>{this.form.get(e)?.setErrors(null),this.form.get(e)?.markAsUntouched()}))}onCancelClick(){this.formCancel.emit()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=_({type:i,selectors:[["app-registration-form"]],inputs:{initialData:"initialData",isEditMode:"isEditMode"},outputs:{formSubmit:"formSubmit",formCancel:"formCancel"},decls:36,vars:11,consts:[[1,"registration-form",3,"ngSubmit","formGroup"],[1,"form-grid"],["appearance","outline"],["matInput","","formControlName","clientName","placeholder","Ej: Juan P\xE9rez","cdkFocusInitial",""],[4,"ngIf"],["matInput","","formControlName","clientDni","type","number","placeholder","8 d\xEDgitos"],["matInput","","formControlName","clientPhone","type","tel","placeholder","9 d\xEDgitos"],["appearance","outline",1,"full-width"],["matInput","","formControlName","destinationAddress","placeholder","Ej: Av. Javier Prado 123, San Isidro, Lima","rows","3"],["matInput","","formControlName","observation","placeholder",""],[1,"form-actions"],["mat-stroked-button","","type","button",1,"btn-corp-secondary",2,"padding","25px !important",3,"click"],["mat-raised-button","","color","primary","type","submit",1,"btn-corp-primary",2,"padding","25px !important",3,"disabled"]],template:function(t,r){if(t&1&&(o(0,"form",0),d("ngSubmit",function(){return r.onSubmit()}),o(1,"div",1)(2,"mat-form-field",2)(3,"mat-label"),a(4,"Nombre de Cliente"),n(),f(5,"input",3),u(6,gi,2,0,"mat-error",4),n(),o(7,"mat-form-field",2)(8,"mat-label"),a(9,"DNI"),n(),f(10,"input",5),u(11,fi,2,0,"mat-error",4)(12,hi,2,0,"mat-error",4),n(),o(13,"mat-form-field",2)(14,"mat-label"),a(15,"Tel\xE9fono"),n(),f(16,"input",6),u(17,_i,2,0,"mat-error",4)(18,bi,2,0,"mat-error",4),n(),o(19,"mat-form-field",7)(20,"mat-label"),a(21,"Destino (Direcci\xF3n Completa)"),n(),f(22,"textarea",8),u(23,Ci,2,0,"mat-error",4)(24,Di,2,0,"mat-error",4),n(),o(25,"mat-form-field",7)(26,"mat-label"),a(27,"Observaci\xF3n"),n(),f(28,"input",9),n()(),o(29,"div",10)(30,"button",11),d("click",function(){return r.onCancelClick()}),a(31," Cancelar "),n(),o(32,"button",12)(33,"mat-icon"),a(34),n(),a(35),n()()()),t&2){let s,m,g,C,B,y,Ie;p("formGroup",r.form),l(6),p("ngIf",(s=r.form.get("clientName"))==null?null:s.hasError("required")),l(5),p("ngIf",(m=r.form.get("clientDni"))==null?null:m.hasError("required")),l(),p("ngIf",(g=r.form.get("clientDni"))==null?null:g.hasError("pattern")),l(5),p("ngIf",(C=r.form.get("clientPhone"))==null?null:C.hasError("required")),l(),p("ngIf",(B=r.form.get("clientPhone"))==null?null:B.hasError("pattern")),l(5),p("ngIf",(y=r.form.get("destinationAddress"))==null?null:y.hasError("required")),l(),p("ngIf",(Ie=r.form.get("destinationAddress"))==null?null:Ie.hasError("minlength")),l(8),p("disabled",r.form.invalid),l(2),M(r.isEditMode?"save":"add"),l(),b(" ",r.isEditMode?"Guardar Cambios":"A\xF1adir Registro"," ")}},dependencies:[v,oe,V,it,U,rt,j,se,le,me,q,z,H,at,G,X,F,J,E,x],styles:[".registration-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-top:20px}.form-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}.full-width[_ngcontent-%COMP%]{grid-column:1/-1}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:8px;margin-top:24px}"]})};var ee=class i{constructor(e){this.data=e;e&&e.registration?(this.isEditMode=!0,this.registrationData=e.registration):(this.isEditMode=!1,this.registrationData=null)}dialogRef=c(ue);isEditMode;registrationData;onFormSubmit(e){this.dialogRef.close(e)}onCancel(){this.dialogRef.close()}static \u0275fac=function(t){return new(t||i)($e(lt))};static \u0275cmp=_({type:i,selectors:[["app-registration-form-dialog"]],decls:4,vars:3,consts:[["mat-dialog-title",""],[3,"formSubmit","formCancel","initialData","isEditMode"]],template:function(t,r){t&1&&(o(0,"h2",0),a(1),n(),o(2,"mat-dialog-content")(3,"app-registration-form",1),d("formSubmit",function(m){return r.onFormSubmit(m)})("formCancel",function(){return r.onCancel()}),n()()),t&2&&(l(),b(" ",r.isEditMode?"Editar":"Nuevo"," Datos de Envio "),l(2),p("initialData",r.registrationData)("isEditMode",r.isEditMode))},dependencies:[v,K,ge,fe,F,Se],encapsulation:2})};var Ei=(i,e)=>({"success-message":i,"error-message":e});function Si(i,e){if(i&1&&(o(0,"div",13)(1,"span"),a(2,"Archivo listo para importar: "),o(3,"strong"),a(4),n()()()),i&2){let t,r=w();l(4),M((t=r.selectedFile())==null?null:t.name)}}function Ri(i,e){i&1&&(o(0,"div",14)(1,"p"),a(2,"Procesando archivo, por favor espera..."),n(),f(3,"mat-progress-bar",15),n())}function Mi(i,e){if(i&1&&(o(0,"div",22)(1,"mat-icon",23),a(2,"error_outline"),n(),o(3,"span"),a(4),n()()),i&2){let t=e.$implicit;l(4),je("Fila ",t.row,": ",t.message,"")}}function xi(i,e){if(i&1&&(o(0,"div",19)(1,"h4"),a(2,"Detalles de Errores:"),n(),o(3,"mat-list",20),u(4,Mi,5,2,"div",21),n()()),i&2){let t,r=w(2);l(4),p("ngForOf",(t=r.importResult())==null?null:t.errors)}}function yi(i,e){if(i&1&&(o(0,"div",16)(1,"h3",17),a(2),n(),u(3,xi,5,1,"div",18),n()),i&2){let t,r,s,m=w();l(),p("ngClass",He(3,Ei,(t=m.importResult())==null?null:t.success,!((t=m.importResult())!=null&&t.success))),l(),b(" ",(r=m.importResult())==null?null:r.message," "),l(),p("ngIf",((s=m.importResult())==null?null:s.errors)&&((s=m.importResult())==null||s.errors==null?null:s.errors.length)>0)}}var Ii={"NOMBRE DE CLIENTE":"clientName",DNI:"clientDni",TEL\u00C9FONO:"clientPhone",DESTINO:"destinationAddress",OBSERVACION:"observation"},Ti=Object.keys(Ii),Re=class i{registrationService=c(k);snackBar=c(ce);dialogRef=c(ue);selectedFile=O(null);isProcessing=O(!1);importResult=O(null);onFileSelected(e){let t=e.target;t.files&&t.files.length>0&&(this.selectedFile.set(t.files[0]),this.importResult.set(null))}onDownloadTemplate(){try{let r=[["NOMBRE DE CLIENTE","DNI","TEL\xC9FONO","DESTINO","OBSERVACION"],...[{"NOMBRE DE CLIENTE":"Juan P\xE9rez Garc\xEDa",DNI:"12345678",TEL\u00C9FONO:"987654321",DESTINO:"Av. Javier Prado Este 123, San Isidro, Lima, Per\xFA",OBSERVACION:""}].map(C=>[C["NOMBRE DE CLIENTE"],C.DNI,C.TEL\u00C9FONO,C.DESTINO,C.OBSERVACION])],s=Ce.aoa_to_sheet(r);s["!cols"]=[{wch:30},{wch:15},{wch:15},{wch:50},{wch:50}];let g=Lt({Sheets:{Registros:s},SheetNames:["Registros"]},{bookType:"xlsx",type:"array"});this.saveAsExcelFile(g,"plantilla_registros_distribuidor"),this.snackBar.open("Descargando plantilla...","OK",{duration:2e3})}catch(e){console.error("Error al generar la plantilla de Excel:",e),this.snackBar.open("Error al generar la plantilla.","Cerrar")}}saveAsExcelFile(e,t){let r=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8"}),s=document.createElement("a"),m=URL.createObjectURL(r);s.href=m,s.download=`${t}.xlsx`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(m)}processImport(){return ke(this,null,function*(){let e=this.selectedFile();if(!e){this.snackBar.open("Por favor, selecciona un archivo Excel.","Cerrar");return}this.isProcessing.set(!0),this.importResult.set(null);try{let t=yield this.readFileAndParse(e);if(t.length===0)throw new Error("El archivo Excel no contiene filas de datos v\xE1lidas.");this.registrationService.importOrdersFromParsedJson(t).subscribe({next:r=>{this.importResult.set(r),this.isProcessing.set(!1),r.success&&(this.snackBar.open(r.message,"OK",{duration:4e3}),setTimeout(()=>this.dialogRef.close(!0),2e3))},error:r=>{let s=r.error?.message||["Error desconocido del servidor."];this.importResult.set({success:!1,message:"El archivo contiene datos inv\xE1lidos. Por favor, revisa los errores.",errors:Array.isArray(s)?s.map((m,g)=>({row:g+2,message:m})):[{row:0,message:s}]}),this.isProcessing.set(!1)}})}catch(t){this.importResult.set({success:!1,message:t.message}),this.isProcessing.set(!1)}})}readFileAndParse(e){return new Promise((t,r)=>{let s=new FileReader;s.onload=m=>{try{let g=At(m.target.result,{type:"binary"}),C=g.Sheets[g.SheetNames[0]],B=(Ce.sheet_to_json(C,{header:1})[0]||[]).map(h=>h.trim().toUpperCase()),y=Ti.filter(h=>!B.includes(h));if(y.length>0)return r(new Error(`Cabeceras faltantes o incorrectas en el Excel: ${y.join(", ")}`));let qt=Ce.sheet_to_json(C).map(h=>({clientName:h["NOMBRE DE CLIENTE"]?.toString().trim()||"",clientDni:h.DNI?.toString().trim()||"",clientPhone:h.TEL\u00C9FONO?.toString().trim()||"",destinationAddress:h.DESTINO?.toString().trim()||"",observation:h.OBSERVACION?.toString().trim()||""})).filter(h=>h.clientName||h.clientDni||h.clientPhone||h.destinationAddress||h.observation);t(qt)}catch{r(new Error("No se pudo leer el archivo Excel. Aseg\xFArate de que el formato sea correcto."))}},s.onerror=()=>r(new Error("Ocurri\xF3 un error al leer el archivo.")),s.readAsBinaryString(e)})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=_({type:i,selectors:[["app-distributor-import-dialog"]],decls:33,vars:9,consts:[["fileInput",""],["mat-dialog-title",""],[1,"mat-typography"],[1,"dialog-actions"],["mat-stroked-button","",1,"btn-corp-secondary",3,"click"],["mat-stroked-button","",1,"btn-corp-primary",3,"click","disabled"],["hidden","","type","file","accept",".xlsx, .xls, .csv",3,"change"],["class","file-info",4,"ngIf"],["class","upload-progress-container",4,"ngIf"],["class","import-results",4,"ngIf"],["align","center",2,"gap","10px"],["mat-button","",1,"btn-corp-secondary",3,"mat-dialog-close","disabled"],["mat-raised-button","","color","primary",1,"btn-corp-primary",3,"click","disabled"],[1,"file-info"],[1,"upload-progress-container"],["mode","indeterminate"],[1,"import-results"],[3,"ngClass"],["class","error-details",4,"ngIf"],[1,"error-details"],["dense",""],["class","error-item",4,"ngFor","ngForOf"],[1,"error-item"],["matListItemIcon","","color","warn"]],template:function(t,r){if(t&1){let s=ne();o(0,"h2",1),a(1,"Importaci\xF3n Masiva de Registros"),n(),o(2,"mat-dialog-content",2)(3,"p"),a(4,"Sigue estos pasos para importar tus registros desde un archivo Excel:"),n(),o(5,"ol")(6,"li"),a(7," Descarga nuestra plantilla para asegurar que las columnas tengan el formato correcto. "),n(),o(8,"li"),a(9,"Llena la plantilla con los datos de tus registros."),n(),o(10,"li"),a(11,'Guarda el archivo y s\xFAbelo usando el bot\xF3n "Seleccionar Archivo".'),n()(),o(12,"div",3)(13,"button",4),d("click",function(){return I(s),T(r.onDownloadTemplate())}),o(14,"mat-icon"),a(15,"download"),n(),a(16," Descargar Plantilla "),n(),o(17,"button",5),d("click",function(){I(s);let g=W(22);return T(g.click())}),o(18,"mat-icon"),a(19,"attach_file"),n(),a(20," Seleccionar Archivo "),n(),o(21,"input",6,0),d("change",function(g){return I(s),T(r.onFileSelected(g))}),n()(),u(23,Si,5,1,"div",7)(24,Ri,4,0,"div",8)(25,yi,4,6,"div",9),n(),o(26,"mat-dialog-actions",10)(27,"button",11),a(28),n(),o(29,"button",12),d("click",function(){return I(s),T(r.processImport())}),o(30,"mat-icon"),a(31,"upload"),n(),a(32),n()()}if(t&2){let s;l(17),p("disabled",r.isProcessing()),l(6),p("ngIf",r.selectedFile()&&!r.isProcessing()),l(),p("ngIf",r.isProcessing()),l(),p("ngIf",r.importResult()),l(2),p("mat-dialog-close",!1)("disabled",r.isProcessing()),l(),b(" ",(s=r.importResult())!=null&&s.success?"Cerrar":"Cancelar"," "),l(),p("disabled",!r.selectedFile()||r.isProcessing()),l(3),b(" ",r.isProcessing()?"Importando...":"Confirmar Importaci\xF3n"," ")}},dependencies:[v,Xe,Ge,oe,K,pt,ge,ct,fe,F,J,E,x,he,ht,gt,ut,dt,de],styles:[".dialog-actions[_ngcontent-%COMP%]{display:flex;gap:16px;margin:24px 0;justify-content:center;flex-wrap:wrap}.file-info[_ngcontent-%COMP%]{text-align:center;font-style:italic;color:#3f51b5;margin-top:16px;font-weight:500}.upload-progress-container[_ngcontent-%COMP%]{margin-top:20px;text-align:center}.import-results[_ngcontent-%COMP%]{margin-top:20px;padding:16px;border-radius:4px}.import-results[_ngcontent-%COMP%]   .success-message[_ngcontent-%COMP%]{color:#2e7d32;background-color:#e8f5e9;padding:8px;border-radius:4px}.import-results[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{color:#c62828;background-color:#ffebee;padding:8px;border-radius:4px}.error-details[_ngcontent-%COMP%]{margin-top:16px;max-height:200px;overflow-y:auto;border:1px solid #ffcdd2;padding:8px}.error-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:.9em}"]})};var Me=class i{dateRangeChanged=new D;rangeForm=new tt({start:new Z(null),end:new Z(null)});destroy$=new A;ngOnInit(){let e=new Date;this.rangeForm.setValue({start:e,end:e}),this.rangeForm.valueChanges.pipe(ie(400),$(this.destroy$)).subscribe(t=>{let r=t.start?new Date(t.start?.toDateString()):e,s=new Date(r.getFullYear(),r.getMonth(),r.getDate(),0,0,0),m=t.end?new Date(t.end?.toDateString()):e,g=new Date(m.getFullYear(),m.getMonth(),m.getDate(),23,59,59);this.dateRangeChanged.emit({start:s||null,end:g||null})})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=_({type:i,selectors:[["app-date-range-filter"]],outputs:{dateRangeChanged:"dateRangeChanged"},decls:15,vars:5,consts:[["startPicker",""],["endPicker",""],[1,"date-range-container",3,"formGroup"],["appearance","outline",1,"date-field"],["matInput","","formControlName","start","placeholder","dd/mm/aaaa",3,"matDatepicker"],["matIconSuffix","",3,"for"],["matInput","","formControlName","end","placeholder","dd/mm/aaaa",3,"matDatepicker"]],template:function(t,r){if(t&1&&(o(0,"div",2)(1,"mat-form-field",3)(2,"mat-label"),a(3,"Fecha de inicio"),n(),f(4,"input",4)(5,"mat-datepicker-toggle",5)(6,"mat-datepicker",null,0),n(),o(8,"mat-form-field",3)(9,"mat-label"),a(10,"Fecha de fin"),n(),f(11,"input",6)(12,"mat-datepicker-toggle",5)(13,"mat-datepicker",null,1),n()()),t&2){let s=W(7),m=W(14);p("formGroup",r.rangeForm),l(4),p("matDatepicker",s),l(),p("for",s),l(6),p("matDatepicker",m),l(),p("for",m)}},dependencies:[v,V,U,j,se,le,me,q,z,H,pe,G,X,Nt,Pt,Ft,kt,ft,E],styles:["[_nghost-%COMP%]{width:100%}.date-range-container[_ngcontent-%COMP%]{display:flex;gap:16px;align-items:center}.date-field[_ngcontent-%COMP%]{flex:1;min-width:150px}@media (max-width: 768px){.date-range-container[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch;gap:0}}"]})};var xe=class i{registrationService=c(k);snackBar=c(ce);dialog=c(mt);appStore=c(Q);isAdminOrReceptionist=O(!1);registrations=O([]);resultsLength=O(0);isLoading=O(!0);currentPage=1;pageSize=10;sort="createdAt";sortDirection="DESC";searchTerm="";startDate=null;endDate=null;ngOnInit(){let e=this.appStore.currentUser()?.role;(e==="ADMINISTRADOR"||e==="RECEPCIONISTA")&&this.isAdminOrReceptionist.set(!0);let t=new Date;this.startDate=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0),this.endDate=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59),this.fetchData()}onDateRangeChanged(e){console.log("Fechas recibidas del hijo:",e),this.startDate=e.start,this.endDate=e.end,this.currentPage=1,this.fetchData()}onSearchChanged(e){this.searchTerm=e,this.currentPage=1,this.fetchData()}onTableParamsChanged(e){this.currentPage=e.page,this.pageSize=e.pageSize,this.sort=e.sort,this.sortDirection=e.sortDirection,this.fetchData()}fetchData(){this.isLoading.set(!0),this.registrationService.getMyRegistrationsPaginated(this.currentPage,this.pageSize,this.sort,this.sortDirection,this.searchTerm,this.startDate,this.endDate).pipe(Be(e=>{this.isLoading.set(!1),e?(this.registrations.set(e.data),this.resultsLength.set(e.total)):(this.registrations.set([]),this.resultsLength.set(0))}),te(()=>(this.isLoading.set(!1),this.registrations.set([]),this.resultsLength.set(0),this.snackBar.open("Error al cargar los registros.","Cerrar"),Ne(null)))).subscribe()}openManualRegistrationDialog(){this.dialog.open(ee,{width:"600px",disableClose:!0}).afterClosed().subscribe(t=>{t&&this.registrationService.createRegistration(t).subscribe({next:()=>{this.snackBar.open("Registro creado con \xE9xito.","OK",{duration:3e3}),this.fetchData()},error:r=>this.snackBar.open(`Error al crear el registro: ${r.message}`,"Cerrar")})})}handleEdit(e){this.dialog.open(ee,{width:"600px",disableClose:!0,data:{registration:e}}).afterClosed().subscribe(r=>{r&&this.registrationService.updateRegistration(e.id,r).subscribe({next:()=>{this.snackBar.open("Registro actualizado con \xE9xito.","OK",{duration:3e3}),this.fetchData()},error:s=>this.snackBar.open(`Error al actualizar: ${s.message}`,"Cerrar")})})}handleDelete(e){let t={title:"Confirmar Eliminaci\xF3n",message:"\xBFEst\xE1s seguro de que quieres eliminar este registro? Esta acci\xF3n no se puede deshacer.",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar",confirmButtonColor:"warn"};this.dialog.open(Bt,{data:t}).afterClosed().subscribe(s=>{s&&this.registrationService.deleteRegistration(e).subscribe({next:()=>{this.snackBar.open("Registro eliminado con \xE9xito.","OK",{duration:3e3}),this.fetchData()},error:m=>this.snackBar.open(`Error al eliminar: ${m.message}`,"Cerrar")})})}handlePrint(e){let t=ae.apiUrl+"/distributor-records/"+e+"/pdf-rotulado";window.open(t,"_blank")}openMassiveImportDialog(){this.dialog.open(Re,{width:"600px",disableClose:!0}).afterClosed().subscribe(t=>{t&&this.fetchData()})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=_({type:i,selectors:[["app-registration-page"]],decls:23,vars:5,consts:[[1,"page-container"],[1,"header"],[1,"page-title"],[1,"header-actions"],["mat-stroked-button","",1,"btn-corp-secondary",3,"click"],["mat-raised-button","","color","primary",1,"btn-corp-primary",3,"click"],[1,"history-section"],[1,"filter-controls"],[3,"searchChanged"],["mat-icon-button","","matTooltip","Actualizar la lista",1,"refresh-button","btn-corp-primary",3,"click"],[3,"dateRangeChanged"],[3,"paramsChanged","edit","delete","print","dataSource","resultsLength","isLoadingResults","showActions"]],template:function(t,r){t&1&&(o(0,"div",0)(1,"div",1)(2,"h1",2),a(3),n(),o(4,"div",3)(5,"button",4),d("click",function(){return r.openMassiveImportDialog()}),o(6,"mat-icon"),a(7,"upload_file"),n(),o(8,"span"),a(9,"Importar desde Excel"),n()(),o(10,"button",5),d("click",function(){return r.openManualRegistrationDialog()}),o(11,"mat-icon"),a(12,"add"),n(),o(13,"span"),a(14,"Nuevo Registro"),n()()()(),o(15,"div",6)(16,"div",7)(17,"app-filter-toolbar",8),d("searchChanged",function(m){return r.onSearchChanged(m)}),n(),o(18,"button",9),d("click",function(){return r.fetchData()}),o(19,"mat-icon"),a(20,"refresh"),n()(),o(21,"app-date-range-filter",10),d("dateRangeChanged",function(m){return r.onDateRangeChanged(m)}),n()(),o(22,"app-registrations-table",11),d("paramsChanged",function(m){return r.onTableParamsChanged(m)})("edit",function(m){return r.handleEdit(m)})("delete",function(m){return r.handleDelete(m)})("print",function(m){return r.handlePrint(m)}),n()()()),t&2&&(l(3),b(" ",r.isAdminOrReceptionist()?"Gesti\xF3n de Registros de Envio":"Mis Registros de Distribuidor"," "),l(19),p("dataSource",r.registrations())("resultsLength",r.resultsLength())("isLoadingResults",r.isLoading())("showActions",r.isAdminOrReceptionist()))},dependencies:[v,Ze,F,J,st,E,x,de,he,K,De,Ee,Me],styles:[".page-container[_ngcontent-%COMP%]{padding:24px}.header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:20px}.page-title[_ngcontent-%COMP%]{margin:0;min-width:250px}.header-actions[_ngcontent-%COMP%]{display:flex;gap:10px;flex-shrink:0}.filter-controls[_ngcontent-%COMP%]{display:flex;align-items:center;flex-wrap:wrap}.filter-controls[_ngcontent-%COMP%]   app-filter-toolbar[_ngcontent-%COMP%]{flex-grow:1;min-width:250px}@media (max-width: 768px){.page-container[_ngcontent-%COMP%]{padding:16px}.header[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.page-title[_ngcontent-%COMP%]{text-align:center;margin-bottom:16px}.header-actions[_ngcontent-%COMP%]{width:100%;flex-direction:column}.header-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}.filter-controls[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.filter-controls[_ngcontent-%COMP%]   .refresh-button[_ngcontent-%COMP%]{align-self:flex-start;margin-left:0}}.refresh-button[_ngcontent-%COMP%]{margin-bottom:20px;margin-left:20px}@media (max-width: 480px){.header-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:none}.header-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{margin-right:0}.page-container[_ngcontent-%COMP%]{padding:12px}}"]})};var ye=class i{appStore=c(Q);router=c(Ye);canActivate(e,t){let r=this.appStore.currentUser();return r&&r.role==="EMPRESA_DISTRIBUIDOR"||r&&r.role==="ADMINISTRADOR"||r&&r.role==="RECEPCIONISTA"?!0:this.router.createUrlTree(["/unauthorized"])}static \u0275fac=function(t){return new(t||i)};static \u0275prov=re({token:i,factory:i.\u0275fac,providedIn:"root"})};var lo=[{path:"",component:xe,canActivate:[ye]}];export{lo as DISTRIBUTOR_RECORDS_ROUTES};
