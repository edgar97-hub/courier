import{Ec as p,G as g,Ia as a,Kc as S,M as m,Qc as f,ba as d,ga as h,la as n,s as c,v as u}from"./chunk-AIQW7TM2.js";var o="access_token",v="refresh_token",l="user_info",A=class i{http=n(p);router=n(S);isAuthenticated=a(!1);currentUser=a(null);loginUrl=f.apiUrl+"/auth/login";constructor(){this.loadSessionFromStorage()}loadSessionFromStorage(){let e=localStorage.getItem(o),r=localStorage.getItem(l);if(e&&r)try{let t=JSON.parse(r);this.isAuthenticated.set(!0),this.currentUser.set(t),console.log("AuthService: Session loaded from storage.",t)}catch(t){console.error("AuthService: Error parsing user from storage.",t),this.clearUserSessionAndSignals()}else this.clearUserSessionAndSignals()}storeTokens(e,r){localStorage.setItem(o,e),r&&localStorage.setItem(v,r)}storeUserInfo(e){localStorage.setItem(l,JSON.stringify(e))}clearUserSessionAndSignals(){localStorage.removeItem(o),localStorage.removeItem(v),localStorage.removeItem(l),this.isAuthenticated.set(!1),this.currentUser.set(null)}getAccessToken(){return localStorage.getItem(o)}login(e){let r={email:e.email,password:e.password};return this.http.post(this.loginUrl,r).pipe(m(1e3),u(t=>{let s={id:t.user.id,rol:t.user.role,email:e.email,username:e.email.split("@")[0]};return{accessToken:t.accessToken,user:s}}),d(t=>{this.storeTokens(t.accessToken,t.refreshToken),this.storeUserInfo(t.user),this.isAuthenticated.set(!0),this.currentUser.set(t.user),console.log("AuthService: Login successful, internal signals updated.")}),g(this.handleError))}loginPromise(e){return new Promise((r,t)=>{this.login(e).subscribe({next:s=>r(s),error:s=>t(s)})})}logout(){console.log("AuthService: logout - Clearing session and signals..."),this.clearUserSessionAndSignals(),this.router.navigate(["/login"])}handleError(e){let r="Login failed. Please check your credentials or network.";return e.error instanceof ErrorEvent?r=`An error occurred: ${e.error.message}`:e.status===400&&e.error&&e.error.error?r=e.error.error:e.status===401?r="Unauthorized. Please check your credentials.":r=`Server error: ${e.status}. ${e.message}`,console.error(r,e),c(()=>new Error(r))}static \u0275fac=function(r){return new(r||i)};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};export{A as a};
