import{a as Wt,b as Kt,c as qt,e as Qt,f as Zt}from"./chunk-Q7OA4UG2.js";import{a as $t,b as jt,c as Vt,d as Xt}from"./chunk-XHWUTENY.js";import{a as Ct,b as Ot,c as bt,d as _e,g as Mt,h as xt}from"./chunk-HGPHA7DX.js";import{c as Pt}from"./chunk-ZNRBVXVX.js";import"./chunk-CL5SDS67.js";import"./chunk-F5X5MWHG.js";import{a as Et,b as St,c as Dt,d as Tt,e as wt,f as It,g as kt,h as At,i as Rt,j as Ft,k as Nt,l as Lt,m as zt,n as Ee,o as Ut,p as Ht}from"./chunk-AHO7UDPR.js";import"./chunk-MS4AQ6UA.js";import{a as Me,b as xe,d as Pe,e as Gt}from"./chunk-7I3QWZBN.js";import{a as Bt,b as ye}from"./chunk-XC4JK7T6.js";import{a as he,b as fe,c as Ce,e as Oe,f as be,g as ve,h as N}from"./chunk-MJOVE2YB.js";import{d as yt}from"./chunk-XTLFEAFI.js";import"./chunk-MW2V4VAY.js";import{a as ft}from"./chunk-GEP52VOZ.js";import{a as vt,b as L}from"./chunk-EYCX7D4K.js";import"./chunk-CSWUMH3X.js";import{b as _t,d as ht,e as me}from"./chunk-A2GZCIHE.js";import{a as ge,b as ue}from"./chunk-YSXPYM2V.js";import"./chunk-7RWCIHFI.js";import{C as ut,F as ce,G as de,b as mt,f as te,g as oe,l as re,o as ne,r as ie,v as ae,w as pt,x as se,y as le,z as gt}from"./chunk-I57H2NTY.js";import"./chunk-7SNYFGVH.js";import"./chunk-NTJKNPMM.js";import{i as ct}from"./chunk-ABVOVIA5.js";import{a as dt,b as R}from"./chunk-42JOKCMC.js";import{a as lt}from"./chunk-QOYZNJPJ.js";import{a as pe,b as I,e as S}from"./chunk-JRHRK62N.js";import"./chunk-J25GVFCX.js";import{$b as y,Ac as it,Bb as h,Cb as j,Cc as E,Da as x,Dd as F,Ed as D,Gc as Ve,Hc as Xe,I as b,Ib as Be,Ic as ee,J as Qe,Ja as Le,Jb as Ge,Kb as Ue,Nb as J,O as Ne,Ob as l,Pb as He,Pc as at,Q as Ze,Qb as u,Ra as Ye,Ta as c,Uc as st,Vc as X,Xa as w,Xb as tt,Yb as $e,a as G,aa as A,ab as P,bc as je,ca as q,dc as T,gb as m,h as U,ha as Q,j as We,jb as et,kb as p,l as k,m as Ke,ma as g,pb as ze,sc as ot,t as Fe,tb as n,tc as rt,u as O,ua as Je,ub as i,uc as Y,va as H,vb as v,w as qe,wa as $,wb as f,x as K,xb as C,yc as V,zb as Z,zc as nt}from"./chunk-NTZTTLCP.js";var z=class o{apiUrlOrders=X.apiUrl+"/orders";apiUrl=X.apiUrl+"/districts";apiUrlUsers=X.apiUrl+"/users";apiUrlSettings=X.apiUrl+"/settings";http=g(ee);authService=g(lt);constructor(){}getAuthHeaders(){let e=this.authService.getAccessToken();return e?new Ve({"Content-Type":"application/json",codrr_token:e}):new Ve({"Content-Type":"application/json"})}getOrders(e,t=1,r=10,a="id",d="desc"){let s=new Xe().set("page_number",t.toString()).set("page_size",r.toString()).set("sort_field",a).set("sort_direction",d);e&&(e.delivery_date&&(s=s.set("delivery_date",e.delivery_date)),e.status&&(s=s.set("status",e.status)),e.search_term&&e.search_term.trim()!==""&&(s=s.set("search_term",e.search_term.trim())));let M=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrlOrders,{params:s,headers:M}).pipe(K(_=>_),b(this.handleError)):O(()=>new Error("Not authenticated to fetch users."))}getOrders2(e,t="id",r="desc"){let a=new Xe().set("sort_field",t).set("sort_direction",r);e&&(e.delivery_date&&(a=a.set("delivery_date",e.delivery_date)),e.start_date&&(a=a.set("start_date",e.start_date)),e.end_date&&(a=a.set("end_date",e.end_date)),e.status&&(a=a.set("status",e.status)),e.search_term&&e.search_term.trim()!==""&&(a=a.set("search_term",e.search_term.trim())));let d=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrlOrders+"/filtered-orders",{params:a,headers:d}).pipe(K(s=>s.items),b(this.handleError)):O(()=>new Error("Not authenticated to fetch users."))}getOrderStatuses(){return new We(e=>{e.next(["REGISTRADO","RECOGIDO","EN ALMACEN","EN TRANSITO","ENTREGADO","CANCELADO","RECHAZADO EN PUNTO","REPROGRAMADO"]),e.complete()})}getDeliveryDistricts(){let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrl}/all`,{headers:e}).pipe(b(this.handleError)):O(()=>new Error("Not authenticated to fetch users."))}updateOrderStatus(e,t,r,a,d,s){let M=this.getAuthHeaders();if(!this.authService.getAccessToken())return O(()=>new Error("Not authenticated to fetch users."));let _={orderId:e,reason:r,newStatus:t,action:"CAMBIO DE ESTADO"};return a&&(_.product_delivery_photo_url=a),d&&(_.payment_method_for_shipping_cost=d),s&&(_.payment_method_for_collection=s),this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:_},{headers:M}).pipe(b(this.handleError))}updateOrderPaymentType(e,t,r){let a=this.getAuthHeaders();if(!this.authService.getAccessToken())return O(()=>new Error("Not authenticated to fetch users."));let d={orderId:e,reason:"",newStatus:"",action:"MODIFICACION DE TIPOS DE PAGO"};return t&&(d.payment_method_for_shipping_cost=t),r&&(d.payment_method_for_collection=r),this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:d},{headers:a}).pipe(b(this.handleError))}getMaxPackageDimensions(){let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlSettings}/all`,{headers:e}).pipe(q(t=>console.log("OrderService: API response for max dimensions:",t)),K(t=>{if(console.log("apiResponse",t),t.length){let r="Est\xE1ndar : "+t[0].standard_measurements_length+"cmx"+t[0].standard_measurements_width+"cmx"+t[0].standard_measurements_height+"cm "+t[0].standard_measurements_weight+"kg",a="MEDIDAS MAXIMAS (Largo "+t[0].maximum_measurements_length+" cm x Ancho "+t[0].maximum_measurements_width+" cm x Alto "+t[0].maximum_measurements_height+" cm) y PESO MAXIMO ("+t[0].maximum_measurements_weight+" kilogramos)";return{max_length_cm:t[0].maximum_measurements_length,max_width_cm:t[0].maximum_measurements_width,max_height_cm:t[0].maximum_measurements_height,max_weight_kg:t[0].maximum_measurements_weight,sta_length_cm:t[0].standard_measurements_length,sta_width_cm:t[0].standard_measurements_width,sta_height_cm:t[0].standard_measurements_height,sta_weight_kg:t[0].standard_measurements_weight,volumetric_factor:t[0].volumetric_factor,standard_package_info:r,info_text:a}}return{max_length_cm:0,max_width_cm:0,max_height_cm:0,max_weight_kg:0,sta_length_cm:0,sta_width_cm:0,sta_height_cm:0,sta_weight_kg:0,volumetric_factor:0,standard_package_info:"",info_text:""}}),b(t=>(console.error("OrderService: API error fetching max package dimensions. Details:",t.message),Fe({max_length_cm:30,max_width_cm:25,max_height_cm:45,max_weight_kg:5,standard_package_info:"Est\xE1ndar : 30cmx15cmx20cm 1.5kg",info_text:"MEDIDAS MAXIMAS (Largo 30 cm x Ancho 25 cm x Alto 45 cm) y PESO MAXIMO (5 kilogramos)"}).pipe(Ne(200))))):O(()=>new Error("Not authenticated to fetch users."))}calculateShippingCost(e){console.log("packageData",e),console.log("OrderService: Calculating shipping cost (simulated) for",e);let t=8;return e.package_size_type==="custom"&&(t=10,(e.package_weight_kg||0)>2&&(t+=5),((e.package_length_cm||0)>30||(e.package_width_cm||0)>25||(e.package_height_cm||0)>20)&&(t+=4)),e.delivery_district_id==="D003"&&(t+=2),Fe({shipping_cost:t}).pipe(Ne(500))}createBatchOrders(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrlOrders}/batch-create`,e,{headers:t}).pipe(b(this.handleError)):O(()=>new Error("Not authenticated to fetch users."))}getAvailableDrivers(e){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlUsers}/rol/MOTORIZED`,{headers:t}).pipe(b(this.handleError)):O(()=>new Error("Not authenticated to fetch users."))}assignDriverToOrder(e,t){let r=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/assign-driver-to-order/`+e,{motorizedId:t},{headers:r}).pipe(b(this.handleError)):O(()=>new Error("Not authenticated to fetch users."))}rescheduleOrder(e,t,r){let a=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/reschedule-order/`+e,{newDate:t,reason:r},{headers:a}).pipe(b(this.handleError)):O(()=>new Error("Not authenticated to fetch users."))}handleImportError(e){console.error("API Import Error:",e);let t={success:!1,message:"Error de comunicaci\xF3n con el servidor durante la importaci\xF3n.",errors:[{row:0,message:`Error: ${e.status} - ${e.statusText||"Error desconocido"}`}]};return e.error&&typeof e.error=="object"&&"message"in e.error&&(t=G(G({},t),e.error)),O(()=>t)}handleError(e){let t="An unknown error occurred!";return e.error instanceof ErrorEvent?t=`Error: ${e.error.message}`:(t=`Error Code: ${e.status}
Message: ${e.message||e.error?.message||"Server error"}`,e.status===0&&(t="Could not connect to the server. Please check your network or if the server is running.")),console.error("API Error in OrderService:",e),O(()=>new Error(t))}static \u0275fac=function(t){return new(t||o)};static \u0275prov=Q({token:o,factory:o.\u0275fac,providedIn:"root"})};var Se=class o{filtersChanged=new x;filterForm;orderStatuses$;orderService=g(z);fb=g(ae);datePipe=g(V);destroy$=new k;constructor(){this.filterForm=this.fb.group({delivery_date:[new Date],status:["ENTREGADO"],search_term:[""]}),this.orderStatuses$=this.orderService.getOrderStatuses()}ngOnInit(){console.log("OrderFiltersComponent: ngOnInit - Instance Created/Initialized"),this.emitSpecificFilters({delivery_date:this.filterForm.get("delivery_date")?.value,status:"ENTREGADO"}),this.filterForm.valueChanges.pipe(A(this.destroy$),Qe(400),Ze((e,t)=>JSON.stringify(e)===JSON.stringify(t))).subscribe(e=>{this.applyAllFilters(e)})}emitSpecificFilters(e){let t={delivery_date:e.delivery_date?this.datePipe.transform(e.delivery_date,"yyyy-MM-dd"):null,status:e.status!==void 0?e.status:null,search_term:e.search_term!==void 0?e.search_term:null};console.log("OrderFiltersComponent: Emitting SPECIFIC filters",t),this.filtersChanged.emit(t)}applyAllFilters(e){let t={delivery_date:e.delivery_date?this.datePipe.transform(e.delivery_date,"yyyy-MM-dd"):null,status:e.status||null,search_term:e.search_term?.trim()||null};this.filtersChanged.emit(t)}applyFilters(){let e=this.filterForm.value,t={delivery_date:e.delivery_date?this.datePipe.transform(e.delivery_date,"yyyy-MM-dd"):null,status:e.status||null,search_term:e.search_term?.trim()||null};this.filtersChanged.emit(t)}clearFilters(){this.filterForm.reset({delivery_date:new Date,status:"ENTREGADO",search_term:""}),this.emitSpecificFilters({delivery_date:this.filterForm.get("delivery_date")?.value,status:"ENTREGADO"})}ngOnDestroy(){console.log("OrderFiltersComponent: ngOnDestroy - Instance Destroyed"),this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=P({type:o,selectors:[["app-order-filters"]],outputs:{filtersChanged:"filtersChanged"},features:[tt([xt(),V])],decls:22,vars:3,consts:[["startDatePicker",""],[1,"filters-container",3,"formGroup"],[2,"min-width","100%"],["appearance","outline",2,"width","250px !important"],["matInput","","formControlName","delivery_date","placeholder","mm/dd/yyyy",3,"matDatepicker"],["matSuffix","",3,"for"],["appearance","outline"],["matInput","","formControlName","search_term","placeholder","Buscar..."],[1,"filter-actions"],["mat-flat-button","","type","button",1,"btn-corp-primary",3,"click"],["mat-stroked-button","","type","button",1,"btn-corp-secondary",3,"click"]],template:function(t,r){if(t&1){let a=Z();n(0,"form",1)(1,"div",2)(2,"mat-form-field",3)(3,"mat-label"),l(4,"Fecha de entrega "),i(),v(5,"input",4)(6,"mat-datepicker-toggle",5)(7,"mat-datepicker",null,0),i()(),n(9,"mat-form-field",6)(10,"mat-label"),l(11,"Buscar"),i(),v(12,"input",7),i(),n(13,"div",8)(14,"button",9),h("click",function(){return H(a),$(r.applyFilters())}),n(15,"mat-icon"),l(16,"search"),i(),l(17," Buscar "),i(),n(18,"button",10),h("click",function(){return H(a),$(r.clearFilters())}),n(19,"mat-icon"),l(20,"clear_all"),i(),l(21," Limpiar "),i()()()}if(t&2){let a=J(8);p("formGroup",r.filterForm),c(5),p("matDatepicker",a),c(),p("for",a)}},dependencies:[E,se,re,mt,te,oe,ne,ie,de,ce,le,ut,me,ht,Xt,$t,jt,Vt,Mt,ye,S,I,D,F],styles:[".filters-container[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;padding:16px;background-color:var(--sys-surface-container-low);border-radius:8px;margin-bottom:20px;box-shadow:0 1px 3px #00000014}mat-form-field[_ngcontent-%COMP%]{min-width:200px;flex-grow:1}.filter-actions[_ngcontent-%COMP%]{display:flex;gap:10px;align-items:center;padding-top:8px}@media (max-width: 768px){mat-form-field[_ngcontent-%COMP%]{width:calc(50% - 8px);min-width:unset}.filter-actions[_ngcontent-%COMP%]{width:100%;justify-content:flex-end;padding-top:16px}}@media (max-width: 480px){mat-form-field[_ngcontent-%COMP%]{width:100%}}"]})};var W=(_=>(_.REGISTRADO="REGISTRADO",_.RECOGIDO="RECOGIDO",_.EN_ALMACEN="EN ALMACEN",_.EN_TRANSITO="EN TRANSITO",_.ENTREGADO="ENTREGADO",_.CANCELADO="CANCELADO",_.RECHAZADO="RECHAZADO EN PUNTO",_.REPROGRAMADO="REPROGRAMADO",_))(W||{});function io(o,e){o&1&&(n(0,"div",10)(1,"mat-icon",11),l(2,"broken_image"),i(),n(3,"p",12),l(4," No hay imagen de evidencia disponible o no se pudo cargar. "),i()())}var we=class o{constructor(e,t){this.dialogRef=e;this.data=t;this.data.order.product_delivery_photo_url||(this.isLoadingImage.set(!1),this.imageLoadFailed.set(!0))}isLoadingImage=Le(!0);imageLoadFailed=Le(!1);onImageLoad(){console.log("EVENTO: onImageLoad DISPARADO para URL:",this.data.order.product_delivery_photo_url),this.isLoadingImage.set(!1),this.imageLoadFailed.set(!1),console.log("Imagen cargada")}onImageError(){this.isLoadingImage.set(!1),this.imageLoadFailed.set(!0),console.error("Error al cargar la imagen de evidencia.")}onClose(){this.dialogRef.close()}static \u0275fac=function(t){return new(t||o)(w(he),w(fe))};static \u0275cmp=P({type:o,selectors:[["app-order-detail-dialog"]],decls:14,vars:2,consts:[["cdkDrag","","cdkDragRootElement",".cdk-overlay-pane","cdkDragHandle",".dialog-header-draggable",1,"dialog-container"],[1,"dialog-header","dialog-header-draggable"],["mat-dialog-title","",1,"dialog-title"],["mat-icon-button","","aria-label","Cerrar di\xE1logo","matTooltip","Cerrar",1,"close-button",3,"click"],[1,"evidence-dialog-content"],[1,"image-wrapper"],["alt","Foto del Pedido",1,"evidence-image",3,"src"],["class","placeholder-container",4,"ngIf"],["align","end",1,"dialog-actions"],["mat-flat-button","",1,"btn-corp-primary",3,"click"],[1,"placeholder-container"],[1,"placeholder-icon"],[1,"placeholder-text"]],template:function(t,r){t&1&&(n(0,"div",0)(1,"div",1)(2,"h2",2),l(3,"Foto del Pedido"),i(),n(4,"button",3),h("click",function(){return r.onClose()}),n(5,"mat-icon"),l(6,"close"),i()()(),n(7,"mat-dialog-content",4)(8,"div",5),v(9,"img",6),m(10,io,5,0,"div",7),i()(),n(11,"mat-dialog-actions",8)(12,"button",9),h("click",function(){return r.onClose()}),l(13,"Close"),i()()()),t&2&&(c(9),p("src",r.data.order.product_delivery_photo_url,Ye),c(),p("ngIf",!r.data.order.product_delivery_photo_url||r.imageLoadFailed()))},dependencies:[E,Y,N,Oe,ve,be,S,I,pe,D,F,L,ct,Pt,xe,Me,qt,Kt,Wt,R],styles:["[_nghost-%COMP%]{display:block}.dialog-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;max-height:calc(100vh - 80px)}.dialog-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid #e0e0e0;background-color:#f5f5f5}.dialog-header-draggable[_ngcontent-%COMP%]{cursor:move}h2.mat-mdc-dialog-title[_ngcontent-%COMP%]{margin:0;font-size:1.35em;font-weight:500;color:#455a64}.order-code-chip[_ngcontent-%COMP%]{font-size:.9em;color:#3f51b5;font-weight:500;margin-left:16px;flex-grow:1}.close-button[_ngcontent-%COMP%]{min-width:auto;padding:0;line-height:normal;color:#757575}.dialog-content[_ngcontent-%COMP%]{padding:20px 24px 24px;overflow-y:auto;flex-grow:1;background-color:#fff}.info-card[_ngcontent-%COMP%]{margin-bottom:24px;border:1px solid #eeeeee!important;box-shadow:none!important;border-radius:8px}.info-card[_ngcontent-%COMP%]:last-child{margin-bottom:0}.info-card[_ngcontent-%COMP%]   mat-card-header.compact-card-header[_ngcontent-%COMP%]{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;background-color:#fafafa;border-bottom:1px solid #eeeeee}.info-card[_ngcontent-%COMP%]   mat-card-title[_ngcontent-%COMP%]{font-size:1.1em;font-weight:500;color:#546e7a;margin:0}.info-card[_ngcontent-%COMP%]   .status-badge-dialog[_ngcontent-%COMP%]{padding:4px 10px;border-radius:12px;font-size:.7rem;font-weight:600;text-transform:uppercase;color:#fff;line-height:1.2}.info-card[_ngcontent-%COMP%]   mat-card-content[_ngcontent-%COMP%]{padding:16px;font-size:.9rem}mat-grid-list[_ngcontent-%COMP%]{padding:0}mat-grid-tile[_ngcontent-%COMP%]     .mat-figure{align-items:flex-start;padding:8px}.detail-item[_ngcontent-%COMP%]{display:flex;align-items:center;width:100%;gap:10px}.detail-item[_ngcontent-%COMP%]   .detail-icon[_ngcontent-%COMP%]{color:#90a4ae;font-size:20px}.detail-item[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{display:flex;flex-direction:column;line-height:1.4}.interactive-detail-item[_ngcontent-%COMP%]{cursor:pointer}.interactive-detail-item[_ngcontent-%COMP%]:hover   .detail-value[_ngcontent-%COMP%]{color:#3f51b5;text-decoration:underline}.link-like[_ngcontent-%COMP%]{color:#5c6bc0;font-weight:500}.detail-label[_ngcontent-%COMP%]{font-size:.75em;color:#616161;margin-bottom:2px;font-weight:500;text-transform:uppercase;letter-spacing:.5px}.detail-value[_ngcontent-%COMP%]{color:#212121;word-break:break-word}.bold-value[_ngcontent-%COMP%]{font-weight:600;font-size:1.05em}.item-description[_ngcontent-%COMP%]{font-style:italic;color:#555;margin-bottom:12px;padding-bottom:12px;border-bottom:1px dashed #e0e0e0;font-size:.9em}.detail-block[_ngcontent-%COMP%]{margin-bottom:16px}.detail-block[_ngcontent-%COMP%]   .detail-label-block[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:.9em;font-weight:500;color:#607d8b;margin-bottom:6px}.detail-block[_ngcontent-%COMP%]   .detail-label-block[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px}.detail-block[_ngcontent-%COMP%]   .detail-value-block[_ngcontent-%COMP%]{font-size:.9em;color:#424242;padding-left:26px;white-space:pre-wrap}.dialog-actions[_ngcontent-%COMP%]{padding:16px 24px;border-top:1px solid #e0e0e0;background-color:#fafafa}.dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin-left:8px}.dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-child{margin-left:0}.status-registrado[_ngcontent-%COMP%]{background-color:#6610f2;color:#fff}.status-recogido[_ngcontent-%COMP%]{background-color:#fd7e14;color:#fff}.status-en-almacen[_ngcontent-%COMP%]{background-color:#0d6efd;color:#fff}.status-en-transito[_ngcontent-%COMP%]{background-color:#0c1a77;color:#d0c8c8}.status-entregado[_ngcontent-%COMP%]{background-color:#198754;color:#fff}.status-no-entregado[_ngcontent-%COMP%]{background-color:#dc3545;color:#fff}.status-cancelado[_ngcontent-%COMP%]{background-color:#6c757d;color:#fff}.status-rechazado-en-punto[_ngcontent-%COMP%]{background-color:#ff6b6b;color:#fff}.status-reprogramado[_ngcontent-%COMP%]{background-color:#adb5bd;color:#212529}.status-desconocido[_ngcontent-%COMP%]{background-color:#9e9e9e;color:#fff}"]})};function ao(o,e){if(o&1&&(n(0,"mat-option",14),l(1),i()),o&2){let t=e.$implicit;p("value",t),c(),He(t)}}function so(o,e){o&1&&(n(0,"mat-error"),l(1,"Seleccione m\xE9todo de pago para el monto a cobrar."),i())}function lo(o,e){if(o&1&&(n(0,"mat-option",14),l(1),i()),o&2){let t=e.$implicit;p("value",t),c(),He(t)}}function co(o,e){o&1&&(n(0,"mat-error"),l(1,"Seleccione m\xE9todo de pago para costo de env\xEDo."),i())}var Ie=class o{constructor(e,t){this.dialogRef=e;this.data=t;this.deliveryDetailsForm=this.fb.group({shippingCostPaymentMethod:[null],collectionPaymentMethod:[null]})}deliveryDetailsForm;formSubmitted=!1;paymentMethods=["Efectivo","Pago directo"];paymentMethodsCostoEnvio=["Efectivo (Pago a COURIER)","Pago directo (Pago a COURIER)","Pago directo (Pago a EMPRESA)"];OrderStatusEnum=W;fb=g(ae);destroy$=new k;ngOnInit(){}onConfirm(){return U(this,null,function*(){this.formSubmitted=!0,this.dialogRef.close({shippingCostPaymentMethod:this.deliveryDetailsForm.value.shippingCostPaymentMethod,collectionPaymentMethod:this.deliveryDetailsForm.value.collectionPaymentMethod})})}onCancel(){this.dialogRef.close()}get scpmCtrl(){return this.deliveryDetailsForm.get("shippingCostPaymentMethod")}get cpmCtrl(){return this.deliveryDetailsForm.get("collectionPaymentMethod")}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||o)(w(he),w(fe))};static \u0275cmp=P({type:o,selectors:[["app-change-status-dialog"]],decls:29,vars:15,consts:[[1,"dialog-container"],[1,"dialog-header"],["mat-dialog-title",""],[1,"order-code-chip"],[3,"ngSubmit","formGroup"],[1,"dialog-content"],[1,"delivery-details-section"],["appearance","outline",1,"full-width","payment-method-field"],["formControlName","collectionPaymentMethod","name","collectionPaymentMethod"],[3,"value",4,"ngFor","ngForOf"],["formControlName","shippingCostPaymentMethod","name","shippingCostPaymentMethod"],["align","end",1,"dialog-actions"],["mat-stroked-button","","type","button",1,"cancel-button","btn-corp-secondary",3,"click"],["mat-flat-button","","type","submit",1,"confirm-button","btn-corp-primary"],[3,"value"]],template:function(t,r){t&1&&(n(0,"div",0)(1,"div",1)(2,"h2",2),l(3,"Modificar los tipos de pago"),i(),n(4,"span",3),l(5),i()(),n(6,"form",4),h("ngSubmit",function(){return r.onConfirm()}),n(7,"mat-dialog-content",5)(8,"div",6),v(9,"mat-divider"),n(10,"mat-form-field",7)(11,"mat-label"),l(12),y(13,"number"),i(),n(14,"mat-select",8),m(15,ao,2,2,"mat-option",9),i(),m(16,so,2,0,"mat-error"),i(),n(17,"mat-form-field",7)(18,"mat-label"),l(19),y(20,"number"),i(),n(21,"mat-select",10),m(22,lo,2,2,"mat-option",9),i(),m(23,co,2,0,"mat-error"),i()()(),n(24,"mat-dialog-actions",11)(25,"button",12),h("click",function(){return r.onCancel()}),l(26," Cancelar "),i(),n(27,"button",13),l(28),i()()()()),t&2&&(c(5),u("Pedido N\xB0: ",r.data.order.code||r.data.order.id,""),c(),p("formGroup",r.deliveryDetailsForm),c(6),u("M\xE9todo Pago Cobro (S/ ",je(13,9,r.data.order.amount_to_collect_at_delivery,"1.2-2"),")"),c(3),p("ngForOf",r.paymentMethods),c(),ze(r.formSubmitted&&(r.cpmCtrl!=null&&r.cpmCtrl.hasError("required"))?16:-1),c(3),u("M\xE9todo Pago Costo Env\xEDo (S/ ",je(20,12,r.data.order.shipping_cost,"1.2-2"),")"),c(3),p("ngForOf",r.paymentMethodsCostoEnvio),c(),ze(r.formSubmitted&&(r.scpmCtrl!=null&&r.scpmCtrl.hasError("required"))?23:-1),c(5),u(" ","Confirmar Cambio"," "))},dependencies:[E,rt,nt,pt,re,te,oe,se,ne,ie,N,Oe,ve,be,de,ce,le,gt,ye,Bt,yt,me,S,I,_t,D,R,L,vt],styles:[".dialog-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;max-height:80vh}.dialog-header[_ngcontent-%COMP%]{padding:20px 24px 0;border-bottom:1px solid var(--sys-outline-variant);margin-bottom:20px}.dialog-header[_ngcontent-%COMP%]   h2.mat-mdc-dialog-title[_ngcontent-%COMP%]{margin-bottom:4px;font-size:1.5em;font-weight:500;color:var(--sys-on-surface)}.order-code-chip[_ngcontent-%COMP%]{display:block;font-size:.85em;text-align:center;font-family:Consolas,Monaco,monospace}.dialog-content[_ngcontent-%COMP%]{padding:0 24px 20px;overflow-y:auto;flex-grow:1}.current-status-container[_ngcontent-%COMP%]{display:flex;align-items:center;margin-bottom:24px;font-size:1em;color:var(--sys-on-surface-variant)}.current-status-container[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:first-child{margin-right:8px}.status-badge[_ngcontent-%COMP%]{padding:5px 12px;border-radius:16px;font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;display:inline-flex;align-items:center;line-height:1;color:var(--sys-on-surface)}.status-registrado[_ngcontent-%COMP%]{background-color:var(--status-registrado-bg);color:var(--status-registrado-color)}.status-recogido[_ngcontent-%COMP%]{background-color:var(--status-recogido-bg);color:var(--status-recogido-color)}.status-en-almacen[_ngcontent-%COMP%]{background-color:var(--status-en-almacen-bg);color:var(--status-en-almacen-color)}.status-en-transito[_ngcontent-%COMP%]{background-color:var(--status-en-transito-bg);color:var(--status-en-transito-color)}.status-entregado[_ngcontent-%COMP%]{background-color:var(--status-entregado-bg);color:var(--status-entregado-color)}.status-no-entregado[_ngcontent-%COMP%]{background-color:var(--status-no-entregado-bg);color:var(--status-no-entregado-color)}.status-cancelado[_ngcontent-%COMP%]{background-color:var(--status-cancelado-bg);color:var(--status-cancelado-color)}.status-rechazado-en-punto[_ngcontent-%COMP%]{background-color:var(--status-rechazado-bg);color:var(--status-rechazado-color)}.status-reprogramado[_ngcontent-%COMP%]{background-color:var(--status-reprogramado-bg);color:var(--status-reprogramado-color)}.full-width[_ngcontent-%COMP%]{width:100%}.select-status-field[_ngcontent-%COMP%]{margin-bottom:20px}.reason-field[_ngcontent-%COMP%]{margin-top:10px}.reason-field[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{min-height:60px}.dialog-actions[_ngcontent-%COMP%]{padding:16px 24px;gap:10px}.dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%], .dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-child{margin-left:0}@media (max-width: 480px){.dialog-actions[_ngcontent-%COMP%]{gap:10px;flex-direction:row-reverse}}[_nghost-%COMP%]     .mat-mdc-form-field-subscript-wrapper{min-height:1.25em;height:auto}.delivery-details-section[_ngcontent-%COMP%]{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:center;margin-top:20px;padding-top:20px;border-top:1px solid rgba(0,0,0,.12)}.delivery-details-section[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{font-size:1.1em;font-weight:500;margin-bottom:16px;color:#444}.image-upload-container[_ngcontent-%COMP%]{margin-bottom:10px}.image-upload-container[_ngcontent-%COMP%]   .image-upload-label[_ngcontent-%COMP%]{text-align:center;width:100%;display:block;font-size:.9em;color:#555;margin-bottom:8px;font-weight:500}.image-upload-container[_ngcontent-%COMP%]   .upload-button[_ngcontent-%COMP%]{padding:15px!important}.image-preview-wrapper[_ngcontent-%COMP%]{position:relative;display:inline-block;border:1px solid #ddd;padding:5px;border-radius:4px;background-color:#f9f9f9;margin-top:10px}.image-preview-wrapper[_ngcontent-%COMP%]   .image-preview[_ngcontent-%COMP%]{display:block;max-width:100%;max-height:200px;border-radius:3px}.image-preview-wrapper[_ngcontent-%COMP%]   .remove-image-button[_ngcontent-%COMP%]{position:absolute;top:-10px;right:-10px;background-color:#fffc;line-height:normal;padding:0;width:28px;height:28px}.image-preview-wrapper[_ngcontent-%COMP%]   .remove-image-button[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:20px}.upload-spinner[_ngcontent-%COMP%]{display:flex;align-items:center;font-size:.9em;color:#555;margin-top:10px}.upload-spinner[_ngcontent-%COMP%]   mat-progress-spinner[_ngcontent-%COMP%]{margin-right:8px}.payment-method-field[_ngcontent-%COMP%]{margin-top:16px}.close-button-header[_ngcontent-%COMP%]{min-width:auto;padding:0;line-height:normal;color:#757575}.camera-view[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px}.video-preview[_ngcontent-%COMP%]{width:100%;height:300px}"]})};var mo=()=>[10,25,50,100],po=()=>({"highlight-row":!1});function go(o,e){o&1&&(n(0,"div",40),v(1,"mat-progress-spinner",41),i())}function uo(o,e){o&1&&(n(0,"th",42),l(1,"N\xB0 Pedido"),i())}function _o(o,e){if(o&1&&(n(0,"td",43),l(1),i()),o&2){let t=e.$implicit;c(),u(" ",t.code," ")}}function ho(o,e){o&1&&(n(0,"th",42),l(1,"Empresa"),i())}function fo(o,e){if(o&1&&(n(0,"td",44),l(1),i()),o&2){let t=e.$implicit;p("matTooltip",t.company==null?null:t.company.username),c(),u(" ",t.company==null?null:t.company.username," ")}}function Co(o,e){o&1&&(n(0,"th",42),l(1,"Destinatario"),i())}function Oo(o,e){if(o&1&&(n(0,"td",44),l(1),i()),o&2){let t=e.$implicit;p("matTooltip",t.recipient_name),c(),u(" ",t.recipient_name," ")}}function bo(o,e){o&1&&(n(0,"th",42),l(1,"Distrito"),i())}function vo(o,e){if(o&1&&(n(0,"td",45),l(1),i()),o&2){let t=e.$implicit;c(),u(" ",t.delivery_district_name," ")}}function yo(o,e){o&1&&(n(0,"th",46),l(1," Motorizado "),i())}function Mo(o,e){if(o&1&&(n(0,"td",45),l(1),i()),o&2){let t=e.$implicit;c(),u(" ",t.assigned_driver==null?null:t.assigned_driver.username," ")}}function xo(o,e){o&1&&(n(0,"th",47),l(1," Monto cobrar "),i())}function Po(o,e){if(o&1&&(n(0,"td",48),l(1),y(2,"currency"),i()),o&2){let t=e.$implicit;c(),u(" ",T(2,1,t.amount_to_collect_at_delivery,"PEN","","1.2-2")," ")}}function Eo(o,e){o&1&&(n(0,"th",49),l(1," Estado "),i())}function So(o,e){if(o&1&&(n(0,"td",45),l(1),i()),o&2){let t=e.$implicit;c(),u(" ",t.status," ")}}function Do(o,e){o&1&&(n(0,"th",50),l(1," Efectivo "),i())}function To(o,e){if(o&1&&(n(0,"td",51),l(1),y(2,"currency"),i()),o&2){let t=e.$implicit;c(),u(" ",T(2,1,t.efectivo_monto_cobrar,"PEN","","1.2-2")," ")}}function wo(o,e){o&1&&(n(0,"th",52),l(1," Pago directo "),i())}function Io(o,e){if(o&1&&(n(0,"td",51),l(1),y(2,"currency"),i()),o&2){let t=e.$implicit;c(),u(" ",T(2,1,t.pago_directo_monto_cobrar,"PEN","","1.2-2")," ")}}function ko(o,e){o&1&&(n(0,"th",53),l(1," Efectivo a courier "),i())}function Ao(o,e){if(o&1&&(n(0,"td",51),l(1),y(2,"currency"),i()),o&2){let t=e.$implicit;c(),u(" ",T(2,1,t.efectivo_courier_costo_servicio,"PEN","","1.2-2")," ")}}function Ro(o,e){o&1&&(n(0,"th",54),l(1," Pago directo a courier "),i())}function Fo(o,e){if(o&1&&(n(0,"td",55),l(1),y(2,"currency"),i()),o&2){let t=e.$implicit;c(),u(" ",T(2,1,t.pago_directo_courier_costo_servicio,"PEN","","1.2-2")," ")}}function No(o,e){o&1&&(n(0,"th",56),l(1," Pago directo a empresa "),i())}function Lo(o,e){if(o&1&&(n(0,"td",55),l(1),y(2,"currency"),i()),o&2){let t=e.$implicit;c(),u(" ",T(2,1,t.pago_directo_empresa_costo_servicio,"PEN","","1.2-2")," ")}}function zo(o,e){o&1&&(n(0,"th",47),l(1," Costo envio "),i())}function Bo(o,e){if(o&1&&(n(0,"td",48),l(1),y(2,"currency"),i()),o&2){let t=e.$implicit;c(),u(" ",T(2,1,t.shipping_cost,"PEN","","1.2-2")," ")}}function Go(o,e){o&1&&(n(0,"th",47),l(1," Diferencia "),i())}function Uo(o,e){if(o&1&&(n(0,"td",48),l(1),y(2,"currency"),i()),o&2){let t=e.$implicit;c(),u(" ",T(2,1,t.diferencia,"PEN","","1.2-2")," ")}}function Ho(o,e){o&1&&(n(0,"th",57),l(1," Acciones "),i())}function $o(o,e){if(o&1){let t=Z();n(0,"button",62),h("click",function(){H(t);let a=j().$implicit,d=j();return $(d.openChangePaymentTypeModal(a))}),n(1,"mat-icon"),l(2,"attach_money"),i(),n(3,"span"),l(4,"Modificar los tipos de pago"),i()()}}function jo(o,e){if(o&1&&(n(0,"td",58)(1,"button",59)(2,"mat-icon"),l(3,"more_vert"),i()(),n(4,"mat-menu",60,0),m(6,$o,5,0,"button",61),i()()),o&2){let t=J(5),r=j();c(),p("matMenuTriggerFor",t),c(5),p("ngIf",r.hasPermissionEdit())}}function Vo(o,e){o&1&&v(0,"tr",63)}function Xo(o,e){o&1&&v(0,"tr",64),o&2&&p("ngClass",$e(1,po))}function Wo(o,e){if(o&1&&(n(0,"tr",65)(1,"td",66),l(2," No se encontraron pedidos que coincidan con los filtros. "),i()()),o&2){let t=j();c(),et("colspan",t.displayedColumns.length)}}var ke=class o{constructor(e){this.http=e}appStore=g(ft);orders=[];isLoading=!1;totalCount=0;pageSize=10;pageIndex=0;pageChanged=new x;sortChanged=new x;statusChanged=new x;motorizedChanged=new x;rescheduleChanged=new x;viewPdfClicked=new x;viewDetailsClicked=new x;paymentTypeChanged=new x;displayedColumns=["code","company","recipient_name","delivery_district_name","motorizado","status","amount_to_collect_at_delivery","efectivo_monto_cobrar","pago_directo_monto_cobrar","shipping_cost","efectivo_courier_costo_servicio","pago_directo_courier_costo_servicio","pago_directo_empresa_costo_servicio","diferencia","actions"];dataSource=new zt;paginator;sort;dialog=g(Ce);snackBar=g(ge);OrderStatus=W;ngOnChanges(e){e.orders&&this.orders&&(this.dataSource.data=this.orders)}ngAfterViewInit(){}canMarkAs(e,t){let r=e.status;return!1}onViewPdf(e){this.http.get(e.product_delivery_photo_url||"",{responseType:"blob"}).subscribe(t=>{let r=document.createElement("a");r.href=URL.createObjectURL(t),r.download="filename",document.body.appendChild(r),r.click(),document.body.removeChild(r)})}onSeguimiento(e){window.open("/tracking?code="+e.tracking_code,"_blank")}changeOrderStatus(e,t){console.log(`Changing status of order ${e.code} to ${t}`),this.statusChanged.emit({orderId:e.id,newStatus:t})}getStatusClass(e){return e?`status-${e.toLowerCase().replace(/[\s_]+/g,"-")}`:"status-desconocido"}getAvailableStatuses(e){switch(e.status){case"REGISTRADO":return["RECOGIDO","CANCELADO"];case"RECOGIDO":return["EN ALMACEN","CANCELADO"];case"EN ALMACEN":return["EN TRANSITO","CANCELADO"];case"EN TRANSITO":case"EN TRANSITO":return["ENTREGADO","CANCELADO","RECHAZADO EN PUNTO","REPROGRAMADO"];case"REPROGRAMADO":return["EN TRANSITO","CANCELADO"];default:return[]}}onViewOrderDetails(e){this.viewDetailsClicked.emit(e),this.dialog.open(we,{width:"750px",maxWidth:"90vw",maxHeight:"90vh",data:{order:e},panelClass:"order-detail-dialog-responsive",autoFocus:"dialog"})}onUploadProof(e){console.log("Upload proof for order:",e.code),this.snackBar.open('Funci\xF3n "Subir Prueba" no implementada.',"OK",{duration:2e3})}onReschedule(e){console.log("Reschedule order:",e.code),this.snackBar.open('Funci\xF3n "Reprogramar" no implementada.',"OK",{duration:2e3})}isAdminOrDriver(){return!0}isAdminUser(){return!0}hasPermissionEdit(){let e=this.appStore.currentUser()?.role;return e==="ADMINISTRADOR"||e==="RECEPCIONISTA"}openChangePaymentTypeModal(e){if(!e.id){this.snackBar.open("No es posible modificar","OK",{duration:3e3});return}this.dialog.open(Ie,{width:"450px",data:{order:e,availableStatuses:[]},disableClose:!0}).afterClosed().subscribe(r=>{if(console.log("result",r),!r)return;console.log("Dialog result:",r);let a={shippingCostPaymentMethod:"",collectionPaymentMethod:""};a.shippingCostPaymentMethod=r.shippingCostPaymentMethod,a.collectionPaymentMethod=r.collectionPaymentMethod,console.log("updatePayload",a),this.paymentTypeChanged.emit(G({orderId:e.id},a))})}static \u0275fac=function(t){return new(t||o)(w(ee))};static \u0275cmp=P({type:o,selectors:[["app-order-table"]],viewQuery:function(t,r){if(t&1&&(Be(Pe,5),Be(Ee,5)),t&2){let a;Ge(a=Ue())&&(r.paginator=a.first),Ge(a=Ue())&&(r.sort=a.first)}},inputs:{orders:"orders",isLoading:"isLoading",totalCount:"totalCount",pageSize:"pageSize",pageIndex:"pageIndex"},outputs:{pageChanged:"pageChanged",sortChanged:"sortChanged",statusChanged:"statusChanged",motorizedChanged:"motorizedChanged",rescheduleChanged:"rescheduleChanged",viewPdfClicked:"viewPdfClicked",viewDetailsClicked:"viewDetailsClicked",paymentTypeChanged:"paymentTypeChanged"},features:[Je],decls:52,vars:10,consts:[["orderActionMenu","matMenu"],[1,"table-wrapper","mat-elevation-z4"],["class","spinner-overlay",4,"ngIf"],["mat-table","","matSort","",1,"orders-table",3,"matSortChange","dataSource"],["matColumnDef","code"],["mat-header-cell","","mat-sort-header","",4,"matHeaderCellDef"],["mat-cell","","class","",4,"matCellDef"],["matColumnDef","company"],["mat-cell","","class","truncate-texts",3,"matTooltip",4,"matCellDef"],["matColumnDef","recipient_name"],["matColumnDef","delivery_district_name"],["mat-cell","",4,"matCellDef"],["matColumnDef","motorizado"],["mat-header-cell","","mat-sort-header","motorizado",4,"matHeaderCellDef"],["matColumnDef","amount_to_collect_at_delivery"],["mat-header-cell","","mat-sort-header","","class","align-right",4,"matHeaderCellDef"],["mat-cell","","class","align-right amount-cell",4,"matCellDef"],["matColumnDef","status"],["mat-header-cell","","mat-sort-header","","class","status-column-header",4,"matHeaderCellDef"],["matColumnDef","efectivo_monto_cobrar"],["mat-header-cell","","mat-sort-header","efectivo_monto_cobrar",4,"matHeaderCellDef"],["mat-cell","","class","amount-cell",4,"matCellDef"],["matColumnDef","pago_directo_monto_cobrar"],["mat-header-cell","","mat-sort-header","pago_directo_monto_cobrar",4,"matHeaderCellDef"],["matColumnDef","efectivo_courier_costo_servicio"],["mat-header-cell","","mat-sort-header","efectivo_courier_costo_servicio",4,"matHeaderCellDef"],["matColumnDef","pago_directo_courier_costo_servicio"],["mat-header-cell","","mat-sort-header","pago_directo_courier_costo_servicio",4,"matHeaderCellDef"],["mat-cell","","class","amount-cell","style","min-width: 135px; border: 0px solid black",4,"matCellDef"],["matColumnDef","pago_directo_empresa_costo_servicio"],["mat-header-cell","","mat-sort-header","pago_directo_empresa_costo_servicio",4,"matHeaderCellDef"],["matColumnDef","shipping_cost"],["matColumnDef","diferencia"],["matColumnDef","actions"],["mat-header-cell","","class","actions-column-header",4,"matHeaderCellDef"],["mat-cell","","class","actions-cell",4,"matCellDef"],["mat-header-row","","class","header-row-sticky",4,"matHeaderRowDef","matHeaderRowDefSticky"],["mat-row","","class","data-row",3,"ngClass",4,"matRowDef","matRowDefColumns"],["class","mat-row",4,"matNoDataRow"],["showFirstLastButtons","","aria-label","Seleccione p\xE1gina de pedidos",3,"page","length","pageSize","pageIndex","pageSizeOptions"],[1,"spinner-overlay"],["mode","indeterminate","diameter","60"],["mat-header-cell","","mat-sort-header",""],["mat-cell","",1,""],["mat-cell","",1,"truncate-texts",3,"matTooltip"],["mat-cell",""],["mat-header-cell","","mat-sort-header","motorizado"],["mat-header-cell","","mat-sort-header","",1,"align-right"],["mat-cell","",1,"align-right","amount-cell"],["mat-header-cell","","mat-sort-header","",1,"status-column-header"],["mat-header-cell","","mat-sort-header","efectivo_monto_cobrar"],["mat-cell","",1,"amount-cell"],["mat-header-cell","","mat-sort-header","pago_directo_monto_cobrar"],["mat-header-cell","","mat-sort-header","efectivo_courier_costo_servicio"],["mat-header-cell","","mat-sort-header","pago_directo_courier_costo_servicio"],["mat-cell","",1,"amount-cell",2,"min-width","135px","border","0px solid black"],["mat-header-cell","","mat-sort-header","pago_directo_empresa_costo_servicio"],["mat-header-cell","",1,"actions-column-header"],["mat-cell","",1,"actions-cell"],["mat-icon-button","","aria-label","M\xE1s acciones del pedido",1,"action-icon-neutral",3,"matMenuTriggerFor"],["xPosition","before"],["mat-menu-item","",3,"click",4,"ngIf"],["mat-menu-item","",3,"click"],["mat-header-row","",1,"header-row-sticky"],["mat-row","",1,"data-row",3,"ngClass"],[1,"mat-row"],[1,"no-data-cell"]],template:function(t,r){t&1&&(n(0,"div",1),m(1,go,2,0,"div",2),n(2,"table",3),h("matSortChange",function(d){return r.sortChanged.emit(d)}),f(3,4),m(4,uo,2,0,"th",5)(5,_o,2,1,"td",6),C(),f(6,7),m(7,ho,2,0,"th",5)(8,fo,2,2,"td",8),C(),f(9,9),m(10,Co,2,0,"th",5)(11,Oo,2,2,"td",8),C(),f(12,10),m(13,bo,2,0,"th",5)(14,vo,2,1,"td",11),C(),f(15,12),m(16,yo,2,0,"th",13)(17,Mo,2,1,"td",11),C(),f(18,14),m(19,xo,2,0,"th",15)(20,Po,3,6,"td",16),C(),f(21,17),m(22,Eo,2,0,"th",18)(23,So,2,1,"td",11),C(),f(24,19),m(25,Do,2,0,"th",20)(26,To,3,6,"td",21),C(),f(27,22),m(28,wo,2,0,"th",23)(29,Io,3,6,"td",21),C(),f(30,24),m(31,ko,2,0,"th",25)(32,Ao,3,6,"td",21),C(),f(33,26),m(34,Ro,2,0,"th",27)(35,Fo,3,6,"td",28),C(),f(36,29),m(37,No,2,0,"th",30)(38,Lo,3,6,"td",28),C(),f(39,31),m(40,zo,2,0,"th",15)(41,Bo,3,6,"td",16),C(),f(42,32),m(43,Go,2,0,"th",15)(44,Uo,3,6,"td",16),C(),f(45,33),m(46,Ho,2,0,"th",34)(47,jo,7,2,"td",35),C(),m(48,Vo,1,0,"tr",36)(49,Xo,1,2,"tr",37)(50,Wo,3,1,"tr",38),i(),n(51,"mat-paginator",39),h("page",function(d){return r.pageChanged.emit(d)}),i()()),t&2&&(c(),p("ngIf",r.isLoading),c(),p("dataSource",r.dataSource),c(46),p("matHeaderRowDef",r.displayedColumns)("matHeaderRowDefSticky",!0),c(),p("matRowDefColumns",r.displayedColumns),c(2),p("length",r.totalCount)("pageSize",r.pageSize)("pageIndex",r.pageIndex)("pageSizeOptions",$e(9,mo)))},dependencies:[E,ot,Y,it,Lt,Et,Dt,kt,Tt,St,At,wt,It,Rt,Ft,Nt,Gt,Pe,Ht,Ee,Ut,R,dt,S,pe,D,F,xe,Me,_e,Ot,Ct,bt,N,ue,L],styles:["[_nghost-%COMP%]{display:block}.table-wrapper[_ngcontent-%COMP%]{position:relative;overflow:auto;background-color:var(--sys-surface);color:var(--sys-on-surface);margin-top:20px;box-shadow:0 4px 20px #00000014;transition:box-shadow .3s ease-in-out}.table-wrapper[_ngcontent-%COMP%]:hover{box-shadow:0 6px 25px #0000001f}.spinner-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background-color:rgba(var(--sys-surface),.85);display:flex;justify-content:center;align-items:center;z-index:100;border-radius:12px}.orders-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th.mat-header-cell[_ngcontent-%COMP%]{font-weight:600;color:var(--sys-on-surface-variant);background-color:var(--sys-surface-container-low);padding:14px 18px;border-bottom:1px solid var(--sys-outline-variant);text-transform:uppercase;font-size:.8rem;letter-spacing:.5px}td.mat-cell[_ngcontent-%COMP%]{padding:12px 18px;border-bottom:1px solid var(--sys-outline-variant);color:var(--sys-on-surface-variant);font-size:.9rem}.header-row-sticky[_ngcontent-%COMP%]{position:sticky;top:0;z-index:10;background-color:var(--sys-surface-container-low)}.data-row[_ngcontent-%COMP%]{transition:background-color .2s ease-in-out}.data-row[_ngcontent-%COMP%]:hover{background-color:var(--sys-surface-container-highest);cursor:pointer}.highlight-row[_ngcontent-%COMP%]{background-color:var(--sys-primary-container)!important;font-weight:500}.align-right[_ngcontent-%COMP%]{text-align:right;justify-content:flex-end}.amount-cell[_ngcontent-%COMP%]{font-weight:500;text-align:right}.actions-column-header[_ngcontent-%COMP%]{text-align:center!important}.actions-cell[_ngcontent-%COMP%]{display:flex;text-align:center;white-space:nowrap}.actions-cell[_ngcontent-%COMP%]   button.mat-icon-button[_ngcontent-%COMP%]{margin:0 2px;color:var(--sys-on-surface-variant);transition:color .2s ease}.actions-cell[_ngcontent-%COMP%]   button.mat-icon-button[_ngcontent-%COMP%]:hover{color:var(--sys-primary)}.action-icon-delivered[_ngcontent-%COMP%]{color:#4caf50}.action-icon-delivered[_ngcontent-%COMP%]:hover{color:#388e3c}.action-icon-neutral[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant)}.action-icon-neutral[_ngcontent-%COMP%]:hover{color:var(--sys-on-surface)}.no-data-cell[_ngcontent-%COMP%]{text-align:center;padding:50px;font-style:italic;color:var(--sys-on-surface-variant);font-size:1rem}.mat-mdc-paginator[_ngcontent-%COMP%]{background-color:var(--sys-surface-container-low);border-bottom-left-radius:12px;border-bottom-right-radius:12px;color:var(--sys-on-surface-variant);border-top:1px solid var(--sys-outline-variant);padding:8px 0}.truncate-text[_ngcontent-%COMP%]{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:middle}.code-cell[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:#3f51b5;text-decoration:none;font-weight:500}.code-cell[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:hover{text-decoration:underline}.status-badge[_ngcontent-%COMP%]{padding:5px 12px;border-radius:16px;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;display:inline-flex;align-items:center;line-height:1}.status-registrado[_ngcontent-%COMP%]{background-color:var(--status-registrado-bg);color:var(--status-registrado-color)}.status-recogido[_ngcontent-%COMP%]{background-color:var(--status-recogido-bg);color:var(--status-recogido-color)}.status-en-almacen[_ngcontent-%COMP%]{background-color:var(--status-en-almacen-bg);color:var(--status-en-almacen-color)}.status-en-transito[_ngcontent-%COMP%]{background-color:var(--status-en-transito-bg);color:var(--status-en-transito-color)}.status-entregado[_ngcontent-%COMP%]{background-color:var(--status-entregado-bg);color:var(--status-entregado-color)}.status-no-entregado[_ngcontent-%COMP%]{background-color:var(--status-no-entregado-bg);color:var(--status-no-entregado-color)}.status-cancelado[_ngcontent-%COMP%]{background-color:var(--status-cancelado-bg);color:var(--status-cancelado-color)}.status-rechazado-en-punto[_ngcontent-%COMP%]{background-color:var(--status-rechazado-bg);color:var(--status-rechazado-color)}.status-reprogramado[_ngcontent-%COMP%]{background-color:var(--status-reprogramado-bg);color:var(--status-reprogramado-color)}@media (max-width: 768px){th.mat-header-cell[_ngcontent-%COMP%], td.mat-cell[_ngcontent-%COMP%]{padding:8px 12px;font-size:.75rem}}"]})};var Ko="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-TFG-8",qo=".xlsx",Ae=class o{constructor(){}exportAsExcelFile(e,t,r="Sheet1"){if(!e||e.length===0){console.warn("No data provided for Excel export.");return}let a=Zt.json_to_sheet(e),d=this.calculateColumnWidths(e);a["!cols"]=d;let s={Sheets:{[r]:a},SheetNames:[r]},M=Qt(s,{bookType:"xlsx",type:"array"});this.saveAsExcelFile(M,t)}saveAsExcelFile(e,t){let r=new Blob([e],{type:Ko}),a=window.URL.createObjectURL(r),d=document.createElement("a");d.href=a,d.download=`${t}${qo}`,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(a)}calculateColumnWidths(e){if(!e||e.length===0)return[];let t=[];return Object.keys(e[0]).forEach(a=>{let d=Math.max(a.length,...e.map(s=>s[a]?String(s[a]).length:0));t.push({wch:d+1})}),t}static \u0275fac=function(t){return new(t||o)};static \u0275prov=Q({token:o,factory:o.\u0275fac,providedIn:"root"})};var Re=class o{orderService=g(z);router=g(at);snackBar=g(ge);dialog=g(Ce);excelExportService=g(Ae);datePipe=g(V);orders=[];isLoading=!1;totalOrderCount=0;currentPageIndex=0;currentPageSize=10;currentSortField="registration_date";currentSortDirection="desc";filterCriteriaSubject=new Ke({});destroy$=new k;constructor(){}ngOnInit(){this.filterCriteriaSubject.pipe(A(this.destroy$),q(()=>this.currentPageIndex=0)).subscribe(e=>{this.fetchOrders()})}getAllFilteredOrdersForExport(){return U(this,null,function*(){try{let e=this.filterCriteriaSubject.value;return(yield qe(this.orderService.getOrders2(e,this.currentSortField,this.currentSortDirection).pipe(A(this.destroy$))))||[]}catch(e){return console.error("Error fetching all filtered orders for export:",e),this.snackBar.open("Failed to fetch data for export.","Close",{duration:3e3,panelClass:["error-snackbar"]}),[]}})}exportDataToExcel(){return U(this,null,function*(){this.isLoading=!0,this.snackBar.open("Preparando la exportaci\xF3n a Excel, esto puede tardar un momento...","",{duration:0});try{let e={amount_to_collect_at_delivery:0,efectivo_monto_cobrar:0,pago_directo_monto_cobrar:0,shipping_cost:0,efectivo_courier_costo_servicio:0,pago_directo_courier_costo_servicio:0,pago_directo_empresa_costo_servicio:0,diferencia:0},t=yield this.getAllFilteredOrdersForExport();if(t&&t.length>0){let r=t.map(s=>{s.efectivo_monto_cobrar=s.payment_method_for_collection==="Efectivo"?s.amount_to_collect_at_delivery:0,s.pago_directo_monto_cobrar=s.payment_method_for_collection==="Pago directo"?s.amount_to_collect_at_delivery:0,s.efectivo_courier_costo_servicio=s.payment_method_for_shipping_cost==="Efectivo (Pago a COURIER)"?s.shipping_cost:0,s.pago_directo_courier_costo_servicio=s.payment_method_for_shipping_cost==="Pago directo (Pago a COURIER)"?s.shipping_cost:0,s.pago_directo_empresa_costo_servicio=s.payment_method_for_shipping_cost==="Pago directo (Pago a EMPRESA)"?s.shipping_cost:0;let M=0,_=s.amount_to_collect_at_delivery,eo=s.efectivo_courier_costo_servicio||s.pago_directo_courier_costo_servicio;return s.pago_directo_monto_cobrar===s.amount_to_collect_at_delivery?_=0:M=_,eo===0&&(M=_-s.shipping_cost),s.diferencia=M,e.amount_to_collect_at_delivery+=Number(s.amount_to_collect_at_delivery)||0,e.efectivo_monto_cobrar+=s.efectivo_monto_cobrar,e.pago_directo_monto_cobrar+=s.pago_directo_monto_cobrar,e.shipping_cost+=Number(s.shipping_cost)||0,e.efectivo_courier_costo_servicio+=s.efectivo_courier_costo_servicio,e.pago_directo_courier_costo_servicio+=s.pago_directo_courier_costo_servicio,e.pago_directo_empresa_costo_servicio+=s.pago_directo_empresa_costo_servicio,e.diferencia+=M,{"N\xB0 PEDIDO":s.code,"TIPO DE PEDIDO":s.shipment_type,EMPRESA:s.company?.username,CLIENTE:s.recipient_name,DISTRITO:s.delivery_district_name,"FECHA DE REGISTRO":s.createdAt?this.datePipe.transform(s.createdAt,"dd/MM/yyyy"):"N/A",ESTADO:s.status,"MONTO A COBRAR":s.amount_to_collect_at_delivery,EFECTIVO:s.efectivo_monto_cobrar,"PAGO DIRECTO":s.pago_directo_monto_cobrar,"COSTO ENVIO":s.shipping_cost,"PAGO EFECTIVO A COURIER":s.efectivo_courier_costo_servicio,"PAGO DIRECTO A COURIER":s.pago_directo_courier_costo_servicio,"PAGO DIRECTO A EMPRESA":s.pago_directo_empresa_costo_servicio,DIFERENCIA:M}}),a={"N\xB0 PEDIDO":"","TIPO DE PEDIDO":"",EMPRESA:"",CLIENTE:"",DISTRITO:"","FECHA DE REGISTRO":"",ESTADO:"","MONTO A COBRAR":null,EFECTIVO:null,"PAGO DIRECTO":null,"COSTO ENVIO":null,"PAGO EFECTIVO A COURIER":null,"PAGO DIRECTO A COURIER":null,"PAGO DIRECTO A EMPRESA":null,DIFERENCIA:null},d={"N\xB0 PEDIDO":"TOTALES","TIPO DE PEDIDO":"",EMPRESA:"",CLIENTE:"",DISTRITO:"","FECHA DE REGISTRO":"",ESTADO:"","MONTO A COBRAR":e.amount_to_collect_at_delivery,EFECTIVO:e.efectivo_monto_cobrar,"PAGO DIRECTO":e.pago_directo_monto_cobrar,"COSTO ENVIO":e.shipping_cost,"PAGO EFECTIVO A COURIER":e.efectivo_courier_costo_servicio,"PAGO DIRECTO A COURIER":e.pago_directo_courier_costo_servicio,"PAGO DIRECTO A EMPRESA":e.pago_directo_empresa_costo_servicio,DIFERENCIA:e.diferencia};r.push(a),r.push(d),this.excelExportService.exportAsExcelFile(r,"Listado_Pedidos_Filtrados","Pedidos"),this.snackBar.dismiss(),this.snackBar.open("Archivo de Excel exportado exitosamente!","OK",{duration:3500,panelClass:["success-snackbar"]})}else this.snackBar.dismiss(),this.snackBar.open("No hay datos disponibles para exportar con los filtros actuales.","OK",{duration:3e3})}catch(e){console.error("Error during Excel export process:",e),this.snackBar.dismiss(),this.snackBar.open("Se produjo un error durante la exportaci\xF3n a Excel.","Close",{duration:3e3,panelClass:["error-snackbar"]})}finally{this.isLoading=!1}})}fetchOrders(){this.isLoading=!0;let e=this.filterCriteriaSubject.value;this.orderService.getOrders(e,this.currentPageIndex+1,this.currentPageSize,this.currentSortField,this.currentSortDirection).pipe(A(this.destroy$),b(t=>(this.snackBar.open(t.message||"Failed to load orders.","Close",{duration:5e3,panelClass:["error-snackbar"]}),this.isLoading=!1,[]))).subscribe(t=>{t.items.forEach(r=>{r.efectivo_monto_cobrar=r.payment_method_for_collection==="Efectivo"?r.amount_to_collect_at_delivery:0,r.pago_directo_monto_cobrar=r.payment_method_for_collection==="Pago directo"?r.amount_to_collect_at_delivery:0,r.efectivo_courier_costo_servicio=r.payment_method_for_shipping_cost==="Efectivo (Pago a COURIER)"?r.shipping_cost:0,r.pago_directo_courier_costo_servicio=r.payment_method_for_shipping_cost==="Pago directo (Pago a COURIER)"?r.shipping_cost:0,r.pago_directo_empresa_costo_servicio=r.payment_method_for_shipping_cost==="Pago directo (Pago a EMPRESA)"?r.shipping_cost:0;let a=0,d=r.amount_to_collect_at_delivery||0,s=r.efectivo_courier_costo_servicio||r.pago_directo_courier_costo_servicio;r.pago_directo_monto_cobrar===r.amount_to_collect_at_delivery?d=0:a=d,s===0&&(a=d-(r.shipping_cost||0)),r.diferencia=a}),this.orders=t.items,this.totalOrderCount=t.total_count||0,this.isLoading=!1})}handlePaymentTypeChanged(e){this.isLoading=!0,console.log("OrderListPage: Status change requested",e),this.orderService.updateOrderPaymentType(e.orderId,e.shippingCostPaymentMethod,e.collectionPaymentMethod).subscribe({next:t=>{this.snackBar.open("Pedido actualizado.","OK",{duration:3e3,panelClass:["success-snackbar"]}),this.fetchOrders()},error:t=>{this.snackBar.open(`Error al actualizar estado: ${t.message||"Intente de nuevo"}`,"Cerrar",{duration:5e3,panelClass:["error-snackbar"]}),this.isLoading=!1},complete:()=>{this.isLoading=!1}})}onFiltersChanged(e){console.log("OrderListPage: Filters changed",e),this.filterCriteriaSubject.next(e)}onPageChanged(e){console.log("OrderListPage: Page changed",e),this.currentPageIndex=e.pageIndex,this.currentPageSize=e.pageSize,this.fetchOrders()}onSortChanged(e){console.log("OrderListPage: Sort changed",e),this.currentSortField=e.active,this.currentSortDirection=e.direction,this.currentPageIndex=0,this.fetchOrders()}handleMassiveActions(e){console.log("Massive action selected:",e),this.snackBar.open(`Action: ${e} not implemented yet.`,"OK",{duration:3e3})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=P({type:o,selectors:[["app-order-list-page"]],decls:10,vars:5,consts:[[1,"page-content-wrapper"],[1,"page-title-bar"],[1,"page-title"],[1,"breadcrumbs"],[3,"filtersChanged"],["mat-flat-button","",1,"btn-corp-primary",3,"click"],[1,"orders-grid"],[3,"pageChanged","sortChanged","paymentTypeChanged","orders","isLoading","totalCount","pageSize","pageIndex"]],template:function(t,r){t&1&&(n(0,"div",0)(1,"div",1)(2,"h1",2),l(3,"Lista de cierre de caja"),i(),v(4,"div",3),i(),n(5,"app-order-filters",4),h("filtersChanged",function(d){return r.onFiltersChanged(d)}),i(),n(6,"button",5),h("click",function(){return r.exportDataToExcel()}),l(7," Exportar a Excel "),i(),n(8,"div",6)(9,"app-order-table",7),h("pageChanged",function(d){return r.onPageChanged(d)})("sortChanged",function(d){return r.onSortChanged(d)})("paymentTypeChanged",function(d){return r.handlePaymentTypeChanged(d)}),i()()()),t&2&&(c(9),p("orders",r.orders)("isLoading",r.isLoading)("totalCount",r.totalOrderCount)("pageSize",r.currentPageSize)("pageIndex",r.currentPageIndex))},dependencies:[E,st,Se,ke,ue,S,I,D,_e],styles:[".page-content-wrapper[_ngcontent-%COMP%]{padding:20px 24px;background-color:var(--sys-surface-container-lowest);color:var(--sys-on-surface);min-height:calc(100vh - 64px)}.page-title-bar[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}.page-title[_ngcontent-%COMP%]{font-size:24px;font-weight:600;color:var(--sys-on-surface);margin:0}.breadcrumbs[_ngcontent-%COMP%]{font-size:14px;color:var(--sys-on-surface-variant)}.breadcrumbs[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:var(--sys-primary);text-decoration:none}.breadcrumbs[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:hover{text-decoration:underline}.breadcrumbs[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{margin-left:5px}.table-controls-bar[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;background-color:var(--sys-surface-container-low);border-radius:8px;padding:8px 16px}.records-info[_ngcontent-%COMP%]{font-size:.9em;color:#555}.actions-group[_ngcontent-%COMP%]{display:flex;gap:8px;align-items:center}"]})};var $i=[{path:"",component:Re}];export{$i as ORDERS_ROUTES};
