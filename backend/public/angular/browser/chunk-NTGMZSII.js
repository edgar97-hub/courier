import{a as E}from"./chunk-XRPHOQB2.js";import{I as n,Jc as x,Kc as h,Lc as w,O as g,Yc as d,a as p,da as f,ia as v,j as b,na as O,t as u,u as a,x as m}from"./chunk-YUSEJVZ2.js";var k=class _{apiUrlOrders=d.apiUrl+"/orders";apiUrlDistricts=d.apiUrl+"/districts";apiUrlUsers=d.apiUrl+"/users";apiUrlSettings=d.apiUrl+"/settings";http=O(w);authService=O(E);constructor(){}getAuthHeaders(){let t=this.authService.getAccessToken();return t?new x({"Content-Type":"application/json",codrr_token:t}):new x({"Content-Type":"application/json"})}getOrders(t,e=1,s=10,r="id",o="desc"){let i=new h().set("page_number",e.toString()).set("page_size",s.toString()).set("sort_field",r).set("sort_direction",o);t&&(t.start_date&&(i=i.set("start_date",t.start_date)),t.end_date&&(i=i.set("end_date",t.end_date)),t.status&&(i=i.set("status",t.status)),t.search_term&&t.search_term.trim()!==""&&(i=i.set("search_term",t.search_term.trim())),t.myOrders&&(i=i.set("my_orders","true")));let l=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrlOrders,{params:i,headers:l}).pipe(m(c=>c),n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}getOrders2(t,e="id",s="desc"){let r=new h().set("sort_field",e).set("sort_direction",s);t&&(t.start_date&&(r=r.set("start_date",t.start_date)),t.end_date&&(r=r.set("end_date",t.end_date)),t.status&&(r=r.set("status",t.status)),t.search_term&&t.search_term.trim()!==""&&(r=r.set("search_term",t.search_term.trim())));let o=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(this.apiUrlOrders+"/filtered-orders",{params:r,headers:o}).pipe(m(i=>i.items),n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}getOrderStatuses(){return new b(t=>{t.next(["REGISTRADO","RECOGIDO","EN ALMACEN","EN TRANSITO","ENTREGADO","RECHAZADO EN PUNTO","REPROGRAMADO","ANULADO"]),t.complete()})}getDeliveryDistricts(){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlDistricts}/all`,{headers:t}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}updateOrderStatus(t,e,s,r,o,i){let l=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let c={orderId:t,reason:s,newStatus:e,action:"CAMBIO DE ESTADO"};return r&&(c.product_delivery_photo_url=r),o&&(c.payment_method_for_shipping_cost=o),i&&(c.payment_method_for_collection=i),this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:c},{headers:l}).pipe(n(this.handleError))}getMaxPackageDimensions(){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlSettings}/all`,{headers:t}).pipe(f(e=>console.log("OrderService: API response for max dimensions:",e)),m(e=>{if(console.log("apiResponse",e),e.length){let s="Est\xE1ndar : "+e[0].standard_measurements_length+"cmx"+e[0].standard_measurements_width+"cmx"+e[0].standard_measurements_height+"cm "+e[0].standard_measurements_weight+"kg",r="Las entregas en motorizado permiten paquetes de hasta "+e[0].maximum_measurements_length+" cm x "+e[0].maximum_measurements_width+" cm x  "+e[0].maximum_measurements_height+" cm y "+e[0].maximum_measurements_weight+" kg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van.";return{max_length_cm:e[0].maximum_measurements_length,max_width_cm:e[0].maximum_measurements_width,max_height_cm:e[0].maximum_measurements_height,max_weight_kg:e[0].maximum_measurements_weight,sta_length_cm:e[0].standard_measurements_length,sta_width_cm:e[0].standard_measurements_width,sta_height_cm:e[0].standard_measurements_height,sta_weight_kg:e[0].standard_measurements_weight,volumetric_factor:e[0].volumetric_factor,standard_package_info:s,info_text:r}}return{max_length_cm:0,max_width_cm:0,max_height_cm:0,max_weight_kg:0,sta_length_cm:0,sta_width_cm:0,sta_height_cm:0,sta_weight_kg:0,volumetric_factor:0,standard_package_info:"",info_text:""}}),n(e=>(console.error("OrderService: API error fetching max package dimensions. Details:",e.message),u({max_length_cm:30,max_width_cm:25,max_height_cm:45,max_weight_kg:5,standard_package_info:"Est\xE1ndar : 30cmx15cmx20cm 1.5kg",info_text:"Las entregas en motorizado permiten paquetes de hasta 25\u202Fcm x 30\u202Fcm x 45\u202Fcm y 5\u202Fkg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van."}).pipe(g(200))))):a(()=>new Error("Not authenticated to fetch users."))}getStandardPackageMeasurements(){let t=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.get(`${this.apiUrlSettings}/all`,{headers:t}).pipe(f(e=>console.log("OrderService: API response for max dimensions:",e)),m(e=>{if(console.log("apiResponse",e),e.length){let s="Est\xE1ndar : "+e[0].standard_measurements_length+"cmx"+e[0].standard_measurements_width+"cmx"+e[0].standard_measurements_height+"cm "+e[0].standard_measurements_weight+"kg",r="Las entregas en motorizado permiten paquetes de hasta "+e[0].maximum_measurements_length+" cm x "+e[0].maximum_measurements_width+" cm x  "+e[0].maximum_measurements_height+" cm y "+e[0].maximum_measurements_weight+" kg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van.";return{max_length_cm:e[0].maximum_measurements_length,max_width_cm:e[0].maximum_measurements_width,max_height_cm:e[0].maximum_measurements_height,max_weight_kg:e[0].maximum_measurements_weight,sta_length_cm:e[0].standard_measurements_length,sta_width_cm:e[0].standard_measurements_width,sta_height_cm:e[0].standard_measurements_height,sta_weight_kg:e[0].standard_measurements_weight,volumetric_factor:e[0].volumetric_factor,standard_package_info:s,info_text:r}}return{max_length_cm:0,max_width_cm:0,max_height_cm:0,max_weight_kg:0,sta_length_cm:0,sta_width_cm:0,sta_height_cm:0,sta_weight_kg:0,volumetric_factor:0,standard_package_info:"",info_text:""}}),n(e=>(console.error("OrderService: API error fetching max package dimensions. Details:",e.message),u({max_length_cm:30,max_width_cm:25,max_height_cm:45,max_weight_kg:5,standard_package_info:"Est\xE1ndar : 30cmx15cmx20cm 1.5kg",info_text:"Las entregas en motorizado permiten paquetes de hasta 25\u202Fcm x 30\u202Fcm x 45\u202Fcm y 5\u202Fkg. Si se exceden estas medidas o peso, se cobrar\xE1 una tarifa distinta porque la entrega ser\xE1 en una van."}).pipe(g(200))))):a(()=>new Error("Not authenticated to fetch users."))}calculateShippingCost(t){console.log("packageData",t),console.log("OrderService: Calculating shipping cost (simulated) for",t);let e=8;return t.package_size_type==="custom"&&(e=10,(t.package_weight_kg||0)>2&&(e+=5),((t.package_length_cm||0)>30||(t.package_width_cm||0)>25||(t.package_height_cm||0)>20)&&(e+=4)),t.delivery_district_id==="D003"&&(e+=2),u({shipping_cost:e}).pipe(g(500))}createBatchOrders(t){let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrlOrders}/batch-create`,t,{headers:e}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}importOrdersFromParsedJson(t){console.log("OrderService: Sending parsed JSON to backend for import",t);let e=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.post(`${this.apiUrlOrders}/import-batch-json`,t,{headers:e}).pipe(n(this.handleImportError)):a(()=>new Error("Not authenticated to fetch users."))}getAvailableDrivers(t){let e=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let s=new h().set("search_term",t).set("role","MOTORIZADO");return this.http.get(`${this.apiUrlUsers}/filtered`,{params:s,headers:e}).pipe(n(this.handleError))}getCompanies(t){let e=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let s=new h().set("search_term",t).set("role","EMPRESA");return this.http.get(`${this.apiUrlUsers}/filtered`,{params:s,headers:e}).pipe(n(this.handleError))}getDistricts(t){let e=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let s=new h().set("search_term",t);return this.http.get(`${this.apiUrlDistricts}/filtered`,{params:s,headers:e}).pipe(n(this.handleError))}assignDriverToOrder(t,e){let s=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/assign-driver-to-order/`+t,{motorizedId:e},{headers:s}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}rescheduleOrder(t,e,s){let r=this.getAuthHeaders();return this.authService.getAccessToken()?this.http.put(`${this.apiUrlOrders}/reschedule-order/`+t,{newDate:e,reason:s},{headers:r}).pipe(n(this.handleError)):a(()=>new Error("Not authenticated to fetch users."))}updateOrderAmountToCollect(t,e,s){let r=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let o={orderId:t,newValue:e,notes:s,action:"MODIFICACI\xD3N DEL MONTO A COBRAR"};return this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:o},{headers:r}).pipe(n(this.handleError))}updateOrderShippingCost(t,e,s){let r=this.getAuthHeaders();if(!this.authService.getAccessToken())return a(()=>new Error("Not authenticated to fetch users."));let o={orderId:t,newValue:e,notes:s,action:"MODIFICACI\xD3N DEL COSTO DE ENV\xCDO"};return this.http.post(`${this.apiUrlOrders}/update-order-status`,{payload:o},{headers:r}).pipe(n(this.handleError))}handleImportError(t){console.error("API Import Error:",t);let e={success:!1,message:"Error de comunicaci\xF3n con el servidor durante la importaci\xF3n.",errors:[{row:0,message:`Error: ${t.status} - ${t.statusText||"Error desconocido"}`}]};return t.error&&typeof t.error=="object"&&"message"in t.error&&(e=p(p({},e),t.error)),a(()=>e)}handleError(t){let e="An unknown error occurred!";return t.error instanceof ErrorEvent?e=`Error: ${t.error.message}`:(e=`Error Code: ${t.status}
Message: ${t.message||t.error?.message||"Server error"}`,t.status===0&&(e="Could not connect to the server. Please check your network or if the server is running.")),console.error("API Error in OrderService:",t),a(()=>new Error(e))}static \u0275fac=function(e){return new(e||_)};static \u0275prov=v({token:_,factory:_.\u0275fac,providedIn:"root"})};export{k as a};
